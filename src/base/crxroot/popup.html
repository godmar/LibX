<!DOCTYPE html>
<html>
<head>

<link rel="stylesheet" href="popup.css" type="text/css" media="screen">
<script src="jquery.js"></script>
<script src="accordion/menu.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="accordion/style.css" />

<script type="text/javascript">
libx = chrome.extension.getBackgroundPage().libx;

$(function() {
    
    libx.ui.jquery.autocomplete($, {
        field_id: "libxeditionsearch", 
        results_id: "results", 
        make_url: function (part) {
            return "http://libx.org/editions/search?q=" 
                + encodeURIComponent(part) + "&callback=?";
        },
        formatter: function (je) {
            return "<b>" 
                + je.shortDesc + "</b> (id: " + je.id + ") maintained by <i>" 
                + je.maintainers + "</i>";
        },
        select: function(selectedEdition) {
            $('#edition_details').show();

            // show edition name and maintainers
            $('#edition').text(selectedEdition.shortDesc);
            $('#maintainers').empty();
            $(selectedEdition.maintainers.split(",")).each(
                function(i, elem) {
                	$('#maintainers').append("<li>" + elem + "</li>");
                }
            );

            // highlight text after user makes selection
            $('#libxeditionsearch').select();

            var revisions = $('#revisions');
            revisions.empty();

            // reset load button if user already loaded an edition
            $('#load_edition').unbind('click');

            // get the revisions for this edition and populate search box 
            $.ajax({
                type: "GET",
                url: "http://libx.org/editions/config/" + selectedEdition.id,
                dataType: "json",
                success: function(json) {

                    // populate revision dropbox
                    for(var rev in json.revisions)
                        revisions.append($('<option>' + rev + '</option>'));

                    // select latest revision by default
                    revisions.children().last().attr('selected', true);
                    
                    $('#load_edition').click(function() { 
                        var configUrl = json.revisions[revisions.val()].config;
                        libx.localStorage.setItem('configUrl', configUrl);
                        libx.localStorage.removeItem('catalog');
                        console.log('Loading config from ' + configUrl);
                        try {
                            libx.loadConfig(configUrl);
                        } catch(e) {
                            showSearchBox();
                        }
                    });
                    
                }
            });
        }
    });

    function showView(viewId) {
        $('#edition_box > div').hide();
        $('#' + viewId).show();
    }

    function loadMethod(index) {
        selectedMethod = index;
        $('#method_label').text('Method: ' + libx.edition.searchoptions[index]);
    }

    function loadCatalog(index) {
        
        // change text for grouping label
        $('#cat_label').text('Catalog: ' + libx.edition.catalogs[index].name);

        // load search method links
        $('#search_options').empty();
        var options = libx.edition.catalogs[index].options.split(';');
        $(options).each(function(i, elem) {
            var li = $('<li><a href="javascript:void(0);">'
            	    + libx.edition.searchoptions[elem] + '</a></li>');
            li.click(function() {
                $('#search_options').slideToggle('normal');
                loadMethod(elem);
            });
            $('#search_options').append(li);
        });

        // save user's catalog selection
        libx.localStorage.setItem('catalog', index);
        
        // load first search option
        loadMethod(options[0]);
    }

    function showEditionChooser() {
        if(libx.localStorage.getItem('configUrl'))
            $('#cancel').show();
        else
            $('#cancel').hide();
        $('#libxeditionsearch').val('');
        $('#edition_details').hide();
        showView('view1');
    }
    
    function showSearchBox() {

        // show error if edition is not set
        if(!libx.edition) {
        	$('#edition_box > h1').text('');
            console.log('Error loading ' + libx.localStorage.getItem('configUrl')
                    + ': edition was not found or could not be loaded.');
            $('#view3_text').text('Could not load configuration from '
                    + libx.localStorage.getItem('configUrl') + '.');
            showView('view3');
            return;
        }
        
    	$('#edition_box > h1').text(libx.edition.name.edition);

        // populate catalogs from config file
        $('#catalogs').empty();
        $(libx.edition.catalogs).each(function(i, elem) {
            var li = $('<li><a href="javascript:void(0);">' + elem.name + '</a></li>');
            li.click(function() {

                // collapse group when making selection
                $('#catalogs').slideToggle('normal');

                // show catalog and load search options
                loadCatalog(i);
                
            });
        	$('#catalogs').append(li);
        });

        // automatically select saved catalog if it exists; select first catalog otherwise
        var catalog = libx.localStorage.getItem('catalog');
        if(catalog != null) {
            loadCatalog(catalog);
        } else {
            loadCatalog(0);
        }

        showView('view2');
        $('#search_text').focus();

    }
    
    // attach events to popup controls
    $('#cancel').click(function() { showSearchBox(); } );
    $('.change_edition').click(function() { showEditionChooser(); } );
    $('#search_form').submit(function() {
        chrome.tabs.create(
            {
                url: libx.edition.catalogs[libx.localStorage.getItem('catalog')].search([
                    { searchType: selectedMethod, searchTerms: $("#search_text").val() }
                ])
            }
        );
    });

    // automatically reload the page if edition changes
    libx.events.addListener("EditionConfigurationLoaded",
        {
            onEditionConfigurationLoaded: showSearchBox
        }, undefined, 'popup'
    );

    var selectedMethod = null;
    
    // show view depending on whether user already has edition loaded
    if(libx.localStorage.getItem('configUrl')) {
        showSearchBox();
    } else {
        showEditionChooser();
    }
    
});

</script>
</head>
<body>

<div id="edition_box">
    <h1></h1>
    <div id="view1">
        Select a LibX edition:
        <input type="text" id="libxeditionsearch" name="libxeditionsearch"></input>
        <div id="edition_details">
            <table>
                <tr>
                    <td>Edition:</td>
                    <td id="edition"></td>
                </tr>
                <tr>
                    <td>Maintainers:</td>
                    <td><ul id="maintainers"></ul></td>
                </tr>
                <tr>
                    <td>Revision:</td>
                    <td><select id="revisions"></select></td>
                </tr>
            </table>
            <a id="load_edition" href="javascript: void(0);">Load edition</a>
        </div>
        <a id="cancel" href="javascript: void(0);">Cancel</a>
    </div>
    <div id="view2">
        <form id="search_form">
            <div><input id="search_text" type="text"></input></div>
            <ul id="menu1" class="menu collapsible">
                <li>
                    <a id="cat_label" href="#"></a>
                    <ul id="catalogs"></ul>
                </li>
                <li>
                    <a href="#" id="method_label"></a>
                    <ul id="search_options"></ul>
                </li>
            </ul>
            <a class="change_edition" href="javascript: void(0);">Change edition</a>
            <input type="submit" value="Search"></input>
        </form>
    </div>
    <div id="view3">
        <div id="view3_text"></div>
        <a class="change_edition" href="javascript: void(0);">Change edition</a>
    </div>
</div>
</body>
</html>
