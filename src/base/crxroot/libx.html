<html>
<head>

<script src="core/global/shared/core.js"></script>
<script src="core/global/shared/libx.js"></script>
<script src="core/global/shared/log.js"></script>
<script src="core/global/shared/utils/binary.js"></script>
<script src="core/global/gc/storage.js"></script>
<script src="core/global/shared/preferences.js"></script>
<script src="core/global/shared/cache/memorycache.js"></script>
<script src="core/global/shared/config.js"></script>
<script src="core/global/shared/config/xmlconfigwrapper.js"></script>
<script src="core/global/shared/config/editionconfigurationreader.js"></script>
<script src="core/global/shared/events.js"></script>
<script src="core/global/shared/utils/json.js"></script> 
<script src="core/global/shared/catalog.js"></script>
<script src="core/global/shared/catalog/catalog.js"></script>
<script src="core/global/shared/catalog/preview.js"></script>
<script src="core/global/shared/catalog/factory/bookmarklet.js"></script>
<script src="core/global/shared/catalog/factory/scholar.js"></script>
<script src="core/global/shared/catalog/factory/millenium.js"></script>
<script src="core/global/shared/catalog/factory/horizon.js"></script>
<script src="core/global/shared/catalog/factory/voyager.js"></script>
<script src="core/global/shared/catalog/factory/aleph.js"></script>
<script src="core/global/shared/catalog/factory/sirsi.js"></script>
<script src="core/global/shared/catalog/factory/web2.js"></script>
<script src="core/global/shared/catalog/factory/centralsearch.js"></script>
<script src="core/global/shared/catalog/factory/custom.js"></script>
<script src="core/global/shared/catalog/factory/evergreen.js"></script>
<script src="core/global/shared/catalog/factory/worldcat.js"></script>
<script src="core/global/shared/catalog/factory/vubis.js"></script>
<script src="core/global/shared/catalog/factory/voyager7.js"></script>
<script src="core/global/shared/catalog/factory/talisprism.js"></script>
<script src="core/global/shared/catalog/factory/polaris.js"></script>
<script src="core/global/shared/catalog/factory/openurlresolver.js"></script>
<!-- <script src="core/global/shared/citeulike.js"></script> -->
<script src="core/global/shared/proxy.js"></script>
<script src="core/global/shared/proxy/factory/ezproxy.js"></script>
<script src="core/global/shared/proxy/factory/wam.js"></script>
<script src="core/global/shared/bootstrap.js"></script>
<script src="core/global/gc/log.js"></script>
<script src="core/global/gc/cache.js"></script>
<script src="core/global/gc/utils/timer.js"></script>
<script src="core/global/gc/utils/xml.js"></script>
<script src="core/global/gc/bootstrap.js"></script>
<script src="core/global/shared/cache/objectcache.js"></script>
<script src="core/global/shared/locale.js"></script>
<script src="core/global/shared/libapp.js"></script>
<script src="core/global/shared/cache/scheduler.js"></script>
<script src="core/global/gc/locale.js"></script>
<script src="core/global/gc/utils/browserprefs.js"></script>
<script src="core/global/gc/utils/hash.js"></script>
<script src="core/global/shared/openurl.js"></script>
<script src="core/global/shared/utils/stdnumsupport.js"></script>
<script src="core/global/gc/utils/xpath.js"></script>
<!-- <script src="core/global/shared/services/xisbn.js"></script> -->
<!-- <script src="core/global/shared/services/pubmed.js"></script> -->
<!-- <script src="core/global/shared/services/crossref.js"></script> -->
<script src="core/global/shared/ui/jquery/autocomplete.js"></script>
<script src="core/global/shared/ui/jquery/dropdown.js"></script>
<script src="core/global/shared/ui/jquery/accordionmenu.js"></script>
<script src="core/global/shared/ui/magicsearch.js"></script>
<script src="core/global/shared/utils/geteditionresource.js"></script>
<script src="core/global/shared/utils/geteditionpath.js"></script>
<script src="core/global/shared/ui.js"></script>
<script src="core/global/shared/ui/contextmenu.js"></script>
<script src="core/global/gc/ui.js"></script>
<script src="core/global/gc/extension.js"></script>
<script src="core/global/shared/backgroundlisteners.js"></script>

<script>

try {
    libx.initialize(false, true);
} catch (er) {
    console.log("Error in libx.initialize(): " + er);
}

// show edition icon after config is loaded
libx.events.addListener("EditionConfigurationLoaded", {
    onEditionConfigurationLoaded: function() {
        chrome.browserAction.setIcon( { path: libx.edition.options.icon } );
    }
    
});

var configUrl = libx.utils.browserprefs.getStringPref('libx.edition.configurl', null);
if (configUrl)
    // load config if user has one set
    libx.loadConfig(configUrl);

// load edition from cookie if it exists
var cookieData = {
    url: '$crxlocation$gc',
    name: 'libxedition'
};
chrome.cookies.get(cookieData, function (cookie) {
    var edition = cookie && cookie.value;
    if (!edition)
        return;
    chrome.cookies.remove(cookieData);

    var path = libx.utils.getEditionPath(edition);
    var configUrl = 'http:/libx.org/editions/' + path + '/config.xml';
    libx.utils.browserprefs.setStringPref('libx.edition.configurl', configUrl);
    libx.loadConfig(configUrl);
});
    
libx.extension.addListener("magicImport", function (request, sender, sendResponse) {
        
    function unserialize(obj) {
    
        if (typeof(obj) != "object" || obj == null)
            return obj;
            
        if (typeof(obj._function_index) != "undefined") {
            return function () {
                var args = [].slice.call(arguments);
                for (var i = 0; i < args.length; i++) {
                    // serialize XML documents
                    if (args[i] instanceof Object && args[i].xmlVersion) {
                        args[i] = {
                            _xml: libx.utils.xml.convertXMLDocumentToString(args[i])
                        };
                    }
                    // avoid sending circular structures
                    try {
                        libx.utils.json.stringify(args[i]);
                    } catch (e) {
                        args[i] = {};
                    }
                }
                chrome.tabs.sendRequest(sender.tab.id, {
                    type: "magicImportFunction",
                    index: obj._function_index,
                    args: args,
                    timestamp: obj.timestamp
                });
            };
        }
            
        var newObj = (obj instanceof Array) ? [] : {};
        for (var i in obj)
            newObj[i] = unserialize(obj[i]);
        
        return newObj;
    }
        
    var args = unserialize(request.requestObj);
    
    var obj = window;
    for (var i = 0; i < request.func.length-1; i++)
        obj = obj[request.func[i]];
    
    var prop = obj[request.func[request.func.length-1]];
    if (typeof(prop) == "function") {
        // avoid sending circular structures
        var result = prop.apply(obj, args);
        try {
            libx.utils.json.stringify(result);
        } catch (e) {
            result = {};
        }
        sendResponse({ result: result });
    } else {
        sendResponse({ result: prop });
    }
        
});
    
</script>

</head>
</html>
