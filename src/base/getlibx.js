!function(){"use strict";"bind"in Function.prototype||(Function.prototype.bind=function(owner){var that=this;if(arguments.length<=1)return function(){return that.apply(owner,arguments)};var args=Array.prototype.slice.call(arguments,1);return function(){return that.apply(owner,0===arguments.length?args:args.concat(Array.prototype.slice.call(arguments)))}}),"trim"in String.prototype||(String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(find,i){void 0===i&&(i=0),0>i&&(i+=this.length),0>i&&(i=0);for(var n=this.length;n>i;i++)if(i in this&&this[i]===find)return i;return-1}),"lastIndexOf"in Array.prototype||(Array.prototype.lastIndexOf=function(find,i){for(void 0===i&&(i=this.length-1),0>i&&(i+=this.length),i>this.length-1&&(i=this.length-1),i++;i-->0;)if(i in this&&this[i]===find)return i;return-1}),"forEach"in Array.prototype||(Array.prototype.forEach=function(action,that){for(var i=0,n=this.length;n>i;i++)i in this&&action.call(that,this[i],i,this)}),"map"in Array.prototype||(Array.prototype.map=function(mapper,that){for(var other=new Array(this.length),i=0,n=this.length;n>i;i++)i in this&&(other[i]=mapper.call(that,this[i],i,this));return other}),"filter"in Array.prototype||(Array.prototype.filter=function(filter,that){for(var v,other=[],i=0,n=this.length;n>i;i++)i in this&&filter.call(that,v=this[i],i,this)&&other.push(v);return other}),"every"in Array.prototype||(Array.prototype.every=function(tester,that){for(var i=0,n=this.length;n>i;i++)if(i in this&&!tester.call(that,this[i],i,this))return!1;return!0}),"some"in Array.prototype||(Array.prototype.some=function(tester,that){for(var i=0,n=this.length;n>i;i++)if(i in this&&tester.call(that,this[i],i,this))return!0;return!1})}(),libx={},libx.global=libx,libx.core=function(){var Class=function(){var __extending={};return{extend:function(parent,def){1==arguments.length&&(def=parent,parent=null);var func=function(){arguments[0]!=__extending&&"function"==typeof this.initialize&&this.initialize.apply(this,arguments)};"function"==typeof parent&&(func.prototype=new parent(__extending));var mixins=[];def&&def.include&&(def.include.reverse?mixins=mixins.concat(def.include.reverse()):mixins.push(def.include),delete def.include),def&&Class.inherit(func.prototype,def);for(var i=0;mixin=mixins[i];i++)Class.mixin(func.prototype,mixin);return func},mixin:function(dest,src,clobber){if(clobber=clobber||!1,"undefined"!=typeof src&&null!==src)for(var prop in src)(clobber||!dest[prop]&&"function"==typeof src[prop])&&(dest[prop]=src[prop]);return dest},inherit:function(dest,src,fname){if(3==arguments.length){var ancestor=dest[fname],descendent=src[fname],method=descendent;descendent=function(){var ref=this.parent;this.parent=ancestor;var result=method.apply(this,arguments);return ref?this.parent=ref:delete this.parent,result},descendent.valueOf=function(){return method},descendent.toString=function(){return method.toString()},dest[fname]=descendent}else for(var prop in src)dest[prop]&&"function"==typeof src[prop]?Class.inherit(dest,src,prop):dest[prop]=src[prop];return dest},singleton:function(){var args=arguments;if(2==args.length&&args[0].getInstance){var klass=args[0].getInstance(__extending);klass&&(args[0]=klass)}return function(args){var instance=!1,klass=Class.extend.apply(args.callee,args);return{getInstance:function(){return arguments[0]==__extending?klass:instance?instance:instance=new klass}}}(args)}}}();return Class.create=function(){return Class.extend.apply(this,arguments)},{Class:Class,EmptyFunction:function(){},TrueFunction:function(){return!0},FalseFunction:function(){return!1},AbstractFunction:function(fname){return function(){throw new Error("function "+fname+" not implemented")}}}}(),function(){libx.services={},libx.libapp={},libx.cache={},libx.ui={bd:{},jquery:{}},libx.utils={stdnumsupport:{},browserprefs:{},xml:{loadXMLDocumentFromString:libx.core.AbstractFunction("libx.utils.xml.loadXMLDocumentFromString"),convertXMLDocumentToString:libx.core.AbstractFunction("libx.utils.xml.convertXMLDocumentToString"),encodeEntities:function(s){s=String(s);for(var result="",i=0;i<s.length;i++){var c=s.charAt(i);result+={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[c]||c}return result},decodeEntities:function(s){for(var result="",i=0;i<s.length;i++){var c=s.charAt(i);result+={"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"'}[c]||c}return result}},xpath:{findSingleXML:libx.core.AbstractFunction("libx.utils.xpath.findSingleXML"),findNodesXML:libx.core.AbstractFunction("libx.utils.xpath.findNodesXML")},string:{trim:function(s){return s.replace(/^\s*/,"").replace(/\s*$/,"")}},types:{normalize:function(value){return"false"==value?!1:"true"==value?!0:""==value?null:String(value)},dumpObject:function(obj,prefix){prefix=prefix||"";for(var k in obj)prefix+=k+"="+obj[k]+" ("+typeof obj[k]+"), ";return prefix}},collections:{LinkedList:libx.core.Class.create({initialize:function(){this.head={prev:null},this.tail={next:null},this.head.next=this.tail,this.tail.prev=this.head},insert:function(before,node){node.prev=before.prev,node.next=before,before.prev.next=node,before.prev=node},remove:function(node){if(!("prev"in node))throw libx.log.backtrace("LinkedList.remove"),new Error("LinkedList.remove: node not in list: "+node);node.prev.next=node.next,node.next.prev=node.prev,delete node.prev,delete node.next},front:function(){return this.head.next},back:function(){return this.tail.prev},pushFront:function(node){this.insert(this.front(),node)},pushBack:function(node){this.insert(this.tail,node)},popFront:function(){var front=this.front();return this.remove(front),front},popBack:function(){var back=this.back();return this.remove(back),back},begin:function(){return this.front()},end:function(){return this.tail},rbegin:function(){return this.back()},rend:function(){return this.head},map:function(operator){for(var node=this.begin();node!=this.end();node=node.next)operator(node)},toString:function(){var s="[";return this.map(function(node){s+=node+", "}),s+"]"}}),unittests:function(out){out.write("Running unit tests for linked list\n");var ll=new libx.utils.collections.LinkedList,ObjectWrapper=new libx.core.Class.create({initialize:function(value){this.value=value},toString:function(){return""+this.value}});ll.pushFront(new ObjectWrapper("C")),ll.pushFront(new ObjectWrapper("B")),ll.pushFront(new ObjectWrapper("A")),out.write(ll+"\n"),ll.pushFront(ll.popBack()),out.write(ll+"\n"),ll.pushBack(ll.popFront()),out.write(ll+"\n");var b=ll.front().next;ll.remove(b),out.write(ll+"\n"),ll.pushFront(b),out.write(ll+"\n");for(var n=ll.rbegin();n!=ll.rend();n=n.prev)out.write(n+", ");out.write("\n")}},timer:{}},libx.utils.collections.ActivityQueue=libx.core.Class.create(libx.utils.collections.LinkedList,{prepareActivity:function(activity){activity._isReady=!1,activity._hasRun=!1;var queue=this;activity.markReady=function(){var myArgs=[].slice.call(arguments,0);queue.markActivityReady.apply(queue,[activity].concat(myArgs))},activity.scheduleBefore=function(beforeActivity){queue.prepareActivity(beforeActivity),queue.insert(activity,beforeActivity)}},scheduleFirst:function(activity){this.prepareActivity(activity),this.pushFront(activity)},scheduleLast:function(activity){this.prepareActivity(activity),this.pushBack(activity)},markActivityReady:function(activity){for(activity._isReady=!0,activity._readyArgs=[].slice.call(arguments,1);activity==this.front()&&activity._isReady;)activity._hasRun=!0,this.popFront(),activity.onready.apply(activity,activity._readyArgs),activity=this.front()}}),libx.utils.collections.DelayedActivityQueue=libx.core.Class.create(libx.utils.collections.ActivityQueue,{initialize:function(){this.parent(),this.scheduleLast(this)},onready:function(){}}),libx.utils.collections.EmptyActivity=libx.core.Class.create({onready:function(){}}),libx.utils.collections.FunctionActivity=libx.core.Class.create({initialize:function(fn){this.fn=fn},onready:function(){this.fn()}}),libx.buildDate="$builddate$",libx.version="$libxversion$";var localeQueue=new libx.utils.collections.ActivityQueue,localeLoaded=new libx.utils.collections.EmptyActivity;libx.initialize=function(primeCache){if(libx.initialize.reload=function(){delete libx.edition,delete libx.prefs,libx.preferences.initialize();var configUrl=libx.utils.browserprefs.getStringPref("libx.edition.configurl",null);configUrl&&libx.loadConfig(configUrl)},localeQueue.scheduleLast(localeLoaded),libx.events.addListener("DefaultLocaleLoaded",{onDefaultLocaleLoaded:function(){localeLoaded.markReady()}}),libx.locale.initialize(),libx.preferences.initialize(),primeCache){var dummyName="updates.json.local",found=!1;libx.cache.defaultObjectCache.get({url:dummyName,cacheOnly:!0,success:function(){found=!0},complete:function(){found||libx.cache.defaultObjectCache.get({url:libx.utils.getExtensionURL("bootstrapped/updates.json"),alias:dummyName,dataType:"json",success:function(updates){for(var file in updates.files)libx.cache.defaultObjectCache.get({url:libx.utils.getExtensionURL("bootstrapped/"+file),alias:libx.utils.getBootstrapURL(file),dataType:"text"})}})}})}},libx.loadConfig=function(configUrl){new libx.config.EditionConfigurationReader({url:configUrl,onload:function(edition){function chromeURL2DataURI(item){null!=libx.edition.options[item]&&libx.utils.getEditionResource({url:libx.edition.options[item],success:function(dataURI){libx.edition.options[item]=dataURI}})}libx.edition=edition,libx.log.write("Loaded configuration for edition: "+libx.edition.name["long"]),chromeURL2DataURI("icon"),chromeURL2DataURI("cueicon"),chromeURL2DataURI("logo");var loadScriptsAct={onready:function(){var edLoadedEvent=new libx.events.Event("EditionConfigurationLoaded");edLoadedEvent.edition=edition,edLoadedEvent.notify()}};localeQueue.scheduleLast(loadScriptsAct),loadScriptsAct.markReady()}})}}(),libx.version="2.0 (clientside)",libx.cs={proxy:function(sUrl){return"../core/global/cs/proxy.php?url="+encodeURIComponent(sUrl)}},libx.log={write:function(msg,prefix){if(prefix){var prefString="libx."+prefix.toLowerCase()+".debug";if(!libx.utils.browserprefs.getBoolPref("libx.all.debug",!1)&&!libx.utils.browserprefs.getBoolPref(prefString,!1))return}else prefix="LibX";libx.log.bd.write(prefix+": "+msg)},backtrace:function(msg){libx.log.bd.backtrace(msg)},bd:{write:libx.core.AbstractFunction("libx.log.bd.write"),backtrace:libx.core.AbstractFunction("libx.log.bd.write")}},libx.utils.binary=function(){function Base64(){}return Base64.encoding=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],Base64.encode=function(data){for(var num,result=[],ip57=Math.floor(data.length/57),fp57=data.length%57,ip3=Math.floor(fp57/3),fp3=fp57%3,index=0,i=0;ip57>i;i++)for(j=0;19>j;j++,index+=3)num=data[index]<<16|data[index+1]<<8|data[index+2],result.push(Base64.encoding[(16515072&num)>>18]),result.push(Base64.encoding[(258048&num)>>12]),result.push(Base64.encoding[(4032&num)>>6]),result.push(Base64.encoding[63&num]);for(i=0;ip3>i;i++,index+=3)num=data[index]<<16|data[index+1]<<8|data[index+2],result.push(Base64.encoding[(16515072&num)>>18]),result.push(Base64.encoding[(258048&num)>>12]),result.push(Base64.encoding[(4032&num)>>6]),result.push(Base64.encoding[63&num]);return 1==fp3?(num=data[index]<<16,result.push(Base64.encoding[(16515072&num)>>18]),result.push(Base64.encoding[(258048&num)>>12]),result.push("==")):2==fp3&&(num=data[index]<<16|data[index+1]<<8,result.push(Base64.encoding[(16515072&num)>>18]),result.push(Base64.encoding[(258048&num)>>12]),result.push(Base64.encoding[(4032&num)>>6]),result.push("=")),result.join("")},{binary2Base64:function(binary){var binArr=new Uint8Array(binary);return Base64.encode(binArr)}}}(),libx.storage={Store:libx.core.Class.create({initialize:function(prefix){this.prefix=prefix+"."},setItem:function(paramObj){localStorage.setItem(this.prefix+paramObj.key,paramObj.value),paramObj.success&&paramObj.success()},getItem:function(paramObj){var value=localStorage.getItem(this.prefix+paramObj.key);null==value?paramObj.notfound&&paramObj.notfound():paramObj.success&&paramObj.success(value)},find:function(paramObj){var matches=[],pattern=paramObj.pattern;pattern||(pattern=/.*/);for(var i in localStorage)if(0==i.indexOf(this.prefix)){var itemName=i.substr(this.prefix.length);pattern.test(itemName)&&matches.push(itemName)}paramObj.success&&paramObj.success(matches)},removeItem:function(paramObj){localStorage.removeItem(this.prefix+paramObj.key),paramObj.success&&paramObj.success()},clear:function(paramObj){for(var i in localStorage)0==i.indexOf(this.prefix)&&localStorage.removeItem(i);paramObj&&paramObj.success&&paramObj.success()}})},libx.storage.metacacheStore=new libx.storage.Store("metacache"),libx.storage.cacheStore=new libx.storage.Store("cache"),libx.storage.prefsStore=new libx.storage.Store("prefs"),libx.preferences=function(){function log(msg){libx.log.write(msg,"preferences")}function convert(value,type){var val;return val="int"==type?new Number(value):"boolean"==type?"true"==value||1==value?!0:!1:value}var ELEMENT_NODE=1,USER_PREFS="userprefs.xml",XMLPreferenceObject=libx.core.Class.create({initialize:function(descriptor){for(var k in descriptor)this[k]=descriptor[k]},_nodeType:null,_nodeToDescriptor:function(node){for(var descriptor={},i=0;i<node.attributes.length;i++){var attr=node.attributes.item(i);descriptor["_"+(attr.localName||attr.nodeName.replace("libx:",""))]=attr.value}return descriptor},toXML:function(){var sv=new SerializeVisitor;return sv.visit(this),sv.str}}),prefFactory=XMLPreferenceObject.factory={};prefFactory.category=libx.core.Class.create(XMLPreferenceObject,{_nodeType:"category",initialize:function(descriptor,parentName,node){if(this._children=new Array,null==descriptor&&null!=node&&(descriptor=this._nodeToDescriptor(node)),this.parent(descriptor),this._idstr=null!=parentName?parentName+"."+this._name:this._name,this._id=libx.utils.hash.hashString(this._idstr),null!=node)for(var i=0;i<node.childNodes.length;i++){var childNode=node.childNodes.item(i);childNode.nodeType==ELEMENT_NODE&&this._addChild(null,childNode.localName||childNode.nodeName.replace("libx:",""),childNode)}},_addPreference:function(descriptor){return this._addChild(descriptor,"preference")},_addCategory:function(descriptor){return this._addChild(descriptor,"category")},_addChild:function(descriptor,type,node){if(null==type&&(type=descriptor._nodeType),descriptor&&null!=this[descriptor._name])return this[descriptor._name];var child=new prefFactory[type](descriptor,this._idstr,node);return this[child._name]=child,this._children.push(child),child}}),prefFactory.preference=libx.core.Class.create(XMLPreferenceObject,{_nodeType:"preference",initialize:function(descriptor,parentName,node){if(null==descriptor&&null!=node&&(descriptor=this._nodeToDescriptor(node)),this.parent(descriptor),this._idstr=parentName+"."+this._name,this._id=libx.utils.hash.hashString(this._idstr),"choice"==this._type?this._items=new Array:"multichoice"==this._type?(this._value=new Array,this._items=new Array):this._value=convert(descriptor._value,this._type),null!=node)for(var i=0;i<node.childNodes.length;i++){var childNode=node.childNodes.item(i);childNode.nodeType==ELEMENT_NODE&&this._addItem(this._nodeToDescriptor(childNode))}},_setValue:function(value){var valid=!1;if("choice"==this._type){for(var items=this._items,i=0;i<items.length;i++)value==items[i]._value&&(items[i]._selected=!0,this._value=value,valid=!0);if(valid){for(var i=0;i<items.length;i++)value!=items[i]._value&&(items[i]._selected=!1);return!0}return log("Invalid value for choice preference: "+this._name+" = "+value),!1}if("multichoice"==this._type){for(var items=this._items,i=0;i<value.length;i++){for(var valueValid=!1,j=0;j<items.length;j++)value[i]==items[j]&&(valueValid=!0);if(0==valueValid)return log("Invalid value for multichoice preference: "+this._name+" = "+value[i]),!1}for(var i=0;i<items.length;i++)items[i]._selected=!1;for(var i=0;i<value.length;i++)for(var j=0;j<items.length;j++)value[i]==items[j]&&(items[j]._selected=!0);return this._value=value,!0}return typeof value==typeof this._value?(this._value=value,!0):(log("Invalid value for preference: Expected "+typeof this._value+" but recieved "+typeof value),!1)},_addItem:function(descriptor){var item=new prefFactory.item(descriptor,this._idstr);"choice"==this._type?(this._items.push(item),item._selected&&(null!=this._value&&(log("Error: Multiple selected items found for preference: "+this._name),item._selected=!1),this._value=item._value)):"multichoice"==this._type?(this._items.push(item),item._selected&&this._value.push(item._value)):log("Error: An attempt was made to add an item to a "+this._type+" preference.")},_removeItem:function(value){for(var i=0;i<this._items.length;i++){var item=this._items[i];if(item._value==value){if("choice"==this._type&&!item._selected)return this._items.splice(i,1),!0;if("multichoice"==this._type){this._items.splice(i,1);for(var j=0;item._selected&&j<this._value.length;j++)if(this._value[j]==value){this._value.splice(j,1);break}return!0}}}return!1},toString:function(){return this._value}}),prefFactory.item=libx.core.Class.create(XMLPreferenceObject,{_value:null,_type:null,_selected:null,_nodeType:"item",initialize:function(descriptor,parentName,node){null==descriptor&&null!=node&&log("ERROR: Item constructor called with a non-null node ( It shouldn't do that )"),this.parent(descriptor),null==this._type&&this._type==typeof this._value,this._value=convert(this._value,this._type),this._idstr=parentName+"."+this._value,this._id=libx.utils.hash.hashString(this._idstr),this._selected=convert(this._selected,"boolean")},toString:function(){return this._value}});var DefaultVisitor=libx.core.Class.create({visit:function(obj){this[obj._nodeType](obj)},category:function(cat){for(var i=0;cat._children&&i<cat._children.length;i++){var child=cat._children[i];this[child._nodeType](child)}},item:function(){},preference:function(pref){for(var i=0;pref._items&&i<pref._items.length;i++){var item=pref._items[i];this[item._nodeType](item)}}}),SerializeVisitor=libx.core.Class.create(DefaultVisitor,{str:'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE category SYSTEM "http://libx.org/xml/libxprefs.dtd">\n',category:function(cat){this.str+='<category name="'+libx.utils.xml.encodeEntities(cat._name)+'" layout="'+libx.utils.xml.encodeEntities(cat._layout)+'">\n',this.parent(cat),this.str+="</category>\n"},item:function(item){this.str+='<item type="'+libx.utils.xml.encodeEntities(item._type)+'" value="'+libx.utils.xml.encodeEntities(item._value)+'" ',item._selected&&(this.str+='selected="'+libx.utils.xml.encodeEntities(item._selected)+'"'),this.str+="/>\n"},preference:function(pref){this.str+='<preference name="'+libx.utils.xml.encodeEntities(pref._name)+'" type="'+libx.utils.xml.encodeEntities(pref._type)+'" ',"choice"!=pref._type&&(this.str+='value="'+libx.utils.xml.encodeEntities(pref._value)+'"'),this.str+=" >\n",this.parent(pref),this.str+="</preference>\n"}}),SearchVisitor=libx.core.Class.create(DefaultVisitor,{initialize:function(matchf){this.matchf=matchf,this.matches=new Array},category:function(cat){this.matchf(cat)&&this.matches.push(cat),this.parent(cat)},item:function(item){this.matchf(item)&&this.matches.push(item)},preference:function(pref){this.matchf(pref)&&this.matches.push(pref),this.parent(pref)}});return{initialize:function(){libx.prefs=new prefFactory.category({_name:"prefs"},"libx"),libx.prefs._addCategory({_name:"contextmenu",_layout:"tree"}),libx.prefs.getCategoryForUrl=function(url,templates){var cat=this[url];if(null==cat&&(cat=this._addCategory({_name:url,_layout:"group"})),void 0!==templates){for(var changed=!1,i=0;i<templates.length;i++){var template=templates[i];if(!(template.name in cat)){changed=!0;var descriptor={_type:template.type,_name:template.name};"value"in template&&(descriptor._value=template.value);var pref=cat._addPreference(descriptor);if("choice"==template.type&&"options"in template)for(var j=0;j<template.options.length;j++){var option=template.options[j];pref._addItem({_type:"string",_value:option.value,_selected:1==option.selected})}}}changed&&libx.preferences.save()}return cat};var loadedQueue=new libx.utils.collections.ActivityQueue,browserPrefsAct=new libx.utils.collections.EmptyActivity;loadedQueue.scheduleLast(browserPrefsAct);var userPrefsAct=new libx.utils.collections.EmptyActivity;loadedQueue.scheduleLast(userPrefsAct);var doneAct={onready:function(){var evt=new libx.events.Event("PreferencesLoaded");evt.notify()}};loadedQueue.scheduleLast(doneAct),doneAct.markReady(),libx.preferences.load({filename:libx.utils.getExtensionURL("preferences/browser.prefs.xml"),overwrite:!1,base:"libx.prefs",callback:function(){browserPrefsAct.markReady()}}),this.loadUserPrefs(function(){userPrefsAct.markReady()})},loadUserPrefs:function(callback){var self=this;libx.storage.prefsStore.getItem({key:USER_PREFS,success:function(text){var userPrefsDoc=libx.utils.xml.loadXMLDocumentFromString(text).documentElement;self.loadXML(userPrefsDoc,{filename:USER_PREFS,overwrite:!0,base:"libx"}),callback&&callback()},notfound:function(){callback&&callback()}})},load:function(descriptor){var filename=descriptor.filename,overwrite=descriptor.overwrite,base=descriptor.base;log("loading: "+filename+" overwrite="+overwrite+" and base="+base);var callbackFunct=this.loadXML;libx.cache.defaultObjectCache.get({validator:libx.cache.validators.preference,type:"GET",url:filename,dataType:"xml",success:function(xml){callbackFunct(xml.documentElement,descriptor)},error:function(status){libx.log.write("libx.preferences.load(): error "+status+" loading preference file "+filename)},complete:function(){descriptor.callback&&descriptor.callback()}})},loadXML:function(xmlNode,descriptor){function mergeHelper(curPrefs,newPrefs,overwrite){if(null==curPrefs)return void libx.prefs._addChild(newPrefs);if(curPrefs._nodeType!=newPrefs._nodeType&&log("XMLPreferences.loadUser.loadUserHelper","Mismatching node types detected. ["+curPrefs._nodeType+", "+newPrefs._nodeType+"]"),"category"==curPrefs._nodeType){for(var i=0;i<curPrefs._children.length;i++)for(var curPrefsChild=curPrefs._children[i],j=0;j<newPrefs._children.length;j++){var newPrefsChild=newPrefs._children[j];curPrefsChild._id==newPrefsChild._id&&mergeHelper(curPrefsChild,newPrefsChild,overwrite)}for(var i=0;i<newPrefs._children.length;i++){for(var newPrefsChild=newPrefs._children[i],found=!1,j=0;j<curPrefs._children.length;j++){var curPrefsChild=curPrefs._children[j];curPrefsChild._id==newPrefsChild._id&&(found=!0)}0==found&&(curPrefs._children.push(newPrefsChild),curPrefs[newPrefsChild._name]=newPrefsChild)}}else if("preference"==curPrefs._nodeType){if(overwrite&&(curPrefs._value=newPrefs._value,curPrefs._type=newPrefs._type),curPrefs._items&&curPrefs._items.length>0)for(var i=0;i<curPrefs._items.length;i++)for(var curPrefsItem=curPrefs._items[i],j=0;j<newPrefs._items.length;j++){var newPrefsItem=newPrefs._items[j];curPrefsItem._id==newPrefsItem._id&&mergeHelper(curPrefsItem,newPrefsItem,overwrite)}if(newPrefs._items&&newPrefs._items.length>0){curPrefs._items||(curPrefs._items=[]);for(var i=0;i<newPrefs._items.length;i++){for(var newPrefsItem=newPrefs._items[i],found=!1,j=0;j<curPrefs._items.length;j++){var curPrefsItem=curPrefs._items[j];curPrefsItem._id==newPrefsItem._id&&(found=!0)}0==found&&curPrefs._items.push(newPrefsItem)}}}else"item"==curPrefs._nodeType?overwrite&&(curPrefs._selected=newPrefs._selected):log("XMLPreferences.loadUser.loadUserHelper","Invalid node type - "+curPrefs._nodeType)}var overwrite=descriptor.overwrite,base=descriptor.base,loadedPrefs=new(prefFactory[xmlNode.localName||xmlNode.nodeName.replace("libx:","")])(null,base,xmlNode);null==descriptor.prefs&&(descriptor.prefs=loadedPrefs);var currentRoot=libx.preferences.get(loadedPrefs._idstr);if(null!=currentRoot)mergeHelper(currentRoot,loadedPrefs,overwrite);else{null==base&&(base="libx.prefs");var baseCategory=libx.preferences.get(base);(null==baseCategory||"category"!=baseCategory._nodeType)&&log("loadXML","Invalid base category specified: "+base),null==baseCategory[loadedPrefs._name]?(baseCategory[loadedPrefs._name]=loadedPrefs,baseCategory._children.push(loadedPrefs)):mergeHelper(baseCategory,loadedPrefs,overwrite)}},save:function(){var sv=new SerializeVisitor;sv.visit(libx.prefs),libx.storage.prefsStore.setItem({key:USER_PREFS,value:sv.str})},get:function(name){if("libx.prefs"==name)return libx.prefs;var pref=this.getByID(libx.utils.hash.hashString(name));return pref},getValue:function(name,defValue){var pref=this.get(name);return null!=pref&&"preference"==pref._nodeType?pref._value:(null!=pref&&"preference"!=pref._nodeType&&log("getValue","Error: Attempt to retrieve preference "+name+" but recieved "+pref._nodeType),defValue)},getByID:function(id){if(id==libx.utils.hash.hashString("libx.prefs"))return libx.prefs;var searchVisitor=new SearchVisitor(function(pref){return id==pref._id});return searchVisitor.visit(libx.prefs),searchVisitor.matches.length>1&&log("getByID","More then one match found for id: "+id),searchVisitor.matches[0]},XMLPreferenceObject:XMLPreferenceObject}}(),libx.cache.MemoryCache=function(){function invokeCallbacks(params){var status=params.status;if(null==status&&(status=params.xmlHttpReq.status),200==status||params.result&&0==status)for(var i=0;i<params.requests.length;++i)"function"==typeof params.requests[i].success&&params.requests[i].success(params.result,status,params.xmlHttpReq,params.text);else for(var i=0;i<params.requests.length;++i)"function"==typeof params.requests[i].error&&params.requests[i].error(params.result,status,params.xmlHttpReq,params.text);for(var i=0;i<params.requests.length;++i)"function"==typeof params.requests[i].complete&&params.requests[i].complete(params.result,status,params.xmlHttpReq,params.text)}var memoryCacheClass=libx.core.Class.create({initialize:function(cacheCapacity){null==cacheCapacity&&(cacheCapacity=50),this.xhrCache=new InternalCache(cacheCapacity)},flush:function(){this.xhrCache.flush()},buildKeyString:function(request){var toReturn="";if(toReturn+=request.url,void 0!==request.header)for(var headerName in request.header)"If-Modified-Since"!=headerName&&(toReturn+=","+headerName+"="+request.header[headerName]);return void 0!==request.serverMIMEType&&(toReturn+=",MIMEType="+request.serverMIMEType),toReturn},validateParameter:function(paramObj){var defaults={type:"GET",async:!0,data:null,bypassCache:!1};for(var property in defaults)void 0===paramObj[property]&&(paramObj[property]=defaults[property]);if("GET"!=paramObj.type&&"POST"!=paramObj.type)throw"In MemoryCache: Invalid request type: "+paramObj.type},removeFromCache:function(request){this.validateParameter(request);var key=this.buildKeyString(request),cachedNode=this.xhrCache.findNode(key);void 0!==cachedNode&&this.xhrCache.removeFromCache(cachedNode)},get:function(request){var self=this;this.validateParameter(request);var key=this.buildKeyString(request),result="",cachedNode=this.xhrCache.findNode(key);if(request.bypassCache||void 0===cachedNode){var xmlHttpReq=libx.cache.bd.getXMLHttpReqObj();try{xmlHttpReq.open(request.type,request.url,request.async)}catch(er){return libx.log.write("error in XMLHTTPRequest.open for: "+request.type+" "+request.url+"\n"+er),"function"==typeof request.error&&request.error(er.toString(),xmlHttpReq.status,xmlHttpReq),xmlHttpReq}var cache=this.xhrCache,isImage=/\.(jpg|jpeg|tiff|gif|ico|bmp|png|webp)$/i.test(request.url);void 0!==request.serverMIMEType?xmlHttpReq.overrideMimeType&&xmlHttpReq.overrideMimeType(request.serverMIMEType):isImage?xmlHttpReq.responseType="arraybuffer":"text"==request.dataType&&xmlHttpReq.overrideMimeType&&xmlHttpReq.overrideMimeType("text/plain");var onreadystatechange=function(){function saveAndInvokeCallbacks(){cachedNode=cache.findNode(key),200==xmlHttpReq.status||result&&0==xmlHttpReq.status?cachedNode&&(cachedNode.data.xhr=xmlHttpReq,cachedNode.result=result,cachedNode.text=text):cachedNode&&!request.bypassCache&&cache.removeFromCache(cachedNode),invokeCallbacks({xmlHttpReq:xmlHttpReq,requests:request.bypassCache?[request]:cachedNode.data.requests,result:result,text:text})}if(4==xmlHttpReq.readyState){var text,contentType=xmlHttpReq.getResponseHeader("Content-Type");if(isImage)text=libx.utils.binary.binary2Base64(xmlHttpReq.response),result="data:"+contentType+";base64,"+text;else if(text=xmlHttpReq.responseText,"xml"==request.dataType)result=xmlHttpReq.responseXML;else if("text"==request.dataType)result=xmlHttpReq.responseText;else if("json"==request.dataType)try{result=libx.utils.json.parse(xmlHttpReq.responseText)}catch(e){result=null}else result=xmlHttpReq.responseBody||xmlHttpReq.responseText;!/^chrome.*:\/\//.test(request.url)&&200==xmlHttpReq.status&&request.validator?request.validator.call(self,{url:request.url,data:result,text:text,mimeType:contentType,success:function(){saveAndInvokeCallbacks()},error:function(){invokeCallbacks({xmlHttpReq:xmlHttpReq,requests:[request],result:result,status:"failedvalidation",text:text})}}):saveAndInvokeCallbacks()}};if(request.header&&request.header["If-Modified-Since"]||xmlHttpReq.setRequestHeader("If-Modified-Since","0"),void 0!==request.header)for(headerName in request.header)xmlHttpReq.setRequestHeader(headerName,request.header[headerName]);request.bypassCache||cache.addToCache(key,xmlHttpReq,request),request.async&&(xmlHttpReq.onreadystatechange=onreadystatechange);try{xmlHttpReq.send(request.data)}catch(e){"function"==typeof request.error&&request.error(e.toString(),xmlHttpReq.status,xmlHttpReq)}return request.async||onreadystatechange(),xmlHttpReq}var xhr=cachedNode.data.xhr;return 4==xhr.readyState?(invokeCallbacks({xmlHttpReq:xhr,requests:[request],result:cachedNode.result,text:cachedNode.text}),this.xhrCache.moveToFront(cachedNode)):this.xhrCache.addRequest(cachedNode,request),xhr}}),InternalCache=libx.core.Class.create({initialize:function(maxSize){this.maxSize=maxSize,this.cacheList=new libx.utils.collections.LinkedList,this.cacheTable={},this.cacheLength=0},removeFromCache:function(node){this.cacheList.remove(node),delete this.cacheTable[node.data.key],--this.cacheLength},addToCache:function(keyContents,xhr,request){var node=this.cacheTable[keyContents];if(void 0!==node)return node.data.requests.push(request),this.cacheList.remove(node),this.cacheList.pushFront(node),node;if(this.cacheLength>=this.maxSize)for(var node=this.cacheList.rbegin();node!==this.cacheList.rend();){if(4==node.data.xhr.readyState){this.removeFromCache(node);break}node=node.prev}var newNode={data:{xhr:xhr,key:keyContents,requests:[request]}};return this.cacheList.pushFront(newNode),this.cacheTable[keyContents]=newNode,++this.cacheLength,newNode},findNode:function(keyValue){return this.cacheTable[keyValue]},moveToFront:function(node){this.cacheList.remove(node),this.cacheList.pushFront(node)},addRequest:function(node,request){node.data.requests.push(request),this.moveToFront(node)},flush:function(){this.initialize(this.maxSize)}});return memoryCacheClass}(),libx.cache.bd={getXMLHttpReqObj:libx.core.AbstractFunction("libx.cache.bd.getXMLHttpReqObj")},libx.cache.defaultMemoryCache=new libx.cache.MemoryCache,libx.config={},libx.config.NameableItemArray={getByName:function(name){for(var i=0;i<this.length;i++)if(this[i].name==name)return this[i];return null}},libx.config.XMLConfigWrapper=libx.core.Class.create({initialize:function(xmlDocument){this.xml=xmlDocument},getNode:function(xpathExpr){return libx.utils.xpath.findSingleXML(this.xml,xpathExpr)},getAttr:function(xpath,attr){var n=this.getNode(xpath);return n?n.getAttribute(attr):null},copyAttributes:function(xnode,obj){for(var i=0;i<xnode.attributes.length;i++){var attr=xnode.attributes.item(i),opt=libx.utils.types.normalize(attr.value);
null!=opt&&(obj[attr.nodeName]=opt)}}}),libx.config.EditionConfigurationReader=libx.core.Class.create({initialize:function(invofcc){var editionConfigReader=this;libx.cache.defaultObjectCache.get({dataType:"xml",url:invofcc.url,validator:libx.cache.validators.config,success:function(xml){var doc=new libx.config.XMLConfigWrapper(xml),edition={};edition.openurl=editionConfigReader.loadResolvers(doc),edition.catalogs=editionConfigReader.loadCatalogs(doc,edition),edition.proxy=editionConfigReader.loadProxies(doc),edition.options=editionConfigReader.loadOptions(doc),edition.links=editionConfigReader.loadLinks(doc),edition.searchoptions=editionConfigReader.loadSearchOptions(doc),edition.localizationfeeds=editionConfigReader.loadLocalizationFeeds(doc),edition.name={},doc.copyAttributes(doc.getNode("/edition/name"),edition.name),doc.copyAttributes(doc.getNode("/edition"),edition),editionConfigReader.loadContextMenuPrefs("Google Scholar","magicsearch",edition.options.magicsearchincontextmenu?"magicsearch":""),invofcc.onload(edition)},error:function(status){libx.log.write("error "+status+" loading configuration file "+invofcc.url)}})},makeConfigurationItemArray:function(doc,xpathExpr,factory,getFactoryKey,postAddFunc){var items=new Array;libx.core.Class.mixin(items,libx.config.NameableItemArray);for(var xmlItems=libx.utils.xpath.findNodesXML(doc.xml,xpathExpr),i=0;i<xmlItems.length;i++){var node=xmlItems[i],item={};if(null!=factory){var factoryKey=getFactoryKey(node);if("function"!=typeof factory[factoryKey]){libx.log.write("Factory key "+factoryKey+" not supported.");continue}item=new factory[factoryKey],item.type=factoryKey}doc.copyAttributes(node,item),postAddFunc(node,item),items.push(item)}return items.primary=items[0],items},loadLocalizationFeeds:function(doc){var localizationfeeds={"package":[],bootglobal:[],bootwindow:[]};return this.makeConfigurationItemArray(doc,"/edition/localizationfeeds/*[@type != 'legacy']",null,libx.core.EmptyFunction,function(node,feedorwhitelist){switch(node.nodeName){case"whitelist":localizationfeeds.whitelist=feedorwhitelist;break;case"feed":localizationfeeds[feedorwhitelist.type].push(feedorwhitelist)}}),localizationfeeds["package"].length||localizationfeeds["package"].push({url:libx.config.EditionConfigurationReader.defaultpkgURL}),localizationfeeds},loadSearchOptions:function(doc){var searchoptions={Y:"Keyword",t:"Title",jt:"Journal Title",at:"Article Title",a:"Author",d:"Subject",m:"Genre",i:"ISBN/ISSN",c:"Call Number",j:"Dewey Call Number",doi:"DOI",pmid:"PubMed ID",xisbn:"xISBN",magicsearch:"Magic Search"};return this.makeConfigurationItemArray(doc,"/edition/searchoptions/*",null,libx.core.EmptyFunction,function(node,option){searchoptions[option.value]=option.label}),searchoptions},loadLinks:function(doc){return this.makeConfigurationItemArray(doc,"/edition/links/*",null,libx.core.EmptyFunction,libx.core.EmptyFunction)},loadOptions:function(doc){for(var opts={autolinkstyle:"1px dotted"},options=libx.utils.xpath.findNodesXML(doc.xml,"/edition/options/option"),i=0;i<options.length;i++)opts[options[i].getAttribute("key")]=libx.utils.types.normalize(options[i].getAttribute("value"));return opts},loadCatalogs:function(doc,edition){var self=this;return this.makeConfigurationItemArray(doc,"/edition/catalogs/*",libx.catalog.factory,function(node){return node.nodeName},function(node,cat){var xisbnNode=libx.utils.xpath.findSingleXML(doc.xml,"xisbn",node);if(xisbnNode){var xisbnCopy=new Object;for(var k in cat.xisbn)xisbnCopy[k]=cat.xisbn[k];cat.xisbn=xisbnCopy,doc.copyAttributes(xisbnNode,cat.xisbn),"bookmarklet"!=node.nodeName&&self.loadContextMenuPrefs(cat.name,"xisbn",cat.xisbn.includeincontextmenu?"xisbn":"")}cat.urlregexp=new RegExp(cat.urlregexp),"function"==typeof cat.__init&&cat.__init(edition),self.loadContextMenuPrefs(cat.name,cat.options,cat.contextmenuoptions),libx.log.write("registered "+cat.name+" (type="+node.nodeName+", options="+cat.options+")")})},loadResolvers:function(doc){var self=this;return this.makeConfigurationItemArray(doc,"/edition/openurl/*",libx.openurl.factory,function(node){return node.getAttribute("type")},function(node,resolver){var cmoptions=resolver.includeincontextmenu?"enabled":"";self.loadContextMenuPrefs(resolver.name,"enabled",cmoptions),libx.log.write("registered OpenURL resolver "+resolver.name+" (type="+node.getAttribute("type")+")")})},loadProxies:function(doc){var self=this;return this.makeConfigurationItemArray(doc,"/edition/proxy/*",libx.proxy.factory,function(node){return node.nodeName},function(node,proxy){var cmoptions=proxy.includeincontextmenu?"enabled":"";self.loadContextMenuPrefs(proxy.name,"enabled",cmoptions),proxy.type=node.nodeName})},loadContextMenuPrefs:function(name,options,cmoptions){var cat=libx.prefs.contextmenu._addCategory({_name:name,_layout:"tree"});options=options.split(";"),cmoptions=cmoptions?cmoptions.split(";"):[];for(var i=0;i<options.length;i++){for(var option=options[i],enabled=!1,j=0;j<cmoptions.length;j++)cmoptions[j]==option&&(enabled=!0);cat._addPreference({_name:option,_type:"boolean",_value:enabled})}}}),libx.config.EditionConfigurationReader.defaultpkgURL="$defaultpkgURL$",function(){var handlerMap={};libx.events={Event:libx.core.Class.create({initialize:function(eventName,eventWindow){this.eventName=eventName,this.eventWindow=eventWindow},notify:function(){for(var argsAsArray=[].splice.call(arguments,0),observers=handlerMap[this.eventName]||[],i=0;i<observers.length;i++)if(void 0==this.eventWindow||this.eventWindow==observers[i].window)try{observers[i].handler["on"+this.eventName].apply(observers[i].handler,[this].concat(argsAsArray))}catch(er){libx.log.write("Exception in event handler: "+er,"events")}}}),registerEventListener:function(eventName,observer,shouldFireRightAway,observerWindow,observerId){libx.events.addListener(eventName,observer,observerWindow,observerId);var event=shouldFireRightAway(eventName);null!=event&&observer["on"+eventName](event)},addListener:function(eventName,observer,observerWindow,observerId){var handlers=handlerMap[eventName];if(void 0==handlers&&(handlers=handlerMap[eventName]=[]),void 0!=observerId)for(var i=0;i<handlers.length;i++)if(handlers[i].id==observerId&&handlers[i].window==observerWindow){handlers.splice(i,1);break}handlerMap[eventName].push({handler:observer,window:observerWindow,id:observerId})},removeListener:function(eventName,observerWindow,observerId){if(eventName in handlerMap)for(var handlers=handlerMap[eventName],i=0;i<handlers.length;i++)observerId!=handlers[i].id&&void 0!=observerId||observerWindow!=handlers[i].window&&void 0!=observerWindow||handlers.splice(i,1)}}}();var JSON;if(JSON||(JSON={}),libx.utils.json=JSON,function(){"use strict";function f(n){return 10>n?"0"+n:n}function quote(string){return escapable.lastIndex=0,escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return"string"==typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,partial,mind=gap,value=holder[key];switch(value&&"object"==typeof value&&"function"==typeof value.toJSON&&(value=value.toJSON(key)),"function"==typeof rep&&(value=rep.call(holder,key,value)),typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value)return"null";if(gap+=indent,partial=[],"[object Array]"===Object.prototype.toString.apply(value)){for(length=value.length,i=0;length>i;i+=1)partial[i]=str(i,value)||"null";return v=0===partial.length?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]",gap=mind,v}if(rep&&"object"==typeof rep)for(length=rep.length,i=0;length>i;i+=1)"string"==typeof rep[i]&&(k=rep[i],v=str(k,value),v&&partial.push(quote(k)+(gap?": ":":")+v));else for(k in value)Object.prototype.hasOwnProperty.call(value,k)&&(v=str(k,value),v&&partial.push(quote(k)+(gap?": ":":")+v));return v=0===partial.length?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}",gap=mind,v}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(value,replacer,space){var i;if(gap="",indent="","number"==typeof space)for(i=0;space>i;i+=1)indent+=" ";else"string"==typeof space&&(indent=space);if(rep=replacer,replacer&&"function"!=typeof replacer&&("object"!=typeof replacer||"number"!=typeof replacer.length))throw new Error("JSON.stringify");return str("",{"":value})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(holder,key){var k,v,value=holder[key];if(value&&"object"==typeof value)for(k in value)Object.prototype.hasOwnProperty.call(value,k)&&(v=walk(value,k),void 0!==v?value[k]=v:delete value[k]);return reviver.call(holder,key,value)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),libx.cs.browser={},function(){var rwebkit=/(webkit)[ \/]([\w.]+)/,ropera=/(opera)(?:.*version)?[ \/]([\w.]+)/,rmsie=/(msie) ([\w.]+)/,rchrome=/(chrome)[ \/]([\w.]+)/,rmozilla=/(mozilla)(?:.*? rv:([\w.]+))?/,ua=window.navigator.userAgent.toLowerCase(),match=rchrome.exec(ua)||rwebkit.exec(ua)||ropera.exec(ua)||rmsie.exec(ua)||ua.indexOf("compatible")<0&&rmozilla.exec(ua)||[];match[1]&&(libx.cs.browser[match[1]]=!0,libx.cs.browser.version=match[2]||"0"),libx.cs.browser.webkit&&(libx.cs.browser.safari=!0)}(),libx.log.bd={write:function(msg){console.log(msg)},backtrace:function(){throw new Error("libx.log.bd.backtrace() is not supported")}},libx.cache.bd={getXMLHttpReqObj:function(){var xmlhttp=null;if(libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla)try{xmlhttp=new XMLHttpRequest}catch(err){libx.log.write("Unable to create XMLHttpRequest object"),xmlhttp=void 0}else if(libx.cs.browser.msie)try{window.XMLHttpRequest?xmlhttp=new XMLHttpRequest:window.ActiveXObject&&(xmlhttp=new ActiveXObject("Microsoft.XMLHTTP"))}catch(err){libx.log.write("Unbale to create XMLHttpRequest object for IE, "+err.message),xmlhttp=void 0}else libx.log.write("Error - Unknown Browser! Check for appropriate feature support for getXMLHttpReqObj"),xmlhttp=void 0;if(!xmlhttp&&window.createRequest)try{xmlhttp=window.createRequest()}catch(e){xmlhttp=!1}if(xmlhttp){var origOpen=xmlhttp.open;xmlhttp.open=function(sMethod,sUrl,bAsync,sUser,sPassword){var reqdomainMatch=sUrl.match(/:\/\/(.[^/]+)/);null==reqdomainMatch||reqdomainMatch[1]==document.domain?origOpen.apply(xmlhttp,[sMethod,sUrl,bAsync,sUser,sPassword]):origOpen.apply(xmlhttp,[sMethod,libx.cs.proxy(sUrl),bAsync,sUser,sPassword])}}else libx.log.write("Error: In libx.cache.bd.getXMLHttpReqObj xmlhttprequest is undefined.");return xmlhttp}},function(){libx.utils.timer.setInterval=function(callback,timeout){setInterval(callback,timeout)},libx.utils.timer.setTimeout=function(callback,timeout){setTimeout(callback,timeout)}}(),libx.utils.xml.loadXMLDocumentFromString=function(xmlstring){var xml,parser;try{libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla?(parser=new DOMParser,xml=parser.parseFromString(xmlstring,"text/xml")):libx.cs.browser.msie?(xml=new ActiveXObject("Msxml2.DOMDocument.3.0"),xml.setProperty("SelectionLanguage","XPath"),xml.async="false",xml.loadXML(xmlstring)):(libx.log.write("Error - Unknown Browser! Check for appropriate feature support for libx.utils.xml.loadXMLDocumentFromString"),xml=void 0)}catch(e){xml=void 0}if(xml){if(!xml.documentElement||xml.getElementsByTagName("parsererror").length){var errObj=xml.getElementsByTagName("parsererror").context.parseError;libx.log.write("Invalid XML [reason]: \n"+errObj.reason+"\n[srcText]: \n"+errObj.srcText+"\n[url]: \n"+errObj.url+"\n[xmlstring]: \n"+xmlstring)}}else libx.log.write("Invalid XML [reason:] xml is "+xml+" \n[xmlstring]:\n"+xmlstring);return xml},libx.utils.xml.convertXMLDocumentToString=function(xmlDoc){var xmlstring,serializer;try{libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla?(serializer=new XMLSerializer,xmlstring=serializer.serializeToString(xmlDoc)):libx.cs.browser.msie?xmlstring=xmlDoc.xml:(libx.log.write("Error - Unknown Browser! Check for appropriate feature support for libx.utils.xml.convertXMLDocumentToString"),xmlstring=void 0)}catch(e){xmlstring=void 0}return xmlstring||libx.log.write("Error converting xml to string"),xmlstring},function(){function getPref(prefName,defValue){var pref=store[prefix+prefName];return"undefined"!=typeof pref&&null!=pref?pref:defValue}function setPref(prefName,value){store[prefix+prefName]=value}var prefix="browserprefs.",store=localStorage;libx.core.Class.mixin(libx.utils.browserprefs,{setStore:function(newStore){store=newStore},getBoolPref:function(prefName,defValue){return"true"==getPref(prefName,defValue).toString()},getStringPref:function(prefName,defValue){return getPref(prefName,defValue)},getIntPref:function(prefName,defValue){return parseInt(getPref(prefName,defValue))},setBoolPref:function(prefName,value){setPref(prefName,Boolean(value))},setStringPref:function(prefName,value){setPref(prefName,String(value))},setIntPref:function(prefName,value){setPref(prefName,parseInt(value))}})}(),function(){function trimQuery(doTrim,url){if(doTrim){var idx=url.indexOf("?");url=-1==idx?url:url.substr(0,idx)}return url}function retrieveRequest(request,retrievalType){var headers={},self=this;retrievalType==RetrievalType.UPDATE&&request.metadata&&null!=request.metadata.lastModified&&(headers["If-Modified-Since"]=request.metadata.lastModified);var url=trimQuery(request.ignoreQuery,request.alias||request.url);libx.cache.defaultMemoryCache.get({header:headers,url:request.url,dataType:request.dataType,validator:request.validator,serverMIMEType:request.serverMIMEType,bypassCache:retrievalType==RetrievalType.UPDATE,error:function(data,status){RetrievalType.UPDATE&&304==status?(request.metadata.lastAccessed=Date.now(),request.metadata.expired=!1,self.putMetadata({url:url,metadata:request.metadata,success:function(){request.complete&&request.complete()}})):(request.error&&request.error(status),request.complete&&request.complete())},success:function(data,status,xhr,text){function writeToCache(success,complete){libx.storage.cacheStore.setItem({key:url,value:text,success:function(){self.putMetadata({url:url,metadata:metadata,success:function(){success&&success(data,metadata,xhr),complete&&complete()}})}})}var contentType=xhr.getResponseHeader("Content-Type"),metadata={lastAccessed:Date.now(),lastModified:xhr.getResponseHeader("Last-Modified"),mimeType:contentType,sha1:libx.utils.hash.hashString(text),expired:!1},isImage=/\.(jpg|jpeg|tiff|gif|ico|bmp|png|webp)$/i.test(request.url);isImage&&(data=text="data:"+contentType+";base64,"+text),request.delayWrite?(request.delayWrite(writeToCache),request.success&&request.success(data,metadata,xhr),request.complete&&request.complete()):writeToCache(request.success,request.complete)}})}var RetrievalType={GET:1,UPDATE:2};libx.cache.ObjectCache=libx.core.Class.create({initialize:function(){this.cachedRequests=new Array},get:function(request){var self=this,url=request.alias||request.url;return/^chrome.*:\/\//.test(url)?void libx.cache.defaultMemoryCache.get(request):void this.getMetadata({url:url,success:function(metadata){function getFromCache(){libx.storage.cacheStore.getItem({key:trimQuery(request.ignoreQuery,url),success:function(text){var data;switch(request.dataType){case"json":data=libx.utils.json.parse(text);break;case"xml":data=libx.utils.xml.loadXMLDocumentFromString(text);break;default:data=text}request.success&&request.success(data,metadata),request.complete&&request.complete()},notfound:function(){retrieveRequest.call(self,request,RetrievalType.GET)}})}if(metadata.expired&&!request.cacheOnly){var updated=!1;self.update({url:request.url,alias:request.alias,metadata:metadata,ignoreQuery:request.ignoreQuery,validator:request.validator,success:function(data,status,xhr){updated=!0,request.success&&request.success(data,status,xhr)},error:getFromCache,complete:function(){return updated?void(request.complete&&request.complete()):void getFromCache()}})}else getFromCache()},notfound:function(){request.cacheOnly?request.complete&&request.complete():retrieveRequest.call(self,request,RetrievalType.GET)}})},getMetadata:function(paramObj){var url=trimQuery(paramObj.ignoreQuery,paramObj.url);libx.storage.metacacheStore.getItem({key:url,success:function(text){paramObj.success&&paramObj.success(libx.utils.json.parse(text))},notfound:paramObj.notfound})},putMetadata:function(paramObj){var url=trimQuery(paramObj.ignoreQuery,paramObj.url);libx.storage.metacacheStore.setItem({key:url,value:libx.utils.json.stringify(paramObj.metadata),success:paramObj.success})},purgeAll:function(){libx.storage.cacheStore.clear()},update:function(request){retrieveRequest.call(this,request,RetrievalType.UPDATE)}}),libx.cache.defaultObjectCache=new libx.cache.ObjectCache}(),libx.locale=function(){return StringBundle=libx.core.Class.create({initialize:function(l10ns){this.l10ns=l10ns},hasProperty:function(name){return null!=this.getPropertyObject(name)},getPropertyObject:function(name){for(var propertyObj=null,i=0;i<this.l10ns.length;i++)if(propertyObj=this.l10ns[i][name])return propertyObj;return null},getProperty:function(name){var propertyObj=this.getPropertyObject(name);if(null==propertyObj)return libx.log.write("Property '"+name+"' not found"),"["+name+"]";var message=propertyObj.message;if(arguments.length>1){var args=arguments;message=message.replace(/\$([a-zA-Z0-9_]+)\$/g,function(str,match){var placeholder=propertyObj.placeholders[match];if(!placeholder)throw new Error("placeholder '"+match+"' not defined.");return placeholder.content.replace(/(.?)\$([0-9])/g,function(str,chr,match){if("$"==chr)return"$"+match;var result=args[parseInt(match)];return result?chr+result:""})})}return message}}),{StringBundle:StringBundle,bd:{},initialize:function(){libx.locale.bd.initialize()},getBundle:function(params){function addLocale(locale){for(var i=0;i<localesToFind.length;i++)if(localesToFind[i]==locale)return;localesToFind.push(locale)}function scheduleLocales(callback){for(var i=0;i<localesToFind.length;i++){var addBundleActivity={onready:function(json){json&&l10ns.push(json)}};queue.scheduleLast(addBundleActivity),callback(localesToFind[i],addBundleActivity)}var createBundleActivity={onready:function(){params.success(new StringBundle(l10ns))}};queue.scheduleLast(createBundleActivity),createBundleActivity.markReady()}function getLocale(entry){entry.defaultLocale&&addLocale(entry.defaultLocale),scheduleLocales(function(locale,activity){locale in entry.locales?activity.markReady(libx.utils.json.parse(entry.locales[locale])):activity.markReady()})}var localesToFind=[];addLocale(libx.locale.bd.currentLocale);libx.locale.bd.currentLocale.indexOf("_");params.defaultLocale&&addLocale(params.defaultLocale);var queue=new libx.utils.collections.ActivityQueue,l10ns=[];params.url?scheduleLocales(function(locale,activity){libx.cache.defaultObjectCache[libx.cs?"update":"get"]({validator:function(vParams){function validateMessages(){for(var i in vParams.data)if(!("message"in vParams.data[i]))return!1;return!0}/json/.test(vParams.mimeType)&&validateMessages()?vParams.success():vParams.error()},dataType:"json",url:params.url.replace(/\$locale\$/,locale),error:function(status){activity.markReady(),404!=status&&params.error&&params.error(status)},success:function(response){activity.markReady(response)}})}):params.object?scheduleLocales(function(locale,activity){locale in params.object?activity.markReady(params.object[locale]):activity.markReady()}):new libx.libapp.PackageWalker(params.feed).walk({onpackage:getLocale,onmodule:getLocale,onlibapp:getLocale})}}}(),function(){var strlocale;try{libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla?strlocale=window.navigator.language:libx.cs.browser.msie?strlocale=window.navigator.userLanguage:(libx.log.write("Error - Unknown Browser! Check for appropriate feature support for setting default locale string from windown.navigator object"),xml=void 0),strlocale=strlocale.split("-"),strlocale=strlocale[0].toLowerCase()+"_"+strlocale[1].toUpperCase()}catch(e){strlocale="en_US",libx.log.write("Error processing locale info: "+e)}libx.locale.bd.currentLocale=strlocale}(),libx.locale.bd.initialize=function(){libx.locale.getBundle({url:libx.cs.baseurl+"src/base/locale/en_US/messages.json",defaultLocale:"en_US",success:function(bundle){libx.locale.defaultStringBundle=bundle;var localeLoadedEvent=new libx.events.Event("DefaultLocaleLoaded");localeLoadedEvent.notify()},error:function(err){libx.log.write("Failed to get locale bundle in client side for "+this.url+" \nError: "+err)}})},function(){function getUserPackages(){var userPackages;try{userPackages=libx.utils.json.parse(libx.utils.browserprefs.getStringPref("libx.libapp.userpackages","[]"))}catch(e){userPackages=[],libx.utils.browserprefs.setStringPref("libx.libapp.userpackages","[]")}return userPackages}function setOverride(entry,callback){if(libx.prefs.getCategoryForUrl(entry.id,[{name:"_enabled",type:"boolean",value:"true"}]),libx.prefs[entry.id]._enabled._value){if(entry.override){var overridee=entry.override,overrider=entry.id;overridden[overridee]||(overridden[overridee]={}),overridden[overridee][overrider]=1}callback&&callback()}}var tmpPackages=[],overridden=null,allPackages=null,enabledPackages=null,packageSchedulers=[];libx.libapp.clearTempPackages=function(){tmpPackages=[]},libx.libapp.addTempPackage=function(permUrl,tempUrl){for(var i=0;i<tmpPackages.length;i++)if(tmpPackages[i].tempUrl==tempUrl)return;tmpPackages.push({permUrl:permUrl,tempUrl:tempUrl})},libx.libapp.getTempPackages=function(){return tmpPackages},libx.libapp.removeTempPackage=function(tempUrl){for(var i=0;i<tmpPackages.length;i++)if(tmpPackages[i].tempUrl==tempUrl)return tmpPackages.splice(i,1),!0;return!1},libx.libapp.removeUserPackage=function(pkg){var userPackages=getUserPackages(),idx=userPackages.indexOf(pkg);return 0>idx?!1:(userPackages.splice(idx,1),libx.utils.browserprefs.setStringPref("libx.libapp.userpackages",libx.utils.json.stringify(userPackages)),!0)},libx.libapp.addUserPackage=function(pkg){if(this.getPackages().indexOf(pkg)>=0)return!1;var userPackages=getUserPackages();return userPackages.push(pkg),libx.utils.browserprefs.setStringPref("libx.libapp.userpackages",libx.utils.json.stringify(userPackages)),!0},libx.libapp.getPackages=function(enabledOnly,optCallback){function Return(what){return void 0!==optCallback&&optCallback(what),what}if(null==libx.edition)return Return([]);if(!allPackages){allPackages=[],libx.edition.localizationfeeds["package"].forEach(function(pkg){allPackages.push(pkg.url)});var userPackages=getUserPackages();userPackages.forEach(function(pkg){allPackages.indexOf(pkg)<0&&allPackages.push(pkg)})}if(!enabledOnly)return Return(allPackages);if(!enabledPackages){enabledPackages=allPackages.filter(function(pkg){for(var i=0;i<tmpPackages.length;i++)if(tmpPackages[i].permUrl==pkg)return!1;return!libx.prefs[pkg]||libx.prefs[pkg]._enabled._value});for(var i=0;i<tmpPackages.length;i++)enabledPackages.push(tmpPackages[i].tempUrl)}return Return(enabledPackages)},libx.libapp.reloadPackages=function(){allPackages=null,enabledPackages=null,libx.libapp.clearOverridden();for(var scheduler;scheduler=packageSchedulers.pop();)scheduler.stopScheduling();this.getPackages(!0).forEach(function(pkg){var scheduler=new libx.cache.PackageScheduler(pkg);scheduler.scheduleUpdates(!0),packageSchedulers.push(scheduler)})},libx.libapp.clearOverridden=function(){overridden=null},libx.libapp.getOverridden=function(callback){function findOverrides(entries){entries.forEach(function(entry){var activity=new libx.utils.collections.EmptyActivity;overrideQueue.scheduleFirst(activity),new libx.libapp.PackageWalker(entry.url).walk({onpackage:function(pkg){setOverride(pkg,function(){findOverrides(pkg.entries)}),activity.markReady()},onlibapp:function(libapp){setOverride(libapp),activity.markReady()},error:function(){activity.markReady()}},null,activity)})}var overrideQueue=new libx.utils.collections.ActivityQueue;if(overridden)callback(overridden);else{overridden={};var enabled=this.getPackages(!0).map(function(pkg){return{url:pkg}});findOverrides(enabled),callbackAct={onready:function(){callback(overridden)}},overrideQueue.scheduleLast(callbackAct),callbackAct.markReady()}};var prereqQueue=new libx.utils.collections.DelayedActivityQueue;libx.events.addListener("PreferencesLoaded",{onPreferencesLoaded:function(){prereqQueue.markReady()}});var reloadLibapps={onready:function(){libx.libapp.reloadPackages()}};prereqQueue.scheduleLast(reloadLibapps),libx.events.addListener("EditionConfigurationLoaded",{onEditionConfigurationLoaded:function(){reloadLibapps.markReady()}})}(),libx.cache.validators={config:function(params){return/xml/.test(params.mimeType)?void(libx.utils.xpath.findSingleXML(params.data,"//edition/name")?params.success():(params.error(),libx.log.write("Validation error: edition name not found in config XML"))):(params.error(),void libx.log.write("Validation error: invalid MIME type for config XML: "+params.mimeType+" at "+params.url))},bootstrapped:function(params){var bootstrapPath=libx.utils.getBootstrapURL("");return 0!=params.url.indexOf(bootstrapPath)?void params.success():void this.get({url:libx.utils.getBootstrapURL("updates.json"),dataType:"json",success:function(updates){var relPath=params.url.replace(bootstrapPath,""),sha1=libx.utils.hash.hashString(params.text);updates.files&&updates.files[relPath]&&updates.files[relPath].hash==sha1?params.success():(params.error(),libx.log.write(updates.files&&updates.files[relPath]?"Validation error: SHA1 mismatch; updates.json expected: "+updates.files[relPath].hash+", actual: "+sha1:"Validation error: invalid updates.json"))},error:function(status){params.error(),libx.log.write("Error "+status+" when fetching updates.json")}})},feed:function(params){return/xml/.test(params.mimeType)?void(libx.utils.xpath.findSingleXML(params.data,"//libx:package|//libx:libapp|//libx:module",null,{libx:"http://libx.org/xml/libx2"})?params.success():(params.error(),libx.log.write("Validation error: no package, module, or libapp node found in feed"))):(params.error(),void libx.log.write("Validation error: invalid MIME type for atom feed: "+params.mimeType))},preference:function(params){return/xml/.test(params.mimeType)?void(libx.utils.xpath.findSingleXML(params.data,"//item|//preference|//category")?params.success():(params.error(),libx.log.write("Validation error: no item, preference, or category node found in XML"))):(params.error(),void libx.log.write("Validation error: invalid MIME type for pref XML: "+params.mimeType))},image:function(params){/image/.test(params.mimeType)?params.success():(params.error(),libx.log.write("Validation error: invalid MIME type for image: "+params.mimeType+" at "+params.url+" data"+params.data))}},libx.utils.getBootstrapURL=function(path){return"$bootstrapURL$"+path},libx.utils.getEditionResource=function(paramObj){var chromePrefix="chrome://libx/skin";if(paramObj.url.substr(0,chromePrefix.length)!=chromePrefix)return paramObj.success&&paramObj.success(paramObj.url),void(paramObj.complete&&paramObj.complete());var url=libx.utils.browserprefs.getStringPref("libx.edition.configurl","").replace("/config.xml","")+paramObj.url.replace(chromePrefix,"");libx.cache.defaultObjectCache.get({url:url,validator:libx.cache.validators.image,success:paramObj.success,error:paramObj.error,complete:paramObj.complete})},libx.utils.getEditionPath=function(editionId){return editionId[0]>="a"&&editionId[0]<="z"?editionId:editionId.substr(0,2)+"/"+editionId.substr(2,2)+"/"+editionId},libx.utils.getBootstrapURL=function(path){return libx.cs.baseurl+"src/base/bootstrapped/"+path},libx.utils.getExtensionURL=function(path){return libx.cs.baseurl+"src/base/"+path},libx.utils.browserType=function(){var _userAgent=window.navigator.userAgent.toLowerCase();return/firefox/.test(_userAgent)?"ff":/msie/.test(_userAgent)?"ie":/chrome/.test(_userAgent)?"gc":/safari/.test(_userAgent)?"sa":/opera/.test(_userAgent)?"op":"unknown"},function(){function getFeedPath(url){try{return url.match(/.*\//)[0]}catch(e){libx.log.write("scheduler: error getting feed path for "+url)}}function log(msg){libx.log.write(msg,"scheduler")}var defaultUpdateInterval=864e5,initialRetryInterval=6e4,maxRetryInterval=144e5,maxRandDelay=144e5,DISABLE_SCHEDULERS=!1;libx.cache.Scheduler=libx.core.Class.create({initialize:function(rootUrl){this.rootUrl=rootUrl,this.updateInterval=defaultUpdateInterval,this.initialRetryInterval=initialRetryInterval,this.maxRetryInterval=maxRetryInterval,this.maxRandDelay=maxRandDelay},objectCache:libx.cache.defaultObjectCache,rootDataType:"text",childDataType:"text",updateChildrenRule:"root",updateChildren:libx.core.AbstractFunction("libx.cache.Scheduler.updateChildren"),updatesFinished:libx.core.EmptyFunction,stopScheduling:function(){this.cancelUpdates=!0},rootValidator:null,childValidator:null,scheduleUpdates:function(force){function scheduleNextUpdate(timeout){libx.utils.timer.setTimeout(updateRoot,timeout),log("scheduling update in "+Math.round(timeout/1e3)+" seconds for "+self.rootUrl)}function updateRoot(){function checkForUpdates(url,shouldUpdate,callback){function update(metadata){var updated=!1,timeoutBlocker=null;self.objectCache.update({url:url,metadata:metadata,dataType:self.childDataType,validator:function(params){var validatorSelf=this,validatorAct={onready:function(){self.childValidator.call(validatorSelf,params)}};validatorQueue.scheduleLast(validatorAct),timeoutBlocker=new libx.utils.collections.EmptyActivity,validatorQueue.scheduleLast(timeoutBlocker),validatorAct.markReady()},success:function(){updated=!0,log(url+" updated")},error:function(status){updateError=!0,libx.log.write("scheduler: error status "+status+" updating "+url)},complete:function(){callback&&callback(updated),activity.markReady(),null!=timeoutBlocker&&libx.utils.timer.setTimeout(function(){timeoutBlocker.markReady()},0)}})}var activity=new libx.utils.collections.EmptyActivity;log("checking for updates to child "+url),updateQueue.scheduleFirst(activity),self.objectCache.getMetadata({url:url,success:function(metadata){shouldUpdate(metadata)?update(metadata):activity.markReady()},notfound:function(){update()}})}if(!self.cancelUpdates){log("checking for updates to root: "+self.rootUrl);var rootUpdated=!1,updateError=!1,updateQueue=new libx.utils.collections.ActivityQueue,validatorQueue=new libx.utils.collections.ActivityQueue,saveToCache=null,complete=function(metadata){self.objectCache.update({url:self.rootUrl,metadata:metadata,ignoreQuery:!0,dataType:self.rootDataType,validator:self.rootValidator,delayWrite:function(callback){saveToCache=callback
},success:function(data){rootUpdated=!0,log(self.rootUrl+" updated"),"root"==self.updateChildrenRule&&self.updateChildren(checkForUpdates,data)},error:function(status){libx.log.write("scheduler: error status "+status+" updating "+self.rootUrl),updateError=!0},complete:function(){"always"!=self.updateChildrenRule||updateError||self.updateChildren(checkForUpdates,null,updateQueue,function(){updateError=!0});var updatesFinished={onready:function(){function finishUpdates(){log("all updates completed successfully for "+self.rootUrl),self.updatesFinished(rootUpdated);var delay=Math.floor(self.maxRandDelay*Math.random());scheduleNextUpdate(self.updateInterval+delay)}if(updateError){var retry=2*self.currentRetryInterval||self.initialRetryInterval;return retry>self.maxRetryInterval&&(retry=self.maxRetryInterval),self.currentRetryInterval=retry,log("updates unsuccessful for "+self.rootUrl),void scheduleNextUpdate(retry)}self.currentRetryInterval=0,saveToCache?saveToCache(finishUpdates):finishUpdates()}};updateQueue.scheduleLast(updatesFinished),updatesFinished.markReady()}})};self.objectCache.getMetadata({url:self.rootUrl,ignoreQuery:!0,success:function(metadata){complete(metadata)},notfound:function(){complete()}})}}if(!DISABLE_SCHEDULERS){var self=this;self.objectCache.getMetadata({ignoreQuery:!0,url:self.rootUrl,success:function(metadata){var now=Date.now(),delay=Math.floor(self.maxRandDelay*Math.random()),expires=metadata.lastAccessed+self.updateInterval+delay;!force&&expires>now?scheduleNextUpdate(expires-now):(log(self.rootUrl+" expired; updating now"),updateRoot())},notfound:function(){log(self.rootUrl+" not found in cache; updating now"),updateRoot()}})}}}),libx.cache.HashScheduler=libx.core.Class.create(libx.cache.Scheduler,{rootDataType:"json",rootValidator:function(params){/json/.test(params.mimeType)&&params.data.files?params.success():params.error()},childValidator:libx.cache.validators.bootstrapped,updateChildren:function(checkForUpdates,updateHashes){for(var relUrl in updateHashes.files)!function(relUrl){var absUrl=libx.utils.getBootstrapURL(relUrl);checkForUpdates(absUrl,function(metadata){var hash=updateHashes.files[relUrl].hash;return metadata.sha1!=hash})}(relUrl)}}),libx.cache.ConfigScheduler=libx.core.Class.create(libx.cache.Scheduler,{rootDataType:"xml",rootValidator:libx.cache.validators.config,childValidator:function(params){params.success()},updateChildren:function(checkForUpdates,configDoc){var configPath=this.rootUrl.replace("/config.xml",""),xmlItems=libx.utils.xpath.findNodesXML(configDoc,"/edition/additionalfiles/*");xmlItems.forEach(function(node){var name=node.getAttribute("name");if("defaultprefs.xml"!=name){var url=configPath+"/"+name;checkForUpdates(url,libx.core.TrueFunction)}})},updatesFinished:function(updated){updated&&libx.loadConfig(this.rootUrl)}}),libx.cache.PackageScheduler=libx.core.Class.create(libx.cache.Scheduler,{initialize:function(rootUrl){this.fullRootUrl=rootUrl,this.parent(getFeedPath(rootUrl))},rootDataType:"xml",childDataType:"xml",rootValidator:libx.cache.validators.feed,childValidator:libx.cache.validators.feed,updateChildrenRule:"always",updateChildren:function(checkForUpdates,feedDoc,updateQueue,markError){function processEntries(entries){entries.forEach(function(entry){function walkChildren(){function onitem(item){processEntries(item.entries),walkerAct.markReady()}new libx.libapp.PackageWalker(entry.url).walk({onpackage:onitem,onlibapp:onitem,onmodule:onitem,error:function(){markError(),walkerAct.markReady()}})}var walkerAct=new libx.utils.collections.EmptyActivity;updateQueue.scheduleFirst(walkerAct);var entryPath=getFeedPath(entry.url),updateAct={onready:walkChildren};entryPath in visited?(visited[entryPath].scheduleLast(updateAct),updateAct.markReady()):(visited[entryPath]=new libx.utils.collections.ActivityQueue,visited[entryPath].scheduleLast(updateAct),checkForUpdates(entryPath,libx.core.TrueFunction,function(updated){updated&&libx.libapp.clearOverridden(),updateAct.markReady()}))})}var visited={};visited[this.rootUrl]=new libx.utils.collections.ActivityQueue,processEntries([{url:this.fullRootUrl}])}}),libx.cache.TemplateScheduler=libx.core.Class.create(libx.cache.Scheduler,{scheduleUpdates:function(){var self=this;if(!DISABLE_SCHEDULERS&&!this.cancelUpdates){log("checking for expired template files");var bootstrapBase=libx.utils.getBootstrapURL("");libx.storage.metacacheStore.find({pattern:new RegExp("^(?!"+bootstrapBase+").+\\.tmpl$"),success:function(templates){templates.forEach(function(template){self.objectCache.getMetadata({url:template,success:function(metadata){if(metadata.expired)return void log(template+" already marked as expired");var expires=metadata.lastAccessed+self.updateInterval;Date.now()>expires&&(log(template+" marked as expired"),metadata.expired=!0,self.objectCache.putMetadata({url:template,metadata:metadata}))}})})}}),libx.utils.timer.setTimeout(function(){self.scheduleUpdates.call(self)},self.updateInterval),log("scheduling expiration check in "+Math.round(self.updateInterval/1e3)+" seconds for template files")}}}),(new libx.cache.TemplateScheduler).scheduleUpdates(),libx.events.addListener("EditionConfigurationLoaded",{onEditionConfigurationLoaded:function(){libx.cache.defaultHashScheduler&&libx.cache.defaultHashScheduler.stopScheduling();var jsonUrl=libx.utils.getBootstrapURL("updates.json");jsonUrl+="?edition="+libx.edition.id+"&editionversion="+libx.edition.version+"&libxversion="+libx.version,libx.cache.defaultHashScheduler=new libx.cache.HashScheduler(jsonUrl),libx.cache.defaultHashScheduler.scheduleUpdates(),libx.cache.defaultConfigScheduler&&libx.cache.defaultConfigScheduler.stopScheduling();var configUrl=libx.utils.browserprefs.getStringPref("libx.edition.configurl");libx.cache.defaultConfigScheduler=new libx.cache.ConfigScheduler(configUrl),libx.cache.defaultConfigScheduler.scheduleUpdates()}})}(),libx.utils.hash=function(){function SHA1(msg){function rotate_left(n,s){var t4=n<<s|n>>>32-s;return t4}function cvt_hex(val){var i,v,str="";for(i=7;i>=0;i--)v=val>>>4*i&15,str+=v.toString(16);return str}function Utf8Encode(string){string=string.replace(/\r\n/g,"\n");for(var utftext="",n=0;n<string.length;n++){var c=string.charCodeAt(n);128>c?utftext+=String.fromCharCode(c):c>127&&2048>c?(utftext+=String.fromCharCode(c>>6|192),utftext+=String.fromCharCode(63&c|128)):(utftext+=String.fromCharCode(c>>12|224),utftext+=String.fromCharCode(c>>6&63|128),utftext+=String.fromCharCode(63&c|128))}return utftext}var blockstart,i,j,A,B,C,D,E,temp,W=new Array(80),H0=1732584193,H1=4023233417,H2=2562383102,H3=271733878,H4=3285377520;msg=Utf8Encode(msg);var msg_len=msg.length,word_array=new Array;for(i=0;msg_len-3>i;i+=4)j=msg.charCodeAt(i)<<24|msg.charCodeAt(i+1)<<16|msg.charCodeAt(i+2)<<8|msg.charCodeAt(i+3),word_array.push(j);switch(msg_len%4){case 0:i=2147483648;break;case 1:i=msg.charCodeAt(msg_len-1)<<24|8388608;break;case 2:i=msg.charCodeAt(msg_len-2)<<24|msg.charCodeAt(msg_len-1)<<16|32768;break;case 3:i=msg.charCodeAt(msg_len-3)<<24|msg.charCodeAt(msg_len-2)<<16|msg.charCodeAt(msg_len-1)<<8|128}for(word_array.push(i);word_array.length%16!=14;)word_array.push(0);for(word_array.push(msg_len>>>29),word_array.push(msg_len<<3&4294967295),blockstart=0;blockstart<word_array.length;blockstart+=16){for(i=0;16>i;i++)W[i]=word_array[blockstart+i];for(i=16;79>=i;i++)W[i]=rotate_left(W[i-3]^W[i-8]^W[i-14]^W[i-16],1);for(A=H0,B=H1,C=H2,D=H3,E=H4,i=0;19>=i;i++)temp=rotate_left(A,5)+(B&C|~B&D)+E+W[i]+1518500249&4294967295,E=D,D=C,C=rotate_left(B,30),B=A,A=temp;for(i=20;39>=i;i++)temp=rotate_left(A,5)+(B^C^D)+E+W[i]+1859775393&4294967295,E=D,D=C,C=rotate_left(B,30),B=A,A=temp;for(i=40;59>=i;i++)temp=rotate_left(A,5)+(B&C|B&D|C&D)+E+W[i]+2400959708&4294967295,E=D,D=C,C=rotate_left(B,30),B=A,A=temp;for(i=60;79>=i;i++)temp=rotate_left(A,5)+(B^C^D)+E+W[i]+3395469782&4294967295,E=D,D=C,C=rotate_left(B,30),B=A,A=temp;H0=H0+A&4294967295,H1=H1+B&4294967295,H2=H2+C&4294967295,H3=H3+D&4294967295,H4=H4+E&4294967295}var temp=cvt_hex(H0)+cvt_hex(H1)+cvt_hex(H2)+cvt_hex(H3)+cvt_hex(H4);return temp.toLowerCase()}return{hashString:function(text){return SHA1(text)}}}(),libx.catalog={factory:{}},libx.catalog.CatalogUtils={adjustISNSearchType:function(f){"i"==f.searchType&&!libx.utils.stdnumsupport.isISBN(f.searchTerms)&&libx.utils.stdnumsupport.isISSN(f.searchTerms)&&(f.searchType="is")}},libx.catalog.Catalog=libx.core.Class.create({include:[libx.catalog.CatalogUtils],downconvertisbn13:!0,xisbn:{},makeSubjectSearch:function(subject){return this.makeSearch("d",subject)},makeTitleSearch:function(title){return this.makeSearch("t",title)},makeISBNSearch:function(isbn){return this.makeSearch("i",isbn)},makeISSNSearch:function(isbn){return this.makeSearch("is",isbn)},makeAuthorSearch:function(author){return this.makeSearch("a",author)},makeCallnoSearch:function(callno){return this.makeSearch("c",callno)},makeKeywordSearch:function(keyword){return this.makeSearch("Y",keyword)},makeXISBNRequest:function(isbn){return this.xisbn.res_id?"http://xisbn.worldcat.org:80/liblook2/resolve.htm?res_id="+this.xisbn.res_id+"&rft.isbn="+isbn+"&url_ver=Z39.88-2004&rft_val_fmt=info:ofi/fmt:kev:mtx:book":this.xisbn.opacid?"http://xisbn.worldcat.org/liblook/resolve.htm?res_id="+this.url.replace(/https/,"http")+"&opactype="+this.xisbn.opacid+(null!=this.xisbn.siteparam?this.xisbn.siteparam:"")+"&rft.isbn="+isbn:this.makeISBNSearch(isbn)},linkByISSN:function(issn){return this.makeISSNSearch(issn)},linkByISBN:function(isbn){return this.xisbn.cues?this.makeXISBNRequest(isbn):this.makeISBNSearch(isbn)},search:function(fields){fields=fields.filter(function(field){return""!=field.searchTerms}),0==fields.length&&(fields=[{searchType:"Y",searchTerms:""}]);for(var i=0;i<fields.length;i++){if(!this.supportsSearchType(fields[i].searchType))return void libx.log.write(this.name+" does not support search type "+fields[i].searchType);this.adjustISNSearchType(fields[i])}if(1==fields.length)var url=this.makeSearch(fields[0].searchType,fields[0].searchTerms);else var url=this.makeAdvancedSearch(fields);return null==url&&libx.log.write("Could not construct search"),url},combineSameTypedFields:function(fields){for(var searchField2Term={},i=0;i<fields.length;i++)with(fields[i])searchType in searchField2Term?searchField2Term[searchType]+=" "+searchTerms:searchField2Term[searchType]=searchTerms;return searchField2Term},supportsSearchType:function(stype){return(";"+this.options+";").match(";"+stype+";")},options:"Y;t;a;d;i;c",makeSearch:function(){},makeAdvancedSearch:function(){},previewers:{}}),libx.catalog.preview={getPreviewer:function(catalog,jQuery){if(!catalog.actualpreviewers)return null;var previewer=null;for(var i in catalog.actualpreviewers){var temp=new catalog.actualpreviewers[i](catalog,jQuery);if(null!=catalog[i]&&temp.isPreferred()){previewer=temp;break}}if(previewer)return previewer;for(var i in catalog.actualpreviewers)if(null!=catalog[i])return new catalog.actualpreviewers[i](catalog,jQuery);return null},addActualPreviewer:function(catalog,previewkey,previewer){catalog.actualpreviewers||(catalog.actualpreviewers={}),catalog.actualpreviewers[previewkey]=previewer},registerPreviewer:function(classDef){var catalog=classDef.catalog,previewkey=classDef.previewkey;libx.catalog.factory[catalog].prototype.previewers[previewkey]=libx.core.Class.create(libx.catalog.preview.Previewer,classDef);var evt=new libx.events.Event("PreviewerRegistered");evt.notify()},Previewer:libx.core.Class.create({initialize:function(catalog){this.catalog=catalog},doPreview:function(searchParams,callback){var directSearchUrl=this.catalog.search(searchParams),queryString=directSearchUrl.replace(/^.*\?/,""),previewServer=this.catalog[this.previewkey];libx.cache.defaultMemoryCache.get({url:previewServer+"?"+queryString,dataType:"json",success:callback})},isPreferred:function(){return!0},formatResult:function(result){return result},renderPreview:function(data,$elem){$elem.html(data)}})},libx.catalog.factory.bookmarklet=libx.core.Class.create(libx.catalog.Catalog,{makeSearch:function(stype,sterm){return this.makeAdvancedSearch([{searchType:stype,searchTerms:sterm}])},makeAdvancedSearch:function(fields){var usePost=null!=this.postdata;if(usePost)var argtemplate=this.postdata;else var argtemplate=this.url;for(var swtch,swtchre=/%SWITCH\{(%[a-z0-9]+)\}\{(([^}]+(\}\{)?)+)}/i;null!=(swtch=argtemplate.match(swtchre));){var s=swtch[1],repl="",caseargs=swtch[2].split("}{"),m=s.match(/^%type(\d+)/),switch_arg=null;m?m[1]<=fields.length&&(switch_arg=fields[m[1]-1].searchType):(m=s.match(/^%term(\d+)/),m?m[1]<=fields.length&&(switch_arg=fields[m[1]-1].searchTerms):libx.log.write("invalid switch_arg '"+s+"', must be %termX or %typeX"));for(var i=0;null!=switch_arg&&i<caseargs.length;i++){var re=new RegExp("^"+switch_arg+":(\\S*)$"),m=re.exec(caseargs[i]);if(m){repl=m[1];break}}argtemplate=argtemplate.replace(swtchre,repl)}for(var i=0;i<fields.length;i++)argtemplate=argtemplate.replace("%term"+(i+1),encodeURIComponent(fields[i].searchTerms),"g");argtemplate=argtemplate.replace(/%term\d+/g,"");for(var join,searchField2Term=this.combineSameTypedFields(fields),joinre=/%JOIN{(([^}]+(\}\{)?)+)}/i;null!=(join=argtemplate.match(joinre));){for(var caseargs=join[1].split("}{"),joiner=caseargs[0],repl="",i=1;i<caseargs.length;i++){var ca=caseargs[i].split("|");searchField2Term[ca[0]]&&(""!=repl&&(repl+=joiner),repl+=ca[1])}argtemplate=argtemplate.replace(joinre,repl)}for(var stype in searchField2Term)argtemplate=argtemplate.replace("%"+stype,encodeURIComponent(searchField2Term[stype]));for(var option in libx.edition.searchoptions)argtemplate=argtemplate.replace(new RegExp("%"+option+"(?![a-zA-Z0-9])"),"","g");return usePost?[this.url,argtemplate]:argtemplate}}),libx.catalog.factory.scholar=libx.core.Class.create(libx.catalog.Catalog,{options:"Y;at;jt;a",makeSearch:function(stype,sterm){return this.makeAdvancedSearch([{searchType:stype,searchTerms:sterm}])},makeAdvancedSearch:function(fields){return this.libxScholarSearch(fields)},libxScholarSearch:function(fields){for(var author="",keyword="",atitle="",journaltitle="",i=0;i<fields.length;i++)switch(fields[i].searchType){case"a":author+=fields[i].searchTerms+" ";break;case"at":atitle+=fields[i].searchTerms+" ";break;case"Y":case"i":keyword+=fields[i].searchTerms+" ";break;case"t":case"jt":journaltitle+=fields[i].searchTerms}var query="";query=""==keyword&&""!=atitle?"allintitle: "+atitle:keyword+" "+atitle,""!=author&&(query+=" author:"+author);var baseurl="http://scholar.google.com/scholar?hl=en&lr=";return journaltitle&&(baseurl+="&as_publication="+encodeURIComponent(journaltitle)),baseurl+"&q="+encodeURIComponent(libx.utils.string.trim(query))}}),function(){function cleanColon(stype,sterm){return"Y"!=stype?sterm:sterm.replace(/:/g,"")}libx.catalog.factory.millenium=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"innovative"},searchform:1,advancedcode:"X",keywordcode:"Y",journaltitlecode:"t",language:"",supportsSearchType:function(stype){return"at"==stype?(alert(libxGetProperty("articletitle.alert")),!1):!0},normalizeSearchType:function(stype){return"is"==stype?"i":"jt"==stype?this.journaltitlecode:stype},makeSearch:function(stype,sterm){stype=this.normalizeSearchType(stype),sterm=cleanColon(stype,sterm),"Y"==stype&&(stype=this.keywordcode);var query=this.url+"/search"+this.language+"/";switch(this.searchform){default:case"1":query+=stype+"?"+encodeURIComponent(sterm);break;case"2":query+=stype+"?SEARCH="+encodeURIComponent(sterm);break;case"3":query+="?/searchtype="+stype+"&searcharg="+encodeURIComponent(sterm)}var includeLimit="a"!=stype;return includeLimit&&(query+="&startLimit="),query+=null!=this.searchscope?"&searchscope="+this.searchscope:"",query+=null!=this.sort?"&SORT="+this.sort:"",includeLimit&&(query+="&endLimit="),query},makeAdvancedSearch:function(fields){var url=this.url+"/search"+this.language+"/"+this.advancedcode+"?SEARCH=";url+=this.normalizeSearchType(fields[0].searchType)+":("+encodeURIComponent(cleanColon(fields[0].searchType,fields[0].searchTerms))+")";for(var i=1;i<fields.length;i++)url+="+and+"+this.normalizeSearchType(fields[i].searchType)+":("+encodeURIComponent(cleanColon(fields[i].searchType,fields[i].searchTerms))+")";return url+=null!=this.searchscope?"&searchscope="+this.searchscope:"",url+="&SORT="+this.sort,this.sid&&(url+="&sid="+this.sid),url=url.replace(/Y:\(/g,"(")}})}(),libx.catalog.factory.horizon=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"ipac"},path:"/ipac20/ipac.jsp",subject:".SW",author:".AW",keyword:".GW",title:".TW",journaltitle:".JK",callno:"CALLLC",convert:function(stype){switch(stype){case"d":return this.subject;case"a":return this.author;case"t":return this.title;case"jt":return this.journaltitle;case"i":return this.isbn;case"is":return this.issn;case"c":return this.callno;case"Y":return this.keyword;default:return this.keyword}},supportsSearchType:function(stype){return"at"==stype?(alert(libxGetProperty("articletitle.alert")),!1):!0},makeSearch:function(stype,sterm){return this.url+this.path+"?"+(this.profile?"profile="+this.profile+"&":"")+(null!=this.sid?"sid="+this.sid+"&":"")+"index="+this.convert(stype)+"&term="+encodeURIComponent(sterm)},makeAdvancedSearch:function(fields){var url=this.url+this.path+"?";url+=this.profile?"profile="+this.profile+"&":"",url+=this.sid?"sid="+this.sid+"&":"",url+="index="+this.convert(fields[0].searchType)+"&term="+encodeURIComponent(fields[0].searchTerms);for(var i=1;i<fields.length;i++)url+="&oper=and&index="+this.convert(fields[i].searchType)+"&term="+encodeURIComponent(fields[i].searchTerms);return url}}),function(){function insertAND(s){s=s.replace(/(\(|\))/g," $1 ");var r=/(\"[^"]*\"|\S+)/g;s=s.replace(r,"$1#");for(var a=s.split("#"),len=a.length-1,str="",pword=0,i=0;len>i;i++)a[i].match(/^\s*"/)?0==i||1==pword?(str+=a[i],pword=0):str=str+" AND "+a[i]:a[i].match(/^\s*and\s*$/i)?1==pword||(str+="AND",pword=1):a[i].match(/^\s*or\s*$/i)?1==pword||(str+="OR",pword=1):a[i].match(/^\s*not\s*$/i)?(str+="NOT",pword=1):a[i].match(/&/)?(str=str.replace(/\s*([a-zA-Z0-9_\-\(\)\?]+)\s+$/,' "$1'),str=str+" & "+a[i+1]+'" ',i++):a[i].match(/(^\s*GKEY\s*$|^\s*IALL\s*$|^\s*ISBN\s*$|^\s*ISSN\s*$|^\s*JKEY\s*$|^\s*KPPD\s*$|^\s*LSUB\s*$|^\s*NKEY\s*$|^\s*NOTE\s*$|^\s*SERI\s*$|^\s*SKEY\s*$|^\s*TKEY\s*$|^\s*\d{3}[ABCKLNT]\s*$)/)?(1==pword||0==i?str+=a[i]:str=str+" AND "+a[i],pword=1):a[i].match(/\(/)?(1==pword||0==i?str+=" (":(str+=" AND (",pword=1),0==i&&(pword=1)):a[i].match(/\)/)?(str+=")",pword=0):a[i].match(/-/)?1==pword||0==i?(str=str+'"'+a[i]+'"',pword=0):str=str+' AND "'+a[i]+'"':0==i||1==pword?(str+=a[i],pword=0):str=str+" AND "+a[i],str+=" ";return str}libx.catalog.factory.voyager=libx.core.Class.create(libx.catalog.Catalog,{keyword:"FT*",count:25,relevanceranking:!0,xisbn:{opacid:"voyager"},__init:function(){this.autoinsertand&&(this.keyword="CMD",this.relevanceranking=!1)},convert:function(stype){switch(stype){case"d":return"SUBJ_";case"a":return"NAME_";case"t":return"TALL";case"jt":return"JALL";case"is":return"ISSN";case"i":return"ISBN";case"c":return"CALL_";case"Y":return this.keyword;default:return this.keyword}},convert2:function(stype){switch(stype){case"d":return"Subject (SKEY)";case"a":return"Author (NKEY)";case"jt":case"t":return"Title (TKEY)";case"is":case"i":return"ISSN/ISBN (ISSN)";case"Y":return"Keyword Anywhere (GKEY)";case"c":return"?not supported?";default:return"not supported"}},supportsSearchType:function(stype){return"at"==stype?(alert(libxGetProperty("articletitle.alert")),!1):!0},makeSearch:function(stype,sterm){return this.autoinsertand&&"Y"==stype&&(sterm=insertAND(sterm)),this.relevanceranking&&"Y"==stype&&(sterm=sterm.replace(/^(\S)/,"+$1"),sterm=sterm.replace(/\s+(\S)/g," +$1")),this.advancedsearchforissn&&"is"==stype?this.makeAdvancedSearch([{searchType:stype,searchTerms:sterm}]):(sterm=encodeURIComponent(sterm),this.url+"/cgi-bin/Pwebrecon.cgi?Search_Arg="+sterm+"&HIST=1&SL=None&Search_Code="+this.convert(stype)+"&CNT="+this.count+"&DB=local")},makeAdvancedSearch:function(fields){for(var url=this.url+"/cgi-bin/Pwebrecon.cgi?HIST=1&CNT=25&DB=local&SL=None",i=0;i<fields.length;i++)url+="&SAB"+(i+1)+"="+encodeURIComponent(fields[i].searchTerms)+"&BOOL1=all+of+these&FLD"+(i+1)+"="+this.convert2(fields[i].searchType),i<fields.length-1&&(url+="&GRP"+(i+1)+"=AND+with+next+set");return url}})}(),libx.catalog.factory.aleph=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"aleph"},scanindexlist:"t;c",supportsSearchType:function(stype){return"at"==stype?(alert(libxGetProperty("articletitle.alert")),!1):!0},escape:function(sterm){return encodeURIComponent(sterm).replace(/%20/g,"+")},searchCodeLookup:function(stype){switch(stype){case"d":return this.subject;case"jt":return this.journaltitle;case"t":return this.title;case"c":return this.callno;case"a":return this.author;case"Y":return this.keyword;case"is":return this.issn;case"i":return this.isbn;default:return this.keyword}},storeCcl:function(ccl){try{libx.ui.getCurrentWindowContent().setCcl&&libx.ui.getCurrentWindowContent().setCcl(ccl)}catch(er){libx.log.write("exception while setting aleph cookie: "+er,"aleph")}},makeSearch:function(stype,query){var s=";"+this.scanindexlist+";";if(s.match(";"+stype+";"))var sterm="&scan_code="+this.searchCodeLookup(stype)+"&scan_start="+this.escape(query),func=this.scanfunc;else var sterm="&find_code="+this.searchCodeLookup(stype)+"&request="+this.escape(query),func=this.findfunc;if("true"==this.usecclforsimple){var ccl=this.searchCodeLookup(stype)+"="+query;this.storeCcl(ccl),sterm="&ccl_term="+this.escape(ccl)}return this.url+"/F?func="+func+(null!=this.sid?"&sourceid="+this.sid:"")+(null!=this.localbase?"&local_base="+this.localbase:"")+sterm},makeAdvancedSearch:function(fields){var url=this.url+"/F?func="+this.advfindfunc+(null!=this.sid?"&sourceid="+this.sid:"")+(null!=this.localbase?"&local_base="+this.localbase:"");if("true"==this.usecclforadv){for(var ccl=this.searchCodeLookup(fields[0].searchType)+"="+fields[0].searchTerms,i=1;i<fields.length;i++)ccl+=" AND "+this.searchCodeLookup(fields[i].searchType)+"="+fields[i].searchTerms;this.storeCcl(ccl),url+="&ccl_term="+this.escape(ccl)}else{url+="&find_code="+this.searchCodeLookup(fields[0].searchType)+"&request="+this.escape(fields[0].searchTerms);for(var i=1;i<fields.length;i++)url+="&request_op=AND&find_code="+this.searchCodeLookup(fields[i].searchType)+"&request="+this.escape(fields[i].searchTerms)}return url}}),libx.catalog.factory.sirsi=libx.core.Class.create(libx.catalog.Catalog,{path:"/uhtbin/cgisirsi/x/0/0/5/",searchscope:1,xisbn:{opacid:"sirsi6"},convert:function(stype){switch(stype){case"d":return"&srchfield1="+this.convert2(stype);case"a":return"&srchfield1="+this.convert2(stype);case"jt":case"t":return"&srchfield1="+this.convert2(stype);case"is":case"i":return"&srchfield1="+this.convert2(stype);case"c":return"";case"Y":return"&srchfield1="+this.convert2(stype);default:return""}},convert2:function(stype){switch(stype){case"d":return"SU^SUBJECT^SUBJECTS^^subject";case"a":return"AU^AUTHOR^AUTHORS^Author Processing^author";case"t":return"TI^TITLE^TITLES^Title Processing^title";case"jt":return"PER^PERTITLE^TITLES^Title Processing^periodical title";case"is":case"i":return"GENERAL^SUBJECT^GENERAL^^keywords anywhere";case"Y":return"GENERAL^SUBJECT^GENERAL^^keywords anywhere";case"c":return"GENERAL^SUBJECT^GENERAL^^keywords anywhere";default:return"GENERAL^SUBJECT^GENERAL^^keywords anywhere"}},supportsSearchType:function(stype){return"at"==stype?(alert(libxGetProperty("articletitle.alert")),!1):!0},scopeField:function(){return 1!=this.searchscope?"&library="+this.searchscope:""},sortField:function(){return this.sort?"&sort_by="+this.sort:""},userId:function(){return this.user_id?"&user_id="+this.user_id+"&password="+(null!=this.password?this.password:""):""},makeSearch:function(stype,sterm){return this.url+this.path+"?searchdata1="+encodeURIComponent(sterm)+this.convert(stype)+this.scopeField()+this.sortField()+this.userId()},makeAdvancedSearch:function(fields){for(var url=this.url+this.path+"?",i=0;i<fields.length;i++)url+="srchfield"+(i+1)+"="+this.convert2(fields[i].searchType)+"&searchdata"+(i+1)+"="+encodeURIComponent(fields[i].searchTerms),i<fields.length-1&&(url+="&searchoper"+(i+1)+"=AND&");return url+this.scopeField()+this.sortField()+this.userId()}}),libx.catalog.factory.web2=libx.core.Class.create(libx.catalog.Catalog,{path:"/web2/tramp2.exe/do_keyword_search/log_in?guest=guest&",searchscope:1,xisbn:{opacid:"sirsi6"},convert:function(stype){switch(stype){case"d":return"SU";case"a":return"AU";case"jt":return"PER";case"t":return"TI";case"is":case"i":case"c":case"Y":default:return"default"}},convert2:function(stype){switch(stype){case"d":return"SU";case"a":return"AU";case"t":return"TI";case"jt":return"PER";case"is":case"i":case"Y":case"c":default:return""}},supportsSearchType:function(stype){return"at"==stype?(alert(libxGetProperty("articletitle.alert")),!1):!0},scopeField:function(){return 1!=this.searchscope?"&location_group_filter="+this.searchscope:""},sortField:function(){return this.sort?"&sort_by="+this.sort:""},makeSearch:function(stype,sterm){return this.url+this.path+"setting_key="+this.setting_key+"&index="+this.convert(stype)+"&servers="+this.servers+"&query="+encodeURIComponent(sterm)+this.scopeField()+this.sortField()},makeAdvancedSearch:function(fields){for(var url=this.url+this.path+"setting_key="+this.setting_key+"&servers="+this.servers+"&index=default&query=",i=0;i<fields.length;i++)url+="("+this.convert2(fields[i].searchType)+" "+encodeURIComponent(fields[i].searchTerms)+")",i<fields.length-1&&(url+=" AND ");return url+this.scopeField()+this.sortField()}}),libx.catalog.factory.centralsearch=libx.core.Class.create(libx.catalog.Catalog,{convert:function(stype){switch(stype){case"d":return"Subject";case"a":return"Author";case"t":return"Title";case"is":return"ISSN";case"i":return"ISBN";case"Y":return"Keyword";default:return"Any"}},supportsSearchType:function(){return!0},prolog:function(searchtype){return this.url+"/results?SS_LibHash="+this.sslibhash+(this.dbidlist?"&dbIDList="+this.dbidlist:"")+"&catGroupList=default&searchBy="+this.searchby+"&searchType="+searchtype},epilog:function(){var e="";return this.catids&&(e+="&catID="+this.catids.replace(/;/g,"&catID=")),this.catgroupids&&(e+="&catGroupID="+this.catgroupids.replace(/;/g,"&catGroupID=")),e},makeSearch:function(stype,sterm){return this.prolog("basic")+"&field="+this.convert(stype)+"&term="+encodeURIComponent(sterm)+this.epilog()},makeAdvancedSearch:function(fields){for(var url=this.prolog("advanced"),i=0;i<fields.length;i++)i>0&&(url+="&boolop"+i+"=And"),url+="&field"+i+"="+this.convert(fields[i].searchType)+"&term"+i+"="+encodeURIComponent(fields[i].searchTerms);return url+=this.epilog()}}),libx.catalog.factory.custom=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"Please set thisCatalog.xisbn.opacid as per http://xisbn.worldcat.org/liblook/howtolinkbyopactype.htm"},__init:function(){var thisCatalog=this;libx.log.write("Loading external catalog implementation from: "+thisCatalog.jsimplurl);var xhrParams={dataType:"text",type:"GET",url:thisCatalog.jsimplurl,complete:function(code){try{eval(code)}catch(er){libx.log.write("Error loading external catalog from "+thisCatalog.jsimplurl+". I received: "+code)}},bypassCache:!0};libx.cache.defaultMemoryCache.get(xhrParams)}}),libx.catalog.factory.evergreen=libx.core.Class.create(libx.catalog.Catalog,{locale:"en-US",skin:"default",scope:"",sortby:"",sortdirection:"asc",xisbn:{opacid:"evergreen"},convert:function(stype){switch(stype){case"Y":return"keyword";case"i":return"isbn";case"is":return"issn";case"a":return"author";case"t":return"title";case"d":return"subject";default:return"keyword"}},baseURL:function(){return this.url+"/opac/"+this.locale+"/skin/"+this.skin+"/xml/"},rresultBaseURL:function(){return this.baseURL()+"rresult.xml?l="+this.scope+"&s="+this.sortby+"&sd="+this.sortdirection},makeSearch:function(stype,sterm){switch(sterm=encodeURIComponent(sterm),stype){case"c":return this.baseURL()+"cnbrowse.xml?l="+this.scope+"&cn="+sterm;case"i":case"is":return this.rresultBaseURL()+"&rt="+this.convert(stype)+"&adv="+sterm;default:return this.rresultBaseURL()+"&rt="+this.convert(stype)+"&tp="+this.convert(stype)+"&t="+sterm}},makeAdvancedSearch:function(fields){var searchField2Term=this.combineSameTypedFields(fields),url=this.rresultBaseURL()+"&rt=multi&tp=multi&adv=&t=",combinedTerm="";for(var ftype in searchField2Term)combinedTerm+=this.convert(ftype)+":"+searchField2Term[ftype]+" ";return url+=encodeURIComponent(combinedTerm)}}),libx.catalog.factory.worldcat=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"worldcat"},convert:function(stype){switch(stype){case"Y":return"kw";case"a":return"au";case"t":return"ti";default:return""}},baseURL:function(){return this.url+"/search?qt="+this.qt+"&q="},specialBaseURL:function(what,id){return this.url+"/"+what+"/"+id},makeSearch:function(stype,sterm){switch(sterm=encodeURIComponent(sterm),stype){case"Y":return this.baseURL()+sterm;case"i":return this.specialBaseURL("isbn",sterm);case"is":return this.specialBaseURL("issn",sterm);default:return this.baseURL()+this.convert(stype)+":"+sterm}},makeAdvancedSearch:function(fields){var searchField2Term=this.combineSameTypedFields(fields),url=this.baseURL(),combinedTerm="";for(var ftype in searchField2Term)combinedTerm+=this.convert(ftype)+":"+searchField2Term[ftype]+" ";return url+=encodeURIComponent(combinedTerm)}}),libx.catalog.factory.vubis=libx.core.Class.create(libx.catalog.Catalog,{profile:"Default",opaclanguage:"eng",searchmethod:"Find_1",authorindex:"1*Authorbib",keywordindex:"1*Keywordsbib",subjectindex:"1*Subjectbib",titleindex:"1*Titlebib",issnindex:"1*Issn",isbnindex:"1*Isbn",xisbn:{opacid:"vubis"},searchType2Index:function(stype){switch(stype){case"d":return this.subjectindex;case"a":return this.authorindex;case"t":return this.titleindex;case"is":return this.issnindex;case"i":return this.isbnindex;case"Y":return this.keywordindex;default:return this.keywordindex}},makeSearch:function(stype,sterm){var url=this.url+this.path+"/LinkToVubis.csp?";return url+="Database=1&Language="+this.opaclanguage+"&SearchTerm="+encodeURIComponent(sterm)+"&Index="+this.searchType2Index(stype)+"&SearchMethod="+this.searchmethod+"&Profile="+this.profile},makeAdvancedSearch:function(fields){var url=this.url+this.path+"/List.csp?";url+="SearchTerm1="+encodeURIComponent(fields[0].searchTerms)+"&Index1="+this.searchType2Index(fields[0].searchType),url+="&Database=1";for(var i=1;i<fields.length;i++)url+="&BoolOp"+(i+1)+"=AND&SearchTerm"+(i+1)+"="+encodeURIComponent(fields[i].searchTerms)+"&Index"+(i+1)+"="+this.searchType2Index(fields[i].searchType);return url+"&OpacLanguage="+this.opaclanguage+"&NumberToRetrieve=50&SearchMethod="+this.searchmethod+"&Profile="+this.profile+"&PreviousList=Start&PageType=Start&WebPageNr=1&WebAction=NewSearch&StartValue=1&RowRepeat=1&EncodedRequest=a"}}),libx.catalog.factory.voyager7=libx.core.Class.create(libx.catalog.Catalog,{count:10,path:"/vwebv/search",limitto:"none",isbn:"ISBN",issn:"ISSN",subject:"SKEY",author:"NKEY",keyword:"GKEY",title:"TKEY",xisbn:{opacid:"webvoyager"},searchType2Index:function(stype){switch(stype){case"d":return this.subject;case"a":return this.author;case"t":return this.title;case"is":return this.issn;case"i":return this.isbn;case"Y":return this.keyword;default:return this.keyword}},makeSearch:function(stype,sterm){var url=this.url+this.path+"?";return url+="searchArg="+encodeURIComponent(sterm)+"&searchCode="+this.searchType2Index(stype)+"&limitTo="+this.limitto+"&recCount="+this.count+"&searchType=1"},makeAdvancedSearch:function(fields){var url=this.url+this.path+"?";url+="searchArg1="+encodeURIComponent(fields[0].searchTerms)+"&argType1=any&searchCode1="+this.searchType2Index(fields[0].searchType);for(var i=1;i<fields.length;i++)url+="&combine"+(i+1)+"=and&searchArg"+(i+1)+"="+encodeURIComponent(fields[i].searchTerms)+"&argType"+(i+1)+"=any&searchCode"+(i+1)+"="+this.searchType2Index(fields[i].searchType);
return url+"&recCount="+this.count+"&searchType=2"}}),libx.catalog.factory.talisprism=libx.core.Class.create(libx.catalog.Catalog,{collections:"1",location:"talislms",sites:"-1",path:"/TalisPrism",callnumber:"classNumber",controlnr:"controlNumber",author:"author",keyword:"keyword",title:"title",xisbn:{opacid:"talisPrism"},searchType2Index:function(stype){switch(stype){case"a":return this.author;case"t":return this.title;case"i":case"is":return this.controlnr;case"c":return this.callnumber;case"Y":return this.keyword;default:return this.keyword}},makeSearch:function(stype,sterm){return this.makeAdvancedSearch([{searchType:stype,searchTerms:sterm}])},makeAdvancedSearch:function(fields){var url=this.url+this.path+"/doSearch.do?";url+="searchCollections="+this.collections+"&searchSites="+this.sites+"&searchDates=&searchType=briefSearch";for(var i=0;i<fields.length;i++)url+="&st"+(i+1)+"="+this.searchType2Index(fields[i].searchType)+"&sb"+(i+1)+"=And&sv"+(i+1)+"="+encodeURIComponent(fields[i].searchTerms);return url+="&searchLocation="+this.location}}),libx.catalog.factory.polaris=libx.core.Class.create(libx.catalog.Catalog,{ctx:"1.1033.0.0.1",searchtype:"Advanced",kwsearchtype:"Keyword",limit:"TOM=*",xisbn:{opacid:"polaris"},convert:function(stype){switch(stype){case"Y":return"KW";case"i":return"ISBN";case"is":return"ISSN";case"a":return"AU";case"t":return"TI";case"d":return"SU";case"c":return"LCCN";default:return"KW"}},baseURL:function(){return this.url+"/polaris/Search/searchresults.aspx?ctx="+this.ctx},makeSearch:function(stype,sterm){return this.makeAdvancedSearch([{searchType:stype,searchTerms:sterm}])},makeAdvancedSearch:function(fields){var searchField2Term=this.combineSameTypedFields(fields),url=this.baseURL();for(var ftype in searchField2Term){switch(ftype){case"Y":url+="&type="+this.kwsearchtype;break;default:url+="&type="+this.searchtype}url+="&term="+encodeURIComponent(searchField2Term[ftype]),url+="&by="+this.convert(ftype)}return url+"&limit="+this.limit},makeXISBNRequest:function(isbn){return null==this.xisbn.res_id?"http://xisbn.worldcat.org/liblook/resolve.htm?res_id="+this.url.replace(/https/,"http")+"/polaris&opactype="+this.xisbn.opacid+(null!=this.xisbn.siteparam?this.xisbn.siteparam:"")+"&rft.isbn="+isbn:this.parent(isbn)}}),libx.catalog.factory.openurlresolver=libx.core.Class.create(libx.catalog.Catalog,{__init:function(edition){this.options=edition.openurl[this.resolvernum].options},search:function(fields){return libx.edition.openurl[this.resolvernum].search(fields)}}),libx.catalog.factory.primo=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"primo"},isbnindex:"isbn",issnindex:"issn",titlesearchmode:"contains",searchfn:"go",convert:function(stype){switch(stype){case"Y":return"any";case"t":return"title";case"a":return"creator";case"d":return"sub";case"c":return"lsr01";case"ut":return"usertag";case"i":return this.isbnindex;case"is":return this.issnindex;case"p":return"lsr03"}},makeSearch:function(stype,sterm){var url=this.url+this.path+"/action/search.do?";return url+="fn="+this.searchfn,url+="&ct=search",url+="&vid="+this.vid,url+="&mode=Basic",url+="&indx=0",url+="&dum=true",url+="&vl(freeText0)="+encodeURIComponent(sterm),url+="&"+this.materialvar+"="+this.defaultmaterial,url+="t"==stype?"&"+this.searchmodevar+"="+this.titlesearchmode:"&"+this.searchmodevar+"="+this.defaultsearchmode,url+="&"+this.searchvar+"="+this.convert(stype),url+="&scps="+this.scps},makeAdvancedSearch:function(fields){for(var url=this.url+this.path+"/action/search.do?frbg=&ct=search&indx=1",i=0;i<fields.length;i++)url+="&"+this["advsearchvar"+(i+1)]+"="+this.convert(fields[i].searchType),url+="t"==this.convert(fields[i].searchType)?"&"+this["advsearchmode"+(i+1)]+"="+this.titlesearchmode:"&"+this["advsearchmode"+(i+1)]+"="+this.defaultsearchmode,url+="&vl(freeText"+i+")="+encodeURIComponent(fields[i].searchTerms);return url+="&"+this.langvar+"="+this.defaultlanguage,url+="&mode=Advanced",url+="&vid="+this.vid,url+="&scp.scps="+this.scps,url+="&srt="+this.defaultsort,url+="&tab=default_tab",url+="&dum=true",url+="&"+this.advmaterialvar+"="+this.defaultmaterial,url+="&fn=search",url+="&"+this.datevar+"="+this.defaultdaterange}}),libx.openurl={factory:{}},libx.openurl.factory.webbridge=libx.openurl.factory.generic=libx.core.Class.create({include:[libx.catalog.CatalogUtils],makeOpenURLFromFields:function(fields){var url="__char_set=utf8";this.haveTitleOrIssn=!1,"0.1"==this.version?(this.genreprefix="genre=",this.doiprefix="id=doi:",this.pmidprefix="id=pmid:",this.titleprefix="title=",this.jtitleprefix="title=",this.btitleprefix="title=",this.atitleprefix="atitle=",this.isbnprefix="isbn=",this.issnprefix="issn=",this.aulastprefix="aulast=",this.aufirstprefix="aufirst="):(this.genreprefix="rft.genre=",this.doiprefix="rft_id=info:doi/",this.pmidprefix="rft_id=info:pmid/",this.jtitleprefix="rft.jtitle=",this.btitleprefix="rft.btitle=",this.atitleprefix="rft.atitle=",this.isbnprefix="rft.isbn=",this.issnprefix="rft.issn=",this.aulastprefix="rft.aulast=",this.aufirstprefix="rft.aufirst=");for(var i=0;i<fields.length;i++)switch(this.adjustISNSearchType(fields[i]),url+="&",fields[i].searchType){case"doi":url+=this.doiprefix+fields[i].searchTerms;break;case"pmid":url+=this.pmidprefix+fields[i].searchTerms;break;case"jt":case"t":url+="jt"==fields[i].searchType?this.jtitleprefix:this.btitleprefix,url+=encodeURIComponent(fields[i].searchTerms.replace(/\s+/," ")),this.haveTitleOrIssn=!0;break;case"at":url+=this.atitleprefix+encodeURIComponent(fields[i].searchTerms.replace(/\s+/," "));break;case"i":var pureISN=libx.utils.stdnumsupport.isISBN(fields[i].searchTerms,this.downconvertisbn13);if(null==pureISN)return alert(libx.locale.defaultStringBundle.getProperty("openurlissn.alert",fields[i].searchTerms)),null;url+=this.isbnprefix+pureISN,this.haveTitleOrIssn=!0;break;case"is":var pureISN=libx.utils.stdnumsupport.isISSN(fields[i].searchTerms);if(null==pureISN)return alert(libx.locale.defaultStringBundle.getProperty("openurlissn.alert",fields[i].searchTerms)),null;url+=this.issnprefix+pureISN,this.haveTitleOrIssn=!0;break;case"a":var sterm=fields[i].searchTerms,hasComma=sterm.match(/,/);sterm=sterm.replace(/[^A-Za-z0-9_\-\s]/g," ");var names=sterm.split(/\s+/);1==names.length?url+=this.aulastprefix+encodeURIComponent(names[0]):hasComma||names[names.length-1].match(/^[A-Z][A-Z]?$/i)?(url+=this.aulastprefix+encodeURIComponent(names[0]),url+=this.aufirstprefix+encodeURIComponent(names[1])):(url+=this.aulastprefix+encodeURIComponent(names[names.length-1]),url+=this.aufirstprefix+encodeURIComponent(names[0]));break;case"Y":return alert(libx.locale.defaultStringBundle.getProperty("openurlarticlekeyword.alert",this.name)),null}return this.addSid(url)},addSid:function(url,version){null==version&&(version=this.version),this.sidprefix="0.1"==version?"sid=":"rfr_id=info:sid/",url+="&"+this.sidprefix;var sid=this.sid;null!=this.pmidsid&&url.match(/pmid/i)?sid=this.pmidsid:null!=this.xrefsid&&url.match(/doi/i)&&(sid=this.xrefsid);try{sid=sid.replace(/%hostname%/,libx.ui.getCurrentWindowContent().location.hostname)}catch(er){libx.log.write(er+": exception occurred attempting to replace %hostname%","openurl")}return url+=encodeURIComponent(sid)},makeOpenURLSearch:function(fields){var path=this.makeOpenURLFromFields(fields),genre="unknown";if(-1!=path.indexOf(this.atitleprefix)||-1!=path.indexOf(this.doiprefix)||-1!=path.indexOf(this.pmidprefix)?genre="article":-1!=path.indexOf(this.isbnprefix)?genre="book":(-1!=path.indexOf(this.issnprefix)||-1!=path.indexOf(this.jtitleprefix))&&(genre="journal"),"1.0"==this.version)switch(genre){case"book":path="url_ver=Z39.88-2004&rft_val_fmt=info:ofi/fmt:kev:mtx:book&"+path;break;default:path="url_ver=Z39.88-2004&rft_val_fmt=info:ofi/fmt:kev:mtx:journal&"+path}return this.url+"?"+path+"&"+this.genreprefix+genre},makeOpenURLForISSN:function(issn){return this.makeOpenURLSearch([{searchType:"is",searchTerms:issn}])},makeOpenURLForDOI:function(doi){return this.makeOpenURLSearch([{searchType:"doi",searchTerms:doi}])},makeOpenURLForPMID:function(pmid){return this.makeOpenURLSearch([{searchType:"pmid",searchTerms:pmid}])},completeOpenURL:function(path,version){var url=this.url+"?"+path;return this.addSid(url,version)},options:"jt",search:function(fields){return this.makeOpenURLSearch(fields)},supportsSearchType:function(stype){return(";"+this.options+";").match(";"+stype+";")}}),libx.catalog.factory.sersol=libx.openurl.factory.sersol=libx.core.Class.create(libx.openurl.factory.generic,{options:"jt;i",makeOpenURLSearch:function(fields){if(1==fields.length){this.adjustISNSearchType(fields[0]);var stype=fields[0].searchType;if("jt"==stype)return this.url+"?V=1.0&S=T_W_A&C="+encodeURIComponent(fields[0].searchTerms);if("is"==stype)return this.url+"?V=1.0&S=I_M&C="+encodeURIComponent(fields[0].searchTerms)}return this.parent(fields)}}),libx.catalog.factory.sfx=libx.openurl.factory.sfx=libx.core.Class.create(libx.openurl.factory.generic,{makeOpenURLSearch:function(fields){var url=this.parent(fields);if(null==url)return null;for(var i=0;i<fields.length;i++)switch(fields[i].searchType){case"jt":url+="&sfx.title_search=contains";case"is":url+="&sfx.ignore_date_threshold=1"}return url}}),libx.openurl.factory.oclcgateway=libx.core.Class.create(libx.openurl.factory.generic,{url:"http://worldcatlibraries.org/registry/gateway",name:"OCLC Gateway",sid:"libx:oclcgateway",initialize:function(){var self=this,xhrParams={url:"http://www.worldcat.org/registry/lookup?IP=requestor",dataType:"xml",type:"GET",bypassCache:!0,complete:function(doc){try{var icons=doc.getElementsByTagName("linkIcon");icons.length>0&&(self.image=icons[0].textContent)}catch(e){}}};libx.cache.defaultMemoryCache.get(xhrParams)}}),libx.proxy={factory:{}},libx.proxy.factory.ezproxy=libx.core.Class.create({canCheck:function(){return null!=this.urlcheckpassword},checkURL:function(opt){var m=this.url.match(/(https?:\/\/[^\/]+)\/(.*)$/);if(!m)return libx.log.write("internal failure parsing proxy url: "+this.url+"..."),void opt.onsuccess();var purl=m[1]+"/proxy_url",postdata="xml="+encodeURIComponent('<?xml version="1.0"?><proxy_url_request password="'+this.urlcheckpassword+'"><urls><url>'+opt.url+"</url></urls></proxy_url_request>"),xhrParams={url:purl,dataType:"xml",type:"POST",data:postdata,bypassCache:!0,success:function(xmlhttp){var resp=libx.utils.xpath.findSingleXML(xmlhttp,"/proxy_url_response/proxy_urls/url[1]");return null!=resp&&libx.utils.types.normalize(resp.getAttribute("proxy"))?void opt.onsuccess():void opt.onfailure()}};libx.cache.defaultMemoryCache.get(xhrParams)},disableIfCheckFails:function(){return 1==this.disableifcheckfails},rewriteURL:function(url){return this.url.replace(/%S/,url)}}),libx.proxy.factory.wam=libx.core.Class.create({canCheck:function(){return!1},rewriteURL:function(url){var proxybase=this.url,m=url.match(/http:\/\/([^\/:]+)(:(\d+))?\/(.*)$/);if(m){var host=m[1],port=m[3];(void 0===port||""==port||80==port)&&(port=0);var path=m[4],newurl="http://"+port+"-"+host+"."+proxybase+"/"+path;return newurl}return url}}),libx.utils.stdnumsupport.isDOI=function(str){var s=str.replace(/\s*doi:?\s*/i,""),m=s.match(/10\.\S+\/\S+/);return m?m[0]:null},function(){function computeMod11CheckDigit(s){for(var n=s.length,chksum=0,i=0;n>i;i++)chksum+=(n+1-i)*s.charAt(i);return chksum=chksum%11==0?0:11-chksum%11,10==chksum?"X":chksum+""}function mod11Checksum(s,regx,removeprefix){s=s.replace(/[#:\-\s\.]/g,"").replace(removeprefix,"");var m=s.match(regx);if(null==m)return null;s=m[0];var n=s.length,mustdigit=computeMod11CheckDigit(s.substring(0,n-1)),hasdigit=s.charAt(n-1).replace(/x/i,"X");return mustdigit==hasdigit?s:null}function eanChecksum(s,regx,removeprefix){s=s.replace(/[#:\-\s\.]/g,"").replace(removeprefix,"");var m=s.match(regx);if(null==m)return null;s=m[0];for(var n=s.length,chksum=0,i=0;n-1>i;i++)chksum+=s.charAt(i)*(i%2==0?1:3);chksum=chksum%10==0?0:10-chksum%10;var chkdigit=parseInt(s.charAt(n-1));return chksum==chkdigit?s:null}libx.utils.stdnumsupport.isISBN=function(s,convertEANtoISBN){var ean=eanChecksum(s,/97[89]\d{10}/,/^ISBN/i);if(ean){if(convertEANtoISBN){var isbn=ean.substring(3,12);return isbn+computeMod11CheckDigit(isbn)}return ean}return mod11Checksum(s,/\d{9}[\dX]/i,/^ISBN/i)},libx.utils.stdnumsupport.isISSN=function(s){var issn=mod11Checksum(s,/\d{7}[\dX]/i,/^ISSN/i);return issn?issn.substring(0,4)+"-"+issn.substring(4,8):issn}}(),libx.utils.xpath={findSingleXML:function(doc,xpathexpr,root,namespaceresolver){var r,node;try{if(libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla)r=doc.evaluate(xpathexpr,root?root:doc,function(prefix){return namespaceresolver[prefix]},XPathResult.FIRST_ORDERED_NODE_TYPE,null),node=r.singleNodeValue;else if(libx.cs.browser.msie){var ns="";for(prefix in namespaceresolver)ns+="xmlns:"+prefix+"='"+namespaceresolver[prefix]+"' ";if(ns+="xmlns='http://www.w3.org/2005/Atom'",root){try{root.setProperty("SelectionLanguage","XPath"),root.setProperty("SelectionNamespaces",ns)}catch(er){}node=root.selectSingleNode(xpathexpr)}else doc.setProperty("SelectionLanguage","XPath"),doc.setProperty("SelectionNamespaces",ns),node=doc.selectSingleNode(xpathexpr)}else libx.log.write("Error - Unknown Browser! Check for appropriate feature support for libx.utils.xpath.findSingleNode"),node=null}catch(e){libx.log.write("In findSingleXML: XPath expression "+xpathexpr+" does not return a node: "+e.message+"\n Desc: "+e.description),node=null}return node},findNodesXML:function(doc,xpathexpr,root,namespaceresolver){var nodes,n,rr;try{if(libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla)for(nodes=doc.evaluate(xpathexpr,root?root:doc,function(prefix){return namespaceresolver[prefix]},XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),rr=new Array;null!=(n=nodes.iterateNext());)rr.push(n);else if(libx.cs.browser.msie){var ns="";for(prefix in namespaceresolver)ns+="xmlns:"+prefix+"='"+namespaceresolver[prefix]+"' ";if(ns+="xmlns='http://www.w3.org/2005/Atom'",root){try{root.setProperty("SelectionLanguage","XPath"),root.setProperty("SelectionNamespaces",ns)}catch(er){}nodes=root.selectNodes(xpathexpr)}else doc.setProperty("SelectionLanguage","XPath"),doc.setProperty("SelectionNamespaces",ns),nodes=doc.selectNodes(xpathexpr);for(rr=new Array,n=0;n<nodes.length;++n)rr.push(nodes[n])}}catch(e){return libx.log.write("In findNodesXML: XPath expression "+xpathexpr+" does not return a set of nodes: "+e.message+"\n Desc: "+e.description),null}return rr}},libx.ui.jquery.autocomplete=function($,options){function clearAutoComplete(){acResultsDiv.html(""),acResultsDiv.css("display","none")}function repositionResultsDiv(){var sf_pos=acSearchField.offset(),sf_top=sf_pos.top,sf_left=sf_pos.left,sf_height=acSearchField.height(),sf_width=acSearchField.width();acResultsDiv.css("position","absolute"),acResultsDiv.css("left",sf_left),acResultsDiv.css("top",sf_top+sf_height+6),acResultsDiv.css("width",sf_width+2)}function updownArrow(keyCode){return 40==keyCode||38==keyCode?(38==keyCode?0==acListCurrent||-1==acListCurrent?acListCurrent=acListTotal-1:acListCurrent--:acListCurrent==acListTotal-1?acListCurrent=0:acListCurrent++,acResultsDiv.children().each(function(i){i==acListCurrent?(acSearchField.val($(this).text()),this.className="selected"):this.className="unselected"}),!0):(acListCurrent=-1,!1)}function enterKey(keyCode){return 13==keyCode?(acResultsDiv.children().each(function(i){i==acListCurrent&&(acSearchField.val($(this).text()),options.select(acResultsDiv.children()[i].item),clearAutoComplete())}),!0):!1}function autoComplete(lastValue){function processResult(json){repositionResultsDiv();var ansLength=acListTotal=json.length;if(ansLength>0){for(acResultsDiv.empty(),i=0;ansLength>i;i++){var div=$('<div class="unselected" />');div.append(options.formatter(json[i])),div[0].item=json[i],acResultsDiv.append(div)}acResultsDiv.css("display","block");var divs=$("div",acResultsDiv);divs.mouseover(function(){this.className="selected"}),divs.mouseout(function(){this.className="unselected"}),divs.click(function(){acSearchField.val($(this).text()),clearAutoComplete(),options.select($(this)[0].item)})}else clearAutoComplete()}if(acSearchField.is(":visible")){var part=acSearchField.val();if(""==part)return void clearAutoComplete();if(lastValue==part)if(options.xhrUnrestricted){var url=options.make_url(part).replace(/&([^&]+)=\?/,"");$.get(url,function(data){processResult(libx.utils.json.parse(data))},"html")}else $.getJSON(options.make_url(part),processResult)}}var acListTotal=0,acListCurrent=-1,acDelay=500,acResultsDiv=$('<div class="results" />');$("body").append(acResultsDiv);var acSearchField=options.field;acSearchField.blur(function(){libx.utils.timer.setTimeout(clearAutoComplete,200)}),acSearchField.keyup(function(e){var keyCode=e.keyCode||window.event.keyCode,lastVal=acSearchField.val();return enterKey(keyCode)||updownArrow(keyCode)?void 0:27==keyCode?void clearAutoComplete():void libx.utils.timer.setTimeout(function(){autoComplete(lastVal)},acDelay)})},libx.ui.jquery.dropdown=function($,options){function clearResults(){acResultsDiv.fadeOut(100)}function repositionResultsDiv(){var sf_pos=acSearchField.offset(),sf_width=(acSearchField.height(),acSearchField.width()),results_left=sf_pos.left,results_top=sf_pos.top;acResultsDiv.height("");var bottom_overflow=results_top+acResultsDiv.height()-$("body").height();bottom_overflow>0&&(results_top-=bottom_overflow),7>results_top&&(acResultsDiv.height(acResultsDiv.height()+results_top),results_top=7),acResultsDiv.css("position","absolute"),acResultsDiv.css("left",results_left),acResultsDiv.css("top",results_top),acResultsDiv.css("width",sf_width),acResultsDiv.css("min-width","150px")}var acResultsDiv=$('<div class="results" />');$("body").append(acResultsDiv);for(var acSearchField=options.field,i=0;i<options.dropdown_items.length;i++){var div=$('<div class="unselected" />'),itemText=options.dropdown_items[i].text;div.text(itemText),function(value,text){div.click(function(){acSearchField.text(text),clearResults(),options.select&&options.select(value,text)})}(options.dropdown_items[i].value,itemText),div.mouseover(function(){this.className="selected"}),div.mouseout(function(){this.className="unselected"}),acResultsDiv.append(div)}acSearchField.click(function(){repositionResultsDiv(),acResultsDiv.fadeIn(function(){$("body").one("click",function(){clearResults()})})})},libx.ui.jquery.accordionmenu=function($,options){var theMenu=options.menu;return{setMenuItems:function(itemRef,itemName,subItems,selection){itemRef.empty();var itemLink=$('<a href="#"></a>');itemLink.text(itemName);var subItemList=$("<ul/>");itemRef.append(itemLink).append(subItemList),itemLink.click(function(){subItemList.is(":visible")?subItemList.slideUp("normal"):($("ul:visible",theMenu).slideUp("normal"),subItemList.slideDown("normal"))});for(var i=0;i<subItems.length;i++){var subItem=$('<a href="#"></a>');subItem.text(subItems[i].text);var li=$("<li></li>");li.append(subItem),li.appendTo(subItemList),function(text,value){subItem.click(function(){itemLink.text(text),subItemList.slideUp("normal"),selection(value,text)})}(subItems[i].text,subItems[i].value)}subItemList.hide()}}},function(){function initThresholds(){null==threshold1&&(threshold1=libx.utils.browserprefs.getIntPref("libx.magic.threshold1",50)/100),null==threshold2&&(threshold2=libx.utils.browserprefs.getIntPref("libx.magic.threshold2",60)/100)}var threshold1=null,threshold2=null;libx.ui.magicSearch=function(data){function handleMiss(url,data){if(null!=libx.edition.options.scholarmissurl&&"string"==typeof libx.edition.options.scholarmissurl){var onmissshow=libx.edition.options.scholarmissurl.replace(/%S/i,encodeURIComponent(data));libx.ui.openSearchWindow(onmissshow)}}function cosineSimilarity(str1,str2){function c(s){return s.replace(/[:\.,\)]*$/,"").replace(/^[\(]*/,"")}for(var str1toks=str1.split(/\s+/),str2toks=str2.split(/\s+/),i=0;i<str1toks.length;i++)str1toks[i]=c(str1toks[i]);for(var i=0;i<str2toks.length;i++)str2toks[i]=c(str2toks[i]);var str1terms=0,str2terms=0,uniq=new Object,uniqterms=0;for(var i in str1toks)void 0==uniq[str1toks[i]]&&(uniq[str1toks[i]]=!0,str1terms++,uniqterms++);var s2=new Object;for(var i in str2toks)void 0==uniq[str2toks[i]]&&(uniq[str2toks[i]]=!0,uniqterms++),void 0==s2[str2toks[i]]&&(s2[str2toks[i]]=!0,str2terms++);var commonterms=str1terms+str2terms-uniqterms;return commonterms/Math.sqrt(str1terms*str2terms)}function magicNormalize(t){return t=t.replace(/^\s+/,""),t=t.replace(/\s+$/,""),t=t.replace(/,+$/,""),t=t.replace(/\./g," "),t.toLowerCase()}initThresholds();var maxattempts=5;libx.log.write('Searching for: "'+data+'"',"Magic");var originaldata=data;data=magicNormalize(data);var baseurl="http://scholar.google.com/scholar?hl=en&lr=";baseurl+="&q=";var url=baseurl+encodeURIComponent(data);if(null==libx.edition.openurl.primary)return libx.ui.openSearchWindow(url),null;for(var triedexact=!1,_attempt=0;maxattempts>_attempt;_attempt++){libx.log.write("Attempt #"+_attempt+": "+url,"Magic");var xhrParams={url:url,type:"GET",dataType:"text",async:!1,bypassCache:!0},request=libx.cache.defaultMemoryCache.get(xhrParams),r=request.responseText,nf=r.match(/No pages were found containing <b>\"([^\"]*)\"<\/b>/);if(nf)data=data.replace(nf[1]," "),url=baseurl+encodeURIComponent(data);else{var div=r.match(/(<p class=g>[\s\S]*?)<\/div>/i);if(div){for(var hits=div[1].split(/<p class=g>/),found=!1,h=0;h<hits.length;h++)if(""!=hits[h]){var oregexp=/href=\"(\S*?sid=google&amp;([^\"]*))\"/i,openurl=hits[h].match(oregexp);null!=openurl&&openurl[0].match(/refworks/)&&(openurl=hits[h].replace(openurl[0],"").match(oregexp));var getcosine=function(comp){var t=comp.replace(/<.*?>/g,"").replace(/&nbsp;/g," ").replace(/^\s*/,"").replace(/\s*$/,"");return t=magicNormalize(t),cosineSimilarity(t,data)},titleplusauthor="",title=hits[h].replace(/&hellip;/," ").match(/<span class=\"w\">([\s\S]*?)<\/span>/);null==title&&hits[h].match(/\[CITATION\]/)&&(title=hits[h].replace(/&hellip;/," ").match(/\[CITATION\]([\s\S]*?)<br>/));var titleurl=null,titlesim=0;null!=title&&(titleurl=title[1].match(/<a href=\"([^\"]*)\"/i),titleurl&&(titleurl=titleurl[1]),titleplusauthor+=title[1],titlesim=getcosine(title[1]),libx.log.write("CosineSimilarity w/ titleline="+titlesim+' "'+title[1].replace(/<.*?>/g,"")+'"',"Magic"));var auline=hits[h].replace(/&hellip;/," ").match(/<span class=\"a\">([\s\S]*?)<\/span>/),ausim=0;if(null!=auline&&(titleplusauthor+=" "+auline[1],ausim=getcosine(auline[1]),libx.log.write("CosineSimilarity w/ authorline="+ausim+" "+auline[1].replace(/<.*?>/g,""),"Magic")),""!=titleplusauthor){var tplusauthsim=getcosine(titleplusauthor);libx.log.write("CosineSimilarity w/ title+authorline="+tplusauthsim,"Magic")}if(tplusauthsim>threshold1||titlesim+ausim>threshold2){if(!openurl&&!titleurl){libx.log.write("Above threshold, but found neither title nor OpenURL; title[1] was="+title[1],"Magic");continue}var vtu=titleurl,display=!libx.edition.options.suppressscholardisplay;if(openurl){var openurlpath=decodeURIComponent(openurl[2]).replace(/^&/,"");openurlpath=openurlpath.replace(/%E2%80%99/gi,"'"),openurlpath=libx.utils.xml.decodeEntities(openurlpath),libx.edition.options.sendorigdatawithopenurl&&(openurlpath+="&origdata="+encodeURIComponent(data)),vtu=libx.edition.openurl.primary.completeOpenURL(openurlpath,"0.1"),display=!0,libx.log.write("OpenURL: "+vtu,"Magic")}else vtu=decodeURIComponent(vtu),libx.log.write("DirectURL: "+vtu,"Magic");display&&(libx.ui.openSearchWindow(vtu),found=!0);break}libx.log.write("rejected because below threshold, thresholds are "+threshold1+" and "+threshold2,"Magic")}if(h==hits.length&&libx.log.write("I received "+hits.length+" hits in Scholar, but no matches were found","Magic"),!found&&!triedexact){triedexact=!0,data='"'+data+'"',url=baseurl+encodeURIComponent(data);continue}return found||handleMiss(url,originaldata),libx.edition.options.suppressscholardisplay?null:(found?libx.ui.openSearchWindow(url,"libx.newtab"):libx.ui.openSearchWindow(baseurl+encodeURIComponent(originaldata)),null)}libx.log.write("couldn't find result <div> in this scholar result: "+r,"Magic");var dym=r.match(/Did you mean:\s+<\/font><a\s+href=(\/scholar\S*)\s/i);if(!dym)return handleMiss(url,originaldata),libx.edition.options.suppressscholardisplay||libx.ui.openSearchWindow(baseurl+encodeURIComponent(originaldata)),null;url="http://scholar.google.com"+dym[1]}}return null}}(),libx.ui.openSearchWindow=function(url,override){"string"!=typeof url&&(url=libx.utils.getExtensionURL("popup/post.html")+"?"+libx.utils.json.stringify({url:url[0],data:url[1]}));var displaypref=libx.prefs.browser&&libx.prefs.browser.displaypref&&libx.prefs.browser.displaypref._value;switch(override?override:displaypref){case"newwindow":libx.ui.windows.create({url:url});break;case"sametab":libx.ui.tabs.getSelected(function(tab){libx.ui.tabs.update(tab.id,{url:url})});break;case"newtabswitch":libx.ui.tabs.create({url:url,selected:!0});break;case"newtab":default:libx.ui.tabs.create({url:url,selected:!1})}},libx.ui.ContextMenu=function(){var ContextMenuItem=libx.core.Class.create({initialize:function(){},visible:!0,title:"Context Menu Item",contexts:["all"],prefkey:"prefkey",onclick:function(){},onshowing:function(){},match:function(){return!0}});return ContextMenuItem.factory={},ContextMenuItem.factory.catalog=libx.core.Class.create(ContextMenuItem,{type:"catalog",matchFuncs:{i:function(info){return libx.utils.stdnumsupport.isISBN(info.selectionText)},is:function(info){return libx.utils.stdnumsupport.isISSN(info.selectionText)},doi:function(info){return libx.utils.stdnumsupport.isDOI(info.selectionText)},pmid:function(info){var m=info.selectionText.match(/(PMID|PubMed\s*ID)[^\d]*(\d+)/i);return null!=m?m[2]:null}},initialize:function(name,searchType){this.searcher=libx.edition.catalogs.getByName(name),this.searchType=searchType,this.title=libx.locale.defaultStringBundle.getProperty("label_search_catalog_type_str",name,libx.edition.searchoptions[searchType],'"%s"'),this.prefkey=name+"."+searchType,this.visible=libx.prefs.contextmenu[name][searchType]._value,this.match=function(matchFuncs){return searchType in matchFuncs?matchFuncs[searchType]:function(info){var match=!0;for(var i in matchFuncs)match=match&&!matchFuncs[i](info);return match}}(this.matchFuncs)},contexts:["selection"],onclick:function(info){libx.ui.openSearchWindow(this.searcher.search([{searchType:this.searchType,searchTerms:info.selectionText}]))}}),ContextMenuItem.factory.openurl=libx.core.Class.create(ContextMenuItem.factory.catalog,{type:"openurl",initialize:function(name){this.searcher=libx.edition.openurl.getByName(name),this.title=libx.locale.defaultStringBundle.getProperty("label_search_catalog_str",name,'"%s"'),this.prefkey=name+".enabled",this.visible=libx.prefs.contextmenu[name].enabled._value},contexts:["selection"],onclick:function(info){for(var options=["i","is","doi","pmid"],i=0;i<options.length;i++){var match=this.matchFuncs[options[i]](info);if(match)return void libx.ui.openSearchWindow(this.searcher.makeOpenURLSearch([{searchType:options[i],searchTerms:match}]))}libx.ui.openSearchWindow(this.searcher.makeOpenURLSearch([{searchType:"jt",searchTerms:info.selectionText}]))}}),ContextMenuItem.factory.proxy=libx.core.Class.create(ContextMenuItem,{type:"proxy",searchType:"enabled",initialize:function(name){this.parent(name),this.proxy=libx.edition.proxy.getByName(name),this.title=libx.locale.defaultStringBundle.getProperty("proxy_reload_label",this.proxy.name),this.prefkey=name+".enabled",this.visible=libx.prefs.contextmenu[name].enabled._value},onclick:function(info){libx.ui.openSearchWindow(this.proxy.rewriteURL(info.pageUrl),"sametab")},contexts:["page"]}),ContextMenuItem.factory.proxy_link=libx.core.Class.create(ContextMenuItem.factory.proxy,{type:"proxy",initialize:function(name){this.parent(name),this.title=libx.locale.defaultStringBundle.getProperty("proxy_follow_label",this.proxy.name)},contexts:["link"],onclick:function(info){libx.ui.openSearchWindow(this.proxy.rewriteURL(info.linkUrl))}}),ContextMenuItem.factory.scholar=libx.core.Class.create(ContextMenuItem,{initialize:function(){this.parent(),this.title=libx.locale.defaultStringBundle.getProperty("label_search_scholar",'"%s"'),this.prefkey="Google Scholar.magicsearch"},type:"scholar",contexts:["selection"],onclick:function(info){libx.ui.magicSearch(info.selectionText)}}),libx.core.Class.create({initialize:function(){this.items=[];for(var i=0;i<libx.edition.catalogs.length;i++){for(var catalog=libx.edition.catalogs[i],options=catalog.options.split(";"),j=0;j<options.length;j++)this.addItem(new ContextMenuItem.factory.catalog(catalog.name,options[j]));libx.prefs.contextmenu[catalog.name].xisbn&&this.addItem(new ContextMenuItem.factory.catalog(catalog.name,"xisbn"))}for(var i=0;i<libx.edition.openurl.length;i++){var resolver=libx.edition.openurl[i];this.addItem(new ContextMenuItem.factory.openurl(resolver.name))}for(var i=0;i<libx.edition.proxy.length;i++){var proxy=libx.edition.proxy[i];this.addItem(new ContextMenuItem.factory.proxy(proxy.name)),this.addItem(new ContextMenuItem.factory.proxy_link(proxy.name))}this.addItem(new ContextMenuItem.factory.scholar)},registerItem:function(id,item){this.items.push({id:id,item:item})},lookupItemId:function(id){for(var i=0;i<this.items.length;i++)if(this.items[i].id==id)return this.items[i].item},addItem:libx.core.AbstractFunction("libx.ui.ContextMenu.addItem"),removeItem:libx.core.AbstractFunction("libx.ui.ContextMenu.removeItem"),update:libx.core.AbstractFunction("libx.ui.ContextMenu.update"),ContextMenuItem:ContextMenuItem})}(),libx.events.addListener("EditionConfigurationLoaded",{onEditionConfigurationLoaded:function(){libx.ui.contextMenu=new libx.ui.ContextMenu}}),libx.ui.setIcon=function(){},libx.ui.tabs={create:function(createData){window.open(createData.url,"_newtab")},update:function(){throw"libx.ui.tabs.update not implemented in client-side"},getSelected:function(){throw"libx.ui.tabs.getSelected not implemented in client-side"},sendMessage:function(){throw"libx.ui.tabs.sendMessage not implemented in client-side"}},libx.ui.windows={create:function(createData){window.open(createData.url)}},function(){libx.ui.ContextMenu=libx.core.Class.create(libx.ui.ContextMenu,{initialize:function(){this.parent()},addItem:function(){},update:function(){}})}(),libx.services.autoedition={url:"$bootstrapURL$autoedition/findbyip/"},libx.services.autoedition.url=libx.cs.baseurl+"src/autoedition/findbyip/",libx.analytics=function(){var _trackEvent="_trackEvent",_trackPageview="_trackPageview",_setAccount="_setAccount",_cookiesToRemove=["__utma","__utmb","__utmc","__utmz","__utmv","_utmx"],push=function(args){try{libx.analytics.bd.push(args)}catch(err){libx.log.write("Error! Unable to send analytics 'push' request =>\n"+err.message)}},_track={search:function(args){libx.prefs.browser.trackextension._value&&args&&args.catalog&&push([_trackPageview,"/"+(args.searchtype||"searches")+"/"+args.edition.id+"/"+args.catalog])},libapp:function(args){if(libx.prefs.browser.tracklibapps._value&&args&&args.module&&args.libapp){args.module="mod_"+args.module,args.libapp="lib_"+args.libapp;var eventAction=args.actiontype?"|"+args.actiontype.toUpperCase():"";push([_trackEvent,args.module,args.libapp+eventAction,args.edition.id]),push([_trackEvent,args.libapp,args.module+eventAction,args.edition.id])}},firstRun:function(args){if(libx.prefs.browser.trackextension._value&&args.edition&&!libx.utils.browserprefs.getBoolPref("libx.firstRun",!1)){var arg="/firstRun/"+args.edition.id+"/"+unescape(args.edition.name["long"]);push([_trackPageview,arg]),libx.utils.browserprefs.setBoolPref("libx.firstRun",!0)}},activeEdition:function(args){if(libx.prefs.browser.trackextension._value&&args.edition){var arg="/active/"+args.edition.id+"/"+unescape(args.edition.name["long"]);push([_trackPageview,arg])
}},recommendation:function(args){if(libx.prefs.browser.trackextension._value&&args.edition){var arg="/autoedition/"+args.edition.id+"/"+unescape(args.edition.desc);push([_trackPageview,arg])}},setAccount:function(){push([_setAccount,libx.analytics._accountId])}};return{track:function(args){args.edition=args.edition||libx.edition;var activity=args&&args.activity;_track[activity]&&_track[activity](args)},bd:{push:libx.core.AbstractFunction("libx.analytics.bd.push")},cleanCookies:function(docDomain){libx.utils.cookie?_cookiesToRemove.forEach(function(c){libx.utils.cookie.removeCookie(c,"."+docDomain)}):libx.log.write("libx.utils.cookie undefined. No Cookie cleanup done! But, continuing with push request.")},debug:!1,_accountId:"$gaaccountid$"}}(),libx.analytics.bd.push=function(args){_gaq.push(args)},libx.analytics.debug)var ga_debug={trace:!1};var _gaq=_gaq||[];libx.analytics._accountId="UA-30755371-1",libx.analytics.track({activity:"setAccount"}),function(){var ga=document.createElement("script");ga.type="text/javascript",ga.async=!0,ga.src="https://ssl.google-analytics.com/"+(window.ga_debug?"u/ga_debug.js":"ga.js");var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(ga,s)}(),function(){function resolveURL(baseURL,url){return url.match(/^[a-z]+:/)?url:url.match(/^\/.*/)?baseURL.match(/^[a-z]+:\/\/[^\/]+\//)+url.replace(/^\//,""):baseURL.match(/^.*\//)+url}function handleEntry(visitor,url,obj,cacheMissActivity){function handleEntryBody(xmlDoc,baseURL,entryNode){var libx2Node=libx.utils.xpath.findSingleXML(xmlDoc,"./libx2:package|./libx2:libapp|./libx2:module",entryNode,ns),title=libx.utils.xpath.findSingleXML(xmlDoc,"./atom:title/text()",entryNode,ns);title=null!=title?title.nodeValue:"atom:title is missing";var desc=libx.utils.xpath.findSingleXML(xmlDoc,"./atom:content/text()",entryNode,ns);desc=null!=desc?desc.nodeValue:"atom:content is missing";var atomid=libx.utils.xpath.findSingleXML(xmlDoc,"./atom:id/text()",entryNode,ns);if(atomid=null!=atomid?atomid.nodeValue:"atom:id is missing",null==libx2Node){var err="Entry ("+atomid+") does not contain any libx2:* node";return libx.log.write(err),void(visitor.error&&visitor.error(err,prep,obj))}var tempNode,nodeInfo={baseURL:baseURL,id:atomid,title:title,type:libx2Node.localName||libx2Node.nodeName.replace("libx:",""),description:desc,entries:[]};for(infoItem in entryInfo)if(0==entryInfo[infoItem].length)tempNode=libx.utils.xpath.findSingleXML(xmlDoc,"./atom:"+infoItem+"/text()",entryNode,ns),tempNode=null!=tempNode?tempNode.nodeValue:"atom:"+infoItem+" is missing",nodeInfo[infoItem]=tempNode;else{var itemInfoArr=entryInfo[infoItem];nodeInfo[infoItem]={};for(var item=0;item<itemInfoArr.length;++item)tempNode=libx.utils.xpath.findSingleXML(xmlDoc,"./atom:"+infoItem+"/atom:"+itemInfoArr[item]+"/text()",entryNode,ns),tempNode=null!=tempNode?tempNode.nodeValue:"atom:"+infoItem+"//"+itemInfoArr[item]+" is missing",nodeInfo[infoItem][itemInfoArr[item]]=tempNode}for(var clauses=libx2Clauses,i=0;i<clauses.length;i++){var clause=clauses[i],clauseNodes=libx.utils.xpath.findNodesXML(xmlDoc,"./libx2:"+clause,libx2Node,ns);if(clause in libx2ArrayClauses&&(nodeInfo[clause]=new Array),null!=clauseNodes)if(clause in libx2ArrayClauses)for(var j=0;j<clauseNodes.length;j++)nodeInfo[clause].push(String(clauseNodes[j].firstChild.nodeValue));else clauseNodes.length>0&&(nodeInfo[clause]=clauseNodes[0].textContent),clauseNodes.length>1&&libx.log.write("module: '"+desc+"' additional <"+clause+"> ignored")}var prefNodes=libx.utils.xpath.findNodesXML(xmlDoc,"./libx2:preferences/*",libx2Node,ns);null!=prefNodes&&prefNodes.length&&libx.prefs[url]&&prefNodes.forEach(function(node){libx.preferences.loadXML(node,{base:"libx.prefs."+url})});for(var i=0;i<libx2RegexpClauses.length;i++)for(var rClause=libx2RegexpClauses[i],j=0;j<nodeInfo[rClause].length;j++)try{var m=nodeInfo[rClause][j].match(/\/(.*)\/(.*)/);nodeInfo[rClause][j]={regex:m[1],flag:m[2]}}catch(e){libx.log.write("invalid regular expression: "+nodeInfo[rClause][j]),nodeInfo[rClause].splice(j--,1)}for(var libxEntries=libx.utils.xpath.findNodesXML(xmlDoc,"./libx2:entry",libx2Node,ns),i=0;null!=libxEntries&&i<libxEntries.length;i++){var nodeEntry={url:resolveURL(baseURL,String(libxEntries[i].getAttribute("src")))},argNodes=libx.utils.xpath.findNodesXML(xmlDoc,"./libx2:args/libx2:arg",libxEntries[i],ns);if(null!=argNodes){nodeEntry.args={};for(var j=0;j<argNodes.length;j++)nodeEntry.args[argNodes[j].getAttribute("name")]={value:argNodes[j].getAttribute("value"),type:argNodes[j].getAttribute("type")}}nodeInfo.entries.push(nodeEntry)}var params=libx.utils.xpath.findNodesXML(xmlDoc,"./libx2:params/libx2:param",libx2Node,ns);nodeInfo.params={};for(var i=0;null!=params&&i<params.length;i++)nodeInfo.params[params[i].getAttribute("name")]={type:params[i].getAttribute("type"),desc:params[i].textContent};var locales=libx.utils.xpath.findNodesXML(xmlDoc,"./libx2:locale",libx2Node,ns);if(nodeInfo.locales={},null!=locales)for(var i=0;i<locales.length;i++){var language=locales[i].getAttribute("language");nodeInfo.locales[language]=locales[i].textContent,"true"==locales[i].getAttribute("default")&&(nodeInfo.defaultLocale=language)}var visitorMethodName="on"+String(libx2Node.localName||libx2Node.nodeName.replace("libx:",""));visitor[visitorMethodName]&&visitor[visitorMethodName](nodeInfo,prep,obj);var params=libx.utils.xpath.findNodesXML(xmlDoc,"./libx2:params/libx2:param",libx2Node,ns)}if(visitor.beforeentry)var prep=visitor.beforeentry(url);var pathDir=(url.split(/\//),String(url.match(/.*\//))),pathBase=url.replace(/.*\//,"");debug&&libx.log.write("url= "+url+" path="+pathDir+" base="+pathBase);var success=!1,pathRequest={dataType:"xml",url:pathDir,validator:libx.cache.validators.feed,cacheOnly:cacheMissActivity&&!0,success:function(xmlDoc){success=!0;var xpathExpr="//atom:entry[atom:id/text() = '"+url+"']",entry=libx.utils.xpath.findSingleXML(xmlDoc,xpathExpr,xmlDoc,ns);if(null!=entry)handleEntryBody(xmlDoc,pathDir,entry);else{success=!1;var urlRequest={dataType:"xml",url:url,validator:libx.cache.validators.feed,cacheOnly:pathRequest.cacheOnly,success:function(xmlDoc){success=!0,handleEntryBody(xmlDoc,pathDir,xmlDoc.documentElement)},error:function(err){var err2="atomparser.js: Error status "+err+" when walking "+url;libx.log.write(err2),visitor.error&&visitor.error(err2,prep,obj)},complete:function(){urlRequest.cacheOnly&&!success&&(cacheMissActivity.markReady(),urlRequest.cacheOnly=!1,libx.cache.defaultObjectCache.get(urlRequest))}};libx.cache.defaultObjectCache.get(urlRequest)}},complete:function(){pathRequest.cacheOnly&&!success&&(cacheMissActivity.markReady(),pathRequest.cacheOnly=!1,libx.cache.defaultObjectCache.get(pathRequest))},error:function(err){var err2="atomparser.js: Error status "+err+" when walking "+pathDir;libx.log.write(err2),visitor.error&&visitor.error(err2,prep,obj)}};libx.cache.defaultObjectCache.get(pathRequest)}var debug=!1,ns={atom:"http://www.w3.org/2005/Atom",libx2:"http://libx.org/xml/libx2"},libx2Clauses=["include","exclude","require","guardedby","body","regexptexttransformer","override"],libx2ArrayClauses={include:1,exclude:1,guardedby:1,require:1,regexptexttransformer:1},libx2RegexpClauses=["include","exclude","regexptexttransformer"],authorInfo=["name","uri","email"],entryInfo={updated:[],author:authorInfo};libx.libapp.nsResolver=ns,libx.libapp.PackageVisitor=libx.core.Class.create({onpackage:function(pkg,prep,pkgObj){for(var i=0;i<pkg.entries.length;i++)handleEntry(this,pkg.entries[i].url,pkgObj)},onlibapp:function(libapp,prep,libappObj){for(var i=0;i<libapp.entries.length;i++)handleEntry(this,libapp.entries[i].url,libappObj)},onmodule:function(){},beforeentry:function(){}}),libx.libapp.PackageWalker=libx.core.Class.create({initialize:function(rootPackageId){this.rootPackage=rootPackageId},walk:function(visitor,rootObj,cacheMissActivity){handleEntry(visitor,this.rootPackage,rootObj,cacheMissActivity)}})}(),function(){function checkIndex(vector,index){if(0>index||index>=vector.length)throw new Error("array index out of bounds: "+index+"("+vector.length+")")}var Vector=libx.utils.collections.Vector=libx.core.Class.create({initialize:function(){this.vector=[]},set:function(index,value){return checkIndex(this.vector,index),this.vector[index]=value,this},get:function(index){return checkIndex(this.vector,index),this.vector[index]},add:function(value){this.vector.push(value)},size:function(){return this.vector.length},count:function(){for(var s=0,i=0;i<this.vector.length;i++)this.vector[i]&&s++;return s},clone:function(){var bv=new Vector;return bv.vector=this.vector.concat(),bv}})}(),function(){libx.events.addListener("EditionConfigurationLoaded",{onEditionConfigurationLoaded:function(){for(var k=0;k<libx.edition.catalogs.length;k++){var catalog=libx.edition.catalogs[k];"summonproxyurl"in catalog&&"bookmarklet"==catalog.type&&catalog.url.indexOf("summon.serialssolutions.com")>0&&(issummonurlavail=!0,libx.catalog.preview.addActualPreviewer(catalog,"summonproxyurl",catalog.previewers.summonproxyurl),previewurl=catalog.url)}}},void 0,"initsummonproxy");var docTypeIcons={"Architectual Drawing":{},"Archival Material":{},Atlas:{},"Audio Recording":{},"Audio Tape":{},Book:{image:"Book.png"},"Book Chapter":{},"Book Review":{},"Compact Disc":{image:"CompactDisc.png"},"Computer File":{},"Course Reading":{},"Conference Proceeding":{image:"ConferenceProceedings.png"},eBook:{},eJournal:{},Film:{},Globe:{},"Government Document":{},Image:{image:"Image.png"},Journal:{image:"JournalArticle.png"},"Journal Article":{image:"JournalArticle.png"},Kit:{},Manuscript:{},Map:{image:"Map.png"},Microform:{},Microfilm:{},"Music Score":{image:"MusicScore.png"},"Music Manuscript":{},"Music Recording":{},Newspaper:{image:"Newspaper.png"},"Newspaper Article":{image:"Newspaper.png"},Photograph:{},Poster:{},Realia:{},"Sheet Music":{},"Special Collection":{},"Spoken Word Recording":{},Dissertation:{image:"Thesis.png"},Thesis:{image:"Thesis.png"},"Video Recording":{image:"VideoRecording.png"},"Web Resource":{image:"Internet.png"},DVD:{image:"DVD.png"}};libx.catalog.preview.registerPreviewer({catalog:"bookmarklet",previewkey:"summonproxyurl",isPreferred:function(){return!libx.prefs.browser.showsummonwidget._value},formatResult:function(d,$){function join(arr,max,replacewith){if(void 0!=arr){var f="";return $.each(arr,function(idx,el){idx>max?(f+=replacewith,replacewith=""):(idx>0&&(f+=", "),f+=el)}),f}}function add(what){void 0!=what&&(s+=sep+what,sep=", ")}function addIf(prop,before,after){if(prop in d){switch(void 0!=before&&(s+=before),typeof d[prop]){case"boolean":break;case"string":break;case"object":d[prop].length&&(s+=d[prop][0])}void 0!=after&&(s+=after)}}function w(f){return void 0!=f?f[0]:void 0}function getBool(d,label){if(label in d)switch(typeof d[label]){case"boolean":return d[label];case"object":return"true"==d[label]}}var s='<div style="clear: both">',sep="",ctype=d.ContentType[0];if(ctype in docTypeIcons&&"image"in docTypeIcons[ctype])var imgFile=docTypeIcons[ctype].image;else var imgFile="Generic.png";s+='<img title="'+ctype+'" style="float: left; padding: 2px" src="ctimages/'+imgFile+'"></img>';var title=w(d.Title),uri=d.link||d.url||w(d.uri)||w(d.URI);switch(uri&&(title='<a title="" href="'+uri+'">'+title+"</a>"),add(title),add(join(d.Author,3," et al")),"PublicationYear"in d?addIf("PublicationYear"):"PublicationDate"in d&&add(w(d.PublicationDate).replace(/^c/,"").substring(0,4)),ctype){case"Journal Article":case"Newspaper Article":case"Book Chapter":var ititle="";"ISSN"in d&&(ititle="ISSN: "+w(d.ISSN)),"ISBN"in d&&(ititle="ISBN: "+w(d.ISBN));var isScholarly=getBool(d,"IsScholarly");isScholarly&&(ititle+=" (Scholarly)");var isPeerReviewed=getBool(d,"IsPeerReviewed");isPeerReviewed&&(ititle+=" (PeerReviewed)"),addIf("PublicationTitle",' <i title="'+ititle+'">',"</i>."),addIf("NewspaperSection"," "),addIf("Volume"," "),addIf("Issue","(",")"),addIf("Number",":"),addIf("StartPage",", ")}add(" "),addIf("Abstract",'<span title="','"> (Abstract)</span> ');var $openUrlLink="<span></span>";if("openUrl"in d&&libx.edition.openurl.primary){var resolver=libx.edition.openurl.primary,openurl=resolver.completeOpenURL(d.openUrl);$openUrlLink=$('&nbsp;<a href="'+openurl+'" title="Retrieve via '+resolver.name+'">'+resolver.name+"</a>")}s+="</div>";var $s=$(s);return $s.append($openUrlLink),$s.append('<div style="clear: both; border-style: none none dotted none; border-bottom: 1px dotted #808080;"></div>'),$s},renderPreview:function(data,$elem,$){$elem.empty(),$elem.append("<p>Found "+data.recordCount+" results in "+data.queryTime+"ms.</p>");var previewer=this;$.each(data.documents,function(idx,el){previewer.formatResult(el,$).appendTo($elem).find("a").each(function(){var href=$(this).attr("href");$(this).click(function(){libx.ui.openSearchWindow(href)}),$(this).attr("href","javascript:void(0);")})}),libx.analytics&&libx.analytics.track({activity:"search",catalog:this.catalog.name,searchtype:"previewedbysummonapi"})}})}(),function(){libx.events.addListener("EditionConfigurationLoaded",{onEditionConfigurationLoaded:function(){for(var k=0;k<libx.edition.catalogs.length;k++){var catalog=libx.edition.catalogs[k];"url"in catalog&&"bookmarklet"==catalog.type&&catalog.url.indexOf("summon.serialssolutions.com")>0&&(libx.catalog.preview.addActualPreviewer(catalog,"url",catalog.previewers.url),null==libx.prefs.browser.showsummonwidget&&(libx.prefs.browser._addPreference({_name:"showsummonwidget",_type:"boolean"}),libx.prefs.browser.showsummonwidget._value=!1,libx.preferences.save()))}}},void 0,"init_summonWidget"),libx.catalog.preview.registerPreviewer({catalog:"bookmarklet",previewkey:"url",isPreferred:function(){return libx.prefs.browser.showsummonwidget._value},doPreview:function(searchparams,callback){var inputstr="",values=searchparams,i=0;for(i=0;i<values.length;i++){var value=values[i];if(""!=value.searchTerms)switch(inputstr+=" ",value.searchType){case"Y":inputstr+=value.searchTerms;break;case"a":inputstr+="AuthorCombined:("+value.searchTerms+")";break;case"t":inputstr+="title:("+value.searchTerms+")";break;case"jt":inputstr+="PublicationTitle:"+value.searchTerms;break;case"d":inputstr+="SubjectTerms:"+value.searchTerms;break;case"i":inputstr+=!libx.utils.stdnumsupport.isISBN(value.searchTerms)&&libx.utils.stdnumsupport.isISSN(value.searchTerms)?"issn:("+value.searchTerms+")":"isbn:("+value.searchTerms+")"}}var prefix=this.getPrefix(),URL="http://"+prefix+".summon.serialssolutions.com/widgets/search?s.q="+encodeURIComponent(inputstr)+"&s.ho=t&s.role=authenticated&format=searchwidget&callback=";libx.cache.defaultMemoryCache.get({url:URL,datatype:"json",success:callback})},getPrefix:function(){var tempurl=this.catalog.url.split("."),prefix=tempurl[0].substr(tempurl[0].indexOf("//")+2,tempurl[0].length);return prefix},renderPreview:function(data,$elem){$elem.html(libx.utils.json.parse(data.substr(1,data.length-2)).results),libx.analytics&&libx.analytics.track({activity:"search",catalog:this.catalog.name,searchtype:"previewedbysummonwidget"})}})}();