libx={},libx.global=libx,libx.core=function(){var a=function(){var b={};return{extend:function(c,d){arguments.length==1&&(d=c,c=null);var e=function(){if(arguments[0]==b)return;typeof this.initialize=="function"&&this.initialize.apply(this,arguments)};typeof c=="function"&&(e.prototype=new c(b));var f=[];d&&d.include&&(d.include.reverse?f=f.concat(d.include.reverse()):f.push(d.include),delete d.include),d&&a.inherit(e.prototype,d);for(var g=0;mixin=f[g];g++)a.mixin(e.prototype,mixin);return e},mixin:function(a,b,c){c=c||!1;if(typeof b!="undefined"&&b!==null)for(var d in b)if(c||!a[d]&&typeof b[d]=="function")a[d]=b[d];return a},inherit:function(b,c,d){if(arguments.length==3){var e=b[d],f=c[d],g=f;f=function(){var a=this.parent;this.parent=e;var b=g.apply(this,arguments);return a?this.parent=a:delete this.parent,b},f.valueOf=function(){return g},f.toString=function(){return g.toString()},b[d]=f}else for(var h in c)b[h]&&typeof c[h]=="function"?a.inherit(b,c,h):b[h]=c[h];return b},singleton:function(){var c=arguments;if(c.length==2&&c[0].getInstance){var d=c[0].getInstance(b);d&&(c[0]=d)}return function(c){var d=!1,e=a.extend.apply(c.callee,c);return{getInstance:function(){return arguments[0]==b?e:d?d:d=new e}}}(c)}}}();return a.create=function(){return a.extend.apply(this,arguments)},{Class:a,EmptyFunction:function(){},TrueFunction:function(){return!0},FalseFunction:function(){return!1},AbstractFunction:function(a){return function(){throw new Error("function "+a+" not implemented")}}}}(),function(){libx.services={},libx.libapp={},libx.cache={},libx.ui={bd:{},jquery:{}},libx.utils={stdnumsupport:{},browserprefs:{},xml:{loadXMLDocumentFromString:libx.core.AbstractFunction("libx.utils.xml.loadXMLDocumentFromString"),convertXMLDocumentToString:libx.core.AbstractFunction("libx.utils.xml.convertXMLDocumentToString"),encodeEntities:function(a){a=String(a);var b="";for(var c=0;c<a.length;c++){var d=a.charAt(c);b+={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[d]||d}return b},decodeEntities:function(a){var b="";for(var c=0;c<a.length;c++){var d=a.charAt(c);b+={"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"'}[d]||d}return b}},xpath:{findSingleXML:libx.core.AbstractFunction("libx.utils.xpath.findSingleXML"),findNodesXML:libx.core.AbstractFunction("libx.utils.xpath.findNodesXML")},string:{trim:function(a){return a.replace(/^\s*/,"").replace(/\s*$/,"")}},types:{normalize:function(a){return a=="false"?!1:a=="true"?!0:a==""?null:String(a)},dumpObject:function(a,b){b=b||"";for(var c in a)b+=c+"="+a[c]+" ("+typeof a[c]+"), ";return b}},collections:{LinkedList:libx.core.Class.create({initialize:function(){this.head={prev:null},this.tail={next:null},this.head.next=this.tail,this.tail.prev=this.head},insert:function(a,b){b.prev=a.prev,b.next=a,a.prev.next=b,a.prev=b},remove:function(a){if(!("prev"in a))throw libx.log.backtrace("LinkedList.remove"),new Error("LinkedList.remove: node not in list: "+a);a.prev.next=a.next,a.next.prev=a.prev,delete a.prev,delete a.next},front:function(){return this.head.next},back:function(){return this.tail.prev},pushFront:function(a){this.insert(this.front(),a)},pushBack:function(a){this.insert(this.tail,a)},popFront:function(a){var b=this.front();return this.remove(b),b},popBack:function(a){var b=this.back();return this.remove(b),b},begin:function(){return this.front()},end:function(){return this.tail},rbegin:function(){return this.back()},rend:function(){return this.head},map:function(a){for(var b=this.begin();b!=this.end();b=b.next)a(b)},toString:function(){var a="[";return this.map(function(b){a+=b+", "}),a+"]"}}),unittests:function(a){a.write("Running unit tests for linked list\n");var b=new libx.utils.collections.LinkedList,c=new libx.core.Class.create({initialize:function(a){this.value=a},toString:function(){return""+this.value}});b.pushFront(new c("C")),b.pushFront(new c("B")),b.pushFront(new c("A")),a.write(b+"\n"),b.pushFront(b.popBack()),a.write(b+"\n"),b.pushBack(b.popFront()),a.write(b+"\n");var d=b.front().next;b.remove(d),a.write(b+"\n"),b.pushFront(d),a.write(b+"\n");for(var e=b.rbegin();e!=b.rend();e=e.prev)a.write(e+", ");a.write("\n")}},timer:{}},libx.utils.collections.ActivityQueue=libx.core.Class.create(libx.utils.collections.LinkedList,{prepareActivity:function(a){a._isReady=!1,a._hasRun=!1;var b=this;a.markReady=function(){var c=[].slice.call(arguments,0);b.markActivityReady.apply(b,[a].concat(c))},a.scheduleBefore=function(c){b.prepareActivity(c),b.insert(a,c)}},scheduleFirst:function(a){this.prepareActivity(a),this.pushFront(a)},scheduleLast:function(a){this.prepareActivity(a),this.pushBack(a)},markActivityReady:function(a){a._isReady=!0,a._readyArgs=[].slice.call(arguments,1);while(a==this.front()&&a._isReady)a._hasRun=!0,this.popFront(),a.onready.apply(a,a._readyArgs),a=this.front()}}),libx.utils.collections.DelayedActivityQueue=libx.core.Class.create(libx.utils.collections.ActivityQueue,{initialize:function(){this.parent(),this.scheduleLast(this)},onready:function(){}}),libx.utils.collections.EmptyActivity=libx.core.Class.create({onready:function(){}}),libx.utils.collections.FunctionActivity=libx.core.Class.create({initialize:function(a){this.fn=a},onready:function(){this.fn()}}),libx.buildDate="$builddate$",libx.version="$libxversion$";var a=new libx.utils.collections.ActivityQueue,b=new libx.utils.collections.EmptyActivity;libx.initialize=function(c){libx.initialize.reload=function(){delete libx.edition,delete libx.prefs,libx.preferences.initialize();var a=libx.utils.browserprefs.getStringPref("libx.edition.configurl",null);a&&libx.loadConfig(a)},a.scheduleLast(b),libx.events.addListener("DefaultLocaleLoaded",{onDefaultLocaleLoaded:function(){b.markReady()}}),libx.initialize.loadGlobalScripts=c,libx.locale.initialize(),libx.preferences.initialize();if(c){var d="updates.json.local",e=!1;libx.cache.defaultObjectCache.get({url:d,cacheOnly:!0,success:function(){e=!0},complete:function(){e||libx.cache.defaultObjectCache.get({url:libx.utils.getExtensionURL("bootstrapped/updates.json"),alias:d,dataType:"json",success:function(a){for(var b in a.files)libx.cache.defaultObjectCache.get({url:libx.utils.getExtensionURL("bootstrapped/"+b),alias:libx.utils.getBootstrapURL(b),dataType:"text"})}})}})}},libx.loadConfig=function(b){new libx.config.EditionConfigurationReader({url:b,onload:function(b){function e(a){if(libx.edition.options[a]==null)return;libx.utils.getEditionResource({url:libx.edition.options[a],success:function(b){libx.edition.options[a]=b}})}libx.edition=b,libx.log.write("Loaded configuration for edition: "+libx.edition.name["long"]);var c=[];libx.initialize.loadGlobalScripts&&c.push({url:libx.utils.browserprefs.getStringPref("libx.bootstrap.global.url",libx.utils.getBootstrapURL("bootstrapglobal.js"))});var d=libx.initialize.globalBootStrapper=new libx.bootstrap.BootStrapper(new libx.events.Event("GlobalBootstrapDone"));e("icon"),e("cueicon"),e("logo");var f={onready:function(){var a=new libx.events.Event("EditionConfigurationLoaded");a.edition=b,a.notify();for(var e=0;e<c.length;e++)d.loadScript(c[e].url,{libx:libx})}};a.scheduleLast(f),f.markReady()}})}}(),libx.version="2.0 (clientside)",libx.cs={proxy:function(a){return"../core/global/cs/proxy.php?url="+encodeURIComponent(a)},baseurl:"../../../"},libx.log={write:function(a,b){if(!b)b="LibX";else{var c="libx."+b.toLowerCase()+".debug";if(!libx.utils.browserprefs.getBoolPref("libx.all.debug",!1)&&!libx.utils.browserprefs.getBoolPref(c,!1))return}libx.log.bd.write(b+": "+a)},backtrace:function(a){libx.log.bd.backtrace(a)},bd:{write:libx.core.AbstractFunction("libx.log.bd.write"),backtrace:libx.core.AbstractFunction("libx.log.bd.write")}},libx.utils.binary=function(){function a(){}a.encoding=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],a.encode=function(b){var c=[],d=Math.floor(b.length/57),e=b.length%57,f=Math.floor(e/3),g=e%3,h=0,i;for(var k=0;k<d;k++)for(j=0;j<19;j++,h+=3)i=b[h]<<16|b[h+1]<<8|b[h+2],c.push(a.encoding[(i&16515072)>>18]),c.push(a.encoding[(i&258048)>>12]),c.push(a.encoding[(i&4032)>>6]),c.push(a.encoding[i&63]);for(k=0;k<f;k++,h+=3)i=b[h]<<16|b[h+1]<<8|b[h+2],c.push(a.encoding[(i&16515072)>>18]),c.push(a.encoding[(i&258048)>>12]),c.push(a.encoding[(i&4032)>>6]),c.push(a.encoding[i&63]);return g==1?(i=b[h]<<16,c.push(a.encoding[(i&16515072)>>18]),c.push(a.encoding[(i&258048)>>12]),c.push("==")):g==2&&(i=b[h]<<16|b[h+1]<<8,c.push(a.encoding[(i&16515072)>>18]),c.push(a.encoding[(i&258048)>>12]),c.push(a.encoding[(i&4032)>>6]),c.push("=")),c.join("")};var b=function(a,b,c){var d=a,e=b||0,f=0;this.getRawData=function(){return d},typeof a=="string"&&(f=c||d.length,this.getByteAt=function(a){return d.charCodeAt(a+e)&255}),this.getLength=function(){return f},this.getSByteAt=function(a){var b=this.getByteAt(a);return b>127?b-256:b},this.getShortAt=function(a,b){var c=b?(this.getByteAt(a)<<8)+this.getByteAt(a+1):(this.getByteAt(a+1)<<8)+this.getByteAt(a);return c<0&&(c+=65536),c},this.getSShortAt=function(a,b){var c=this.getShortAt(a,b);return c>32767?c-65536:c},this.getLongAt=function(a,b){var c=this.getByteAt(a),d=this.getByteAt(a+1),e=this.getByteAt(a+2),f=this.getByteAt(a+3),g=b?(((c<<8)+d<<8)+e<<8)+f:(((f<<8)+e<<8)+d<<8)+c;return g<0&&(g+=4294967296),g},this.getSLongAt=function(a,b){var c=this.getLongAt(a,b);return c>2147483647?c-4294967296:c},this.getStringAt=function(a,b){var c=[];for(var d=a,e=0;d<a+b;d++,e++)c[e]=String.fromCharCode(this.getByteAt(d));return c.join("")},this.getCharAt=function(a){return String.fromCharCode(this.getByteAt(a))},this.toBase64=function(){return window.btoa(d)},this.fromBase64=function(a){d=window.atob(a)}};return{binary2Base64:function(c){var d=new b(c),e=[];for(var f=0;f<d.getLength();f++)e[f]=d.getByteAt(f);return a.encode(e)}}}(),libx.storage={Store:libx.core.Class.create({initialize:function(a){this.prefix=a+"."},setItem:function(a){localStorage.setItem(this.prefix+a.key,a.value),a.success&&a.success()},getItem:function(a){var b=localStorage.getItem(this.prefix+a.key);b==null?a.notfound&&a.notfound():a.success&&a.success(b)},find:function(a){var b=[],c=a.pattern;c||(c=/.*/);for(var d in localStorage)if(d.indexOf(this.prefix)==0){var e=d.substr(this.prefix.length);c.test(e)&&b.push(e)}a.success&&a.success(b)},removeItem:function(a){var b=null;localStorage.removeItem(this.prefix+a.key),a.success&&a.success()},clear:function(a){for(var b in localStorage)b.indexOf(this.prefix)==0&&localStorage.removeItem(b);a&&a.success&&a.success()}})},libx.storage.metacacheStore=new libx.storage.Store("metacache"),libx.storage.cacheStore=new libx.storage.Store("cache"),libx.storage.prefsStore=new libx.storage.Store("prefs"),libx.preferences=function(){function c(a){libx.log.write(a,"preferences")}function f(a,b){var c;return b=="int"?c=new Number(a):b=="boolean"?a=="true"||a==1?c=!0:c=!1:c=a,c}var a=1,b="userprefs.xml",d=libx.core.Class.create({initialize:function(a){for(var b in a)this[b]=a[b]},_nodeType:null,_nodeToDescriptor:function(a){var b={};for(var c=0;c<a.attributes.length;c++){var d=a.attributes.item(c);b["_"+(d.localName||d.nodeName.replace("libx:",""))]=d.nodeValue}return b},toXML:function(){var a=new h;return a.visit(this),a.str}}),e=d.factory={};e.category=libx.core.Class.create(d,{_nodeType:"category",initialize:function(b,c,d){this._children=new Array,b==null&&d!=null&&(b=this._nodeToDescriptor(d)),this.parent(b),c!=null?this._idstr=c+"."+this._name:this._idstr=this._name,this._id=libx.utils.hash.hashString(this._idstr);if(d!=null)for(var e=0;e<d.childNodes.length;e++){var f=d.childNodes.item(e);f.nodeType==a&&this._addChild(null,f.localName||f.nodeName.replace("libx:",""),f)}},_addPreference:function(a){return this._addChild(a,"preference")},_addCategory:function(a){return this._addChild(a,"category")},_addChild:function(a,b,c){b==null&&(b=a._nodeType);if(a&&this[a._name]!=null)return this[a._name];var d=new e[b](a,this._idstr,c);return this[d._name]=d,this._children.push(d),d}}),e.preference=libx.core.Class.create(d,{_nodeType:"preference",initialize:function(b,c,d){b==null&&d!=null&&(b=this._nodeToDescriptor(d)),this.parent(b),this._idstr=c+"."+this._name,this._id=libx.utils.hash.hashString(this._idstr),this._type=="choice"?this._items=new Array:this._type=="multichoice"?(this._value=new Array,this._items=new Array):this._value=f(b._value,this._type);if(d!=null)for(var e=0;e<d.childNodes.length;e++){var g=d.childNodes.item(e);g.nodeType==a&&this._addItem(this._nodeToDescriptor(g))}},_setValue:function(a){var b=!1;if(this._type=="choice"){var d=this._items;for(var e=0;e<d.length;e++)a==d[e]._value&&(d[e]._selected=!0,this._value=a,b=!0);if(b){for(var e=0;e<d.length;e++)a!=d[e]._value&&(d[e]._selected=!1);return!0}return c("Invalid value for choice preference: "+this._name+" = "+a),!1}if(this._type=="multichoice"){var d=this._items;for(var e=0;e<a.length;e++){var f=!1;for(var g=0;g<d.length;g++)a[e]==d[g]&&(f=!0);if(f==0)return c("Invalid value for multichoice preference: "+this._name+" = "+a[e]),!1}for(var e=0;e<d.length;e++)d[e]._selected=!1;for(var e=0;e<a.length;e++)for(var g=0;g<d.length;g++)a[e]==d[g]&&(d[g]._selected=!0);return this._value=a,!0}return typeof a==typeof this._value?(this._value=a,!0):(c("Invalid value for preference: Expected "+typeof this._value+" but recieved "+typeof a),!1)},_addItem:function(a){var b=new e.item(a,this._idstr);this._type=="choice"?(this._items.push(b),b._selected&&(this._value!=null&&(c("Error: Multiple selected items found for preference: "+this._name),b._selected=!1),this._value=b._value)):this._type=="multichoice"?(this._items.push(b),b._selected&&this._value.push(b._value)):c("Error: An attempt was made to add an item to a "+this._type+" preference.")},_removeItem:function(a){for(var b=0;b<this._items.length;b++){var c=this._items[b];if(c._value==a){if(this._type=="choice"&&!c._selected)return this._items.splice(b,1),!0;if(this._type=="multichoice"){this._items.splice(b,1);for(var d=0;c._selected&&d<this._value.length;d++)if(this._value[d]==a){this._value.splice(d,1);break}return!0}}}return!1},toString:function(){return this._value}}),e.item=libx.core.Class.create(d,{_value:null,_type:null,_selected:null,_nodeType:"item",initialize:function(a,b,d){a==null&&d!=null&&c("ERROR: Item constructor called with a non-null node ( It shouldn't do that )"),this.parent(a),this._type==null&&this._type==typeof this._value,this._value=f(this._value,this._type),this._idstr=b+"."+this._value,this._id=libx.utils.hash.hashString(this._idstr),this._selected=f(this._selected,"boolean")},toString:function(){return this._value}});var g=libx.core.Class.create({visit:function(a){this[a._nodeType](a)},category:function(a){for(var b=0;a._children&&b<a._children.length;b++){var c=a._children[b];this[c._nodeType](c)}},item:function(a){},preference:function(a){for(var b=0;a._items&&b<a._items.length;b++){var c=a._items[b];this[c._nodeType](c)}}}),h=libx.core.Class.create(g,{str:'<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE category SYSTEM "http://libx.org/xml/libxprefs.dtd">\n',category:function(a){this.str+='<category name="'+libx.utils.xml.encodeEntities(a._name)+'" layout="'+libx.utils.xml.encodeEntities(a._layout)+'">\n',this.parent(a),this.str+="</category>\n"},item:function(a){this.str+='<item type="'+libx.utils.xml.encodeEntities(a._type)+'" value="'+libx.utils.xml.encodeEntities(a._value)+'" ',a._selected&&(this.str+='selected="'+libx.utils.xml.encodeEntities(a._selected)+'"'),this.str+="/>\n"},preference:function(a){this.str+='<preference name="'+libx.utils.xml.encodeEntities(a._name)+'" type="'+libx.utils.xml.encodeEntities(a._type)+'" ',a._type!="choice"&&(this.str+='value="'+libx.utils.xml.encodeEntities(a._value)+'"'),this.str+=" >\n",this.parent(a),this.str+="</preference>\n"}}),i=libx.core.Class.create(g,{initialize:function(a){this.matchf=a,this.matches=new Array},category:function(a){this.matchf(a)&&this.matches.push(a),this.parent(a)},item:function(a){this.matchf(a)&&this.matches.push(a)},preference:function(a){this.matchf(a)&&this.matches.push(a),this.parent(a)}});return{initialize:function(){libx.prefs=new e.category({_name:"prefs"},"libx"),libx.prefs._addCategory({_name:"contextmenu",_layout:"tree"}),libx.prefs.getCategoryForUrl=function(a,b){var c=this[a];c==null&&(c=this._addCategory({_name:a,_layout:"group"}));if(b!==undefined){var d=!1;for(var e=0;e<b.length;e++){var f=b[e];if(f.name in c)continue;d=!0;var g={_type:f.type,_name:f.name};"value"in f&&(g._value=f.value);var h=c._addPreference(g);if(f.type=="choice"&&"options"in f)for(var i=0;i<f.options.length;i++){var j=f.options[i];h._addItem({_type:"string",_value:j.value,_selected:j.selected==1})}}d&&libx.preferences.save()}return c};var a=new libx.utils.collections.ActivityQueue,b=new libx.utils.collections.EmptyActivity;a.scheduleLast(b);var c=new libx.utils.collections.EmptyActivity;a.scheduleLast(c);var d={onready:function(){var a=new libx.events.Event("PreferencesLoaded");a.notify()}};a.scheduleLast(d),d.markReady(),libx.preferences.load({filename:libx.utils.getBootstrapURL("preferences/builtin/browser.prefs.xml"),overwrite:!1,base:"libx.prefs",callback:function(){b.markReady()}}),this.loadUserPrefs(function(){c.markReady()})},loadUserPrefs:function(a){var c=this;libx.storage.prefsStore.getItem({key:b,success:function(d){var e=libx.utils.xml.loadXMLDocumentFromString(d).documentElement;c.loadXML(e,{filename:b,overwrite:!0,base:"libx"}),a&&a()},notfound:function(){a&&a()}})},load:function(a){var b=a.filename,d=a.overwrite,e=a.base;c("loading: "+b+" overwrite="+d+" and base="+e);var f=this.loadXML;libx.cache.defaultObjectCache.get({validator:libx.cache.validators.preference,type:"GET",url:b,dataType:"xml",success:function(b){f(b.documentElement,a)},error:function(a){libx.log.write("libx.preferences.load(): error "+a+" loading preference file "+b)},complete:function(){a.callback&&a.callback()}})},loadXML:function(a,b){function k(a,b,d){if(a==null){libx.prefs._addChild(b);return}a._nodeType!=b._nodeType&&c("XMLPreferences.loadUser.loadUserHelper","Mismatching node types detected. ["+a._nodeType+", "+b._nodeType+"]");if(a._nodeType=="category"){for(var e=0;e<a._children.length;e++){var f=a._children[e];for(var g=0;g<b._children.length;g++){var h=b._children[g];f._id==h._id&&k(f,h,d)}}for(var e=0;e<b._children.length;e++){var h=b._children[e],i=!1;for(var g=0;g<a._children.length;g++){var f=a._children[g];f._id==h._id&&(i=!0)}i==0&&(a._children.push(h),a[h._name]=h)}}else if(a._nodeType=="preference"){d&&(a._value=b._value,a._type=b._type);if(a._items&&a._items.length>0)for(var e=0;e<a._items.length;e++){var j=a._items[e];for(var g=0;g<b._items.length;g++){var l=b._items[g];j._id==l._id&&k(j,l,d)}}if(b._items&&b._items.length>0){a._items||(a._items=[]);for(var e=0;e<b._items.length;e++){var l=b._items[e],i=!1;for(var g=0;g<a._items.length;g++){var j=a._items[g];j._id==l._id&&(i=!0)}i==0&&a._items.push(l)}}}else a._nodeType=="item"?d&&(a._selected=b._selected):c("XMLPreferences.loadUser.loadUserHelper","Invalid node type - "+a._nodeType)}var d=b.overwrite,f=b.base,g=new(e[a.localName||a.nodeName.replace("libx:","")])(null,f,a);b.prefs==null&&(b.prefs=g);var h=libx.preferences.get(g._idstr);if(h!=null)k(h,g,d);else{var i=null;f==null&&(f="libx.prefs");var j=libx.preferences.get(f);(j==null||j._nodeType!="category")&&c("loadXML","Invalid base category specified: "+f),j[g._name]==null?(j[g._name]=g,j._children.push(g)):k(j,g,d)}},save:function(){var a=new h;a.visit(libx.prefs),libx.storage.prefsStore.setItem({key:b,value:a.str})},get:function(a){if(a=="libx.prefs")return libx.prefs;var b=this.getByID(libx.utils.hash.hashString(a));return b},getValue:function(a,b){var d=this.get(a);return d!=null&&d._nodeType=="preference"?d._value:(d!=null&&d._nodeType!="preference"&&c("getValue","Error: Attempt to retrieve preference "+a+" but recieved "+d._nodeType),b)},getByID:function(a){if(a==libx.utils.hash.hashString("libx.prefs"))return libx.prefs;var b=new i(function(b){return a==b._id});return b.visit(libx.prefs),b.matches.length>1&&c("getByID","More then one match found for id: "+a),b.matches[0]},XMLPreferenceObject:d}}(),libx.cache.MemoryCache=function(){function a(a){var b=a.status;b==null&&(b=a.xmlHttpReq.status);if(b==200||a.result&&b==0)for(var c=0;c<a.requests.length;++c)typeof a.requests[c].success=="function"&&a.requests[c].success(a.result,b,a.xmlHttpReq,a.text);else for(var c=0;c<a.requests.length;++c)typeof a.requests[c].error=="function"&&a.requests[c].error(a.result,b,a.xmlHttpReq,a.text);for(var c=0;c<a.requests.length;++c)typeof a.requests[c].complete=="function"&&a.requests[c].complete(a.result,b,a.xmlHttpReq,a.text)}var b=libx.core.Class.create({initialize:function(a){a==null&&(a=50),this.xhrCache=new c(a)},flush:function(){this.xhrCache.flush()},buildKeyString:function(a){var b="";b+=a.url;if(a.header!==undefined)for(var c in a.header)c!="If-Modified-Since"&&(b+=","+c+"="+a.header[c]);return a.serverMIMEType!==undefined&&(b+=",MIMEType="+a.serverMIMEType),b},validateParameter:function(a){var b={type:"GET",async:!0,data:null,bypassCache:!1};for(var c in b)a[c]===undefined&&(a[c]=b[c]);if(a.type!="GET"&&a.type!="POST")throw"In MemoryCache: Invalid request type: "+a.type},removeFromCache:function(a){this.validateParameter(a);var b=this.buildKeyString(a),c=this.xhrCache.findNode(b);c!==undefined&&this.xhrCache.removeFromCache(c)},get:function(b){var c=this;this.validateParameter(b);var d=this.buildKeyString(b),e="",f=this.xhrCache.findNode(d);if(!b.bypassCache&&f!==undefined){var g=f.data.xhr;return g.readyState==4?(a({xmlHttpReq:g,requests:[b],result:f.result,text:f.text}),this.xhrCache.moveToFront(f)):this.xhrCache.addRequest(f,b),g}var h=libx.cache.bd.getXMLHttpReqObj();try{h.open(b.type,b.url,b.async)}catch(i){return libx.log.write("error in XMLHTTPRequest.open for: "+b.type+" "+b.url+"\n"+i),typeof b.error=="function"&&b.error(i.toString(),h.status,h),h}var j=this.xhrCache,k=/\.(jpg|jpeg|tiff|gif|ico|bmp|png|webp)$/i.test(b.url);b.serverMIMEType!==undefined?h.overrideMimeType&&h.overrideMimeType(b.serverMIMEType):k?h.overrideMimeType&&h.overrideMimeType("text/plain; charset=x-user-defined"):b.dataType=="text"&&h.overrideMimeType&&h.overrideMimeType("text/plain");var l=function(){if(h.readyState==4){var g=h.responseText,i=h.getResponseHeader("Content-Type");if(b.dataType=="xml")e=h.responseXML;else if(k)g=libx.utils.binary.binary2Base64(g),e="data:"+i+";base64,"+g;else if(b.dataType=="text")e=h.responseText;else if(b.dataType=="json")try{e=libx.utils.json.parse(h.responseText)}catch(l){e=null}else e=h.responseBody||h.responseText;function m(){f=j.findNode(d),h.status==200||e&&h.status==0?f&&(f.data.xhr=h,f.result=e,f.text=g):f&&!b.bypassCache&&j.removeFromCache(f),a({xmlHttpReq:h,requests:b.bypassCache?[b]:f.data.requests,result:e,text:g})}!/^chrome.*:\/\//.test(b.url)&&h.status==200&&b.validator?b.validator.call(c,{url:b.url,data:e,text:g,mimeType:i,success:function(){m()},error:function(){a({xmlHttpReq:h,requests:[b],result:e,status:"failedvalidation",text:g})}}):m()}};(!b.header||!b.header["If-Modified-Since"])&&h.setRequestHeader("If-Modified-Since","0");if(b.header!==undefined)for(headerName in b.header)h.setRequestHeader(headerName,b.header[headerName]);b.bypassCache||j.addToCache(d,h,b),b.async&&(h.onreadystatechange=l);try{h.send(b.data)}catch(m){typeof b.error=="function"&&b.error(m.toString(),h.status,h)}return b.async||l(),h}}),c=libx.core.Class.create({initialize:function(a){this.maxSize=a,this.cacheList=new libx.utils.collections.LinkedList,this.cacheTable={},this.cacheLength=0},removeFromCache:function(a){this.cacheList.remove(a),delete this.cacheTable[a.data.key],--this.cacheLength},addToCache:function(a,b,c){var d=this.cacheTable[a];if(d!==undefined)return d.data.requests.push(c),this.cacheList.remove(d),this.cacheList.pushFront(d),d;if(this.cacheLength>=this.maxSize){var d=this.cacheList.rbegin();while(d!==this.cacheList.rend()){if(d.data.xhr.readyState==4){this.removeFromCache(d);break}d=d.prev}}var e={data:{xhr:b,key:a,requests:[c]}};return this.cacheList.pushFront(e),this.cacheTable[a]=e,++this.cacheLength,e},findNode:function(a){return this.cacheTable[a]},moveToFront:function(a){this.cacheList.remove(a),this.cacheList.pushFront(a)},addRequest:function(a,b){a.data.requests.push(b),this.moveToFront(a)},flush:function(){this.initialize(this.maxSize)}});return b}(),libx.cache.bd={getXMLHttpReqObj:libx.core.AbstractFunction("libx.cache.bd.getXMLHttpReqObj")},libx.cache.defaultMemoryCache=new libx.cache.MemoryCache,libx.config={},libx.config.NameableItemArray={getByName:function(a){for(var b=0;b<this.length;b++)if(this[b].name==a)return this[b];return null}},libx.config.XMLConfigWrapper=libx.core.Class.create({initialize:function(a){this.xml=a},getNode:function(a){return libx.utils.xpath.findSingleXML(this.xml,a)},getAttr:function(a,b){var c=this.getNode(a);return c?c.getAttribute(b):null},copyAttributes:function(a,b){for(var c=0;c<a.attributes.length;c++){var d=a.attributes.item(c),e=libx.utils.types.normalize(d.nodeValue);e!=null&&(b[d.nodeName]=e)}}}),libx.config.EditionConfigurationReader=libx.core.Class.create({initialize:function(a){var b=this;libx.cache.defaultObjectCache.get({dataType:"xml",url:a.url,validator:libx.cache.validators.config,success:function(c,d){var e=new libx.config.XMLConfigWrapper(c),f={};f.openurl=b.loadResolvers(e),f.catalogs=b.loadCatalogs(e,f),f.proxy=b.loadProxies(e),f.options=b.loadOptions(e),f.links=b.loadLinks(e),f.searchoptions=b.loadSearchOptions(e),f.localizationfeeds=b.loadLocalizationFeeds(e),f.name={},e.copyAttributes(e.getNode("/edition/name"),f.name),e.copyAttributes(e.getNode("/edition"),f),b.loadContextMenuPrefs("Google Scholar","magicsearch",f.options.magicsearchincontextmenu?"magicsearch":""),a.onload(f)},error:function(b){libx.log.write("error "+b+" loading configuration file "+a.url)}})},makeConfigurationItemArray:function(a,b,c,d,e){var f=new Array;libx.core.Class.mixin(f,libx.config.NameableItemArray);var g=libx.utils.xpath.findNodesXML(a.xml,b);for(var h=0;h<g.length;h++){var i=g[h],j={};if(c!=null){var k=d(i);if(typeof c[k]!="function"){libx.log.write("Factory key "+k+" not supported.");continue}j=new c[k],j.type=k}a.copyAttributes(i,j),e(i,j),f.push(j)}return f.primary=f[0],f},loadLocalizationFeeds:function(a){var b={"package":[],bootglobal:[],bootwindow:[]};return this.makeConfigurationItemArray(a,"/edition/localizationfeeds/*[@type != 'legacy']",null,libx.core.EmptyFunction,function(a,c){switch(a.nodeName){case"whitelist":b.whitelist=c;break;case"feed":b[c.type].push(c)}}),b["package"].length||b["package"].push({url:libx.config.EditionConfigurationReader.defaultpkgURL}),b},loadSearchOptions:function(a){var b={Y:"Keyword",t:"Title",jt:"Journal Title",at:"Article Title",a:"Author",d:"Subject",m:"Genre",i:"ISBN/ISSN",c:"Call Number",j:"Dewey Call Number",doi:"DOI",pmid:"PubMed ID",xisbn:"xISBN",magicsearch:"Magic Search"};return this.makeConfigurationItemArray(a,"/edition/searchoptions/*",null,libx.core.EmptyFunction,function(a,c){b[c.value]=c.label}),b},loadLinks:function(a){return this.makeConfigurationItemArray(a,"/edition/links/*",null,libx.core.EmptyFunction,libx.core.EmptyFunction)},loadOptions:function(a){var b={autolinkstyle:"1px dotted"},c=libx.utils.xpath.findNodesXML(a.xml,"/edition/options/option");for(var d=0;d<c.length;d++)b[c[d].getAttribute("key")]=libx.utils.types.normalize(c[d].getAttribute("value"));return b},loadCatalogs:function(a,b){var c=this;return this.makeConfigurationItemArray(a,"/edition/catalogs/*",libx.catalog.factory,function(a){return a.nodeName},function(d,e){var f=libx.utils.xpath.findSingleXML(a.xml,"xisbn",d);if(f){var g=new Object;for(var h in e.xisbn)g[h]=e.xisbn[h];e.xisbn=g,a.copyAttributes(f,e.xisbn),d.nodeName!="bookmarklet"&&c.loadContextMenuPrefs(e.name,"xisbn",e.xisbn.includeincontextmenu?"xisbn":"")}e.urlregexp=new RegExp(e.urlregexp),typeof e.__init=="function"&&e.__init(b),c.loadContextMenuPrefs(e.name,e.options,e.contextmenuoptions),libx.log.write("registered "+e.name+" (type="+d.nodeName+", options="+e.options+")")})},loadResolvers:function(a){var b=this;return this.makeConfigurationItemArray(a,"/edition/openurl/*",libx.openurl.factory,function(a){return a.getAttribute("type")},function(a,c){var d=c.includeincontextmenu?"enabled":"";b.loadContextMenuPrefs(c.name,"enabled",d),libx.log.write("registered OpenURL resolver "+c.name+" (type="+a.getAttribute("type")+")")})},loadProxies:function(a){var b=this;return this.makeConfigurationItemArray(a,"/edition/proxy/*",libx.proxy.factory,function(a){return a.nodeName},function(a,c){var d=c.includeincontextmenu?"enabled":"";b.loadContextMenuPrefs(c.name,"enabled",d),c.type=a.nodeName})},loadContextMenuPrefs:function(a,b,c){var d=libx.prefs.contextmenu._addCategory({_name:a,_layout:"tree"});b=b.split(";"),c?c=c.split(";"):c=[];for(var e=0;e<b.length;e++){var f=b[e],g=!1;for(var h=0;h<c.length;h++)c[h]==f&&(g=!0);d._addPreference({_name:f,_type:"boolean",_value:g})}}}),libx.config.EditionConfigurationReader.defaultpkgURL="$defaultpkgURL$",function(){var a={};libx.events={Event:libx.core.Class.create({initialize:function(a,b){this.eventName=a,this.eventWindow=b},notify:function(){var b=[].splice.call(arguments,0),c=a[this.eventName]||[];for(var d=0;d<c.length;d++)if(this.eventWindow==undefined||this.eventWindow==c[d].window)try{c[d].handler["on"+this.eventName].apply(c[d].handler,[this].concat(b))}catch(e){libx.log.write("Exception in event handler: "+e,"events")}}}),registerEventListener:function(a,b,c,d,e){libx.events.addListener(a,b,d,e);var f=c(a);f!=null&&b["on"+a](f)},addListener:function(b,c,d,e){var f=a[b];f==undefined&&(f=a[b]=[]);if(e!=undefined)for(var g=0;g<f.length;g++)if(f[g].id==e&&f[g].window==d){f.splice(g,1);break}a[b].push({handler:c,window:d,id:e})},removeListener:function(b,c,d){if(!b in a)return;var e=a[b];for(var f=0;f<e.length;f++)(d==e[f].id||d==undefined)&&(c==e[f].window||c==undefined)&&e.splice(f,1)}}}(),function(){function f(a){return a<10?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return typeof b=="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g=gap,h,i=b[a];i&&typeof i=="object"&&typeof i.toJSON=="function"&&(i=i.toJSON(a)),typeof rep=="function"&&(i=rep.call(b,a,i));switch(typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";gap+=indent,h=[];if(Object.prototype.toString.apply(i)==="[object Array]"){f=i.length;for(c=0;c<f;c+=1)h[c]=str(c,i)||"null";return e=h.length===0?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]",gap=g,e}if(rep&&typeof rep=="object"){f=rep.length;for(c=0;c<f;c+=1)d=rep[c],typeof d=="string"&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e))}else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));return e=h.length===0?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}",gap=g,e}}var JSON={};libx.utils.json=JSON,typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(a){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(a,b,c){var d;gap="",indent="";if(typeof c=="number")for(d=0;d<c;d+=1)indent+=" ";else typeof c=="string"&&(indent=c);rep=b;if(!b||typeof b=="function"||typeof b=="object"&&typeof b.length=="number")return str("",{"":a});throw new Error("JSON.stringify")}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&typeof e=="object")for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),d!==undefined?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString
(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),libx.bootstrap={},libx.bootstrap.BootStrapper=libx.core.Class.create({initialize:function(a){this.eventToFireWhenFinished=a,this.scriptQueue=new libx.utils.collections.ActivityQueue,this.url2UpdateListener={},this.hasFinished=!1},loadScript:function(a,b,c){var d=this,e={onready:function(e){var f={bootStrapper:{baseURL:a.match(/.*\//),finish:function(){d.finish()},loadScript:function(a){return d.loadScript(a,f,c)}}};libx.core.Class.mixin(f,b,!0),libx.bootstrap.loadSubScript(a,e,f,c)}};this.scriptQueue.scheduleLast(e),libx.cache.defaultObjectCache.get({validator:libx.cache.validators.bootstrapped,url:a,success:function(a){e.markReady(a)},error:function(b){libx.log.write("error "+b+" loading script "+a)}})},finish:function(){var a=this,b={onready:function(){a.hasFinished=!0,a.eventToFireWhenFinished!=null&&a.eventToFireWhenFinished.notify()}};this.scriptQueue.scheduleLast(b),b.markReady()}}),libx.cs.browser={},function(){var a=/(webkit)[ \/]([\w.]+)/,b=/(opera)(?:.*version)?[ \/]([\w.]+)/,c=/(msie) ([\w.]+)/,d=/(chrome)[ \/]([\w.]+)/,e=/(mozilla)(?:.*? rv:([\w.]+))?/,f=window.navigator.userAgent.toLowerCase(),g=d.exec(f)||a.exec(f)||b.exec(f)||c.exec(f)||f.indexOf("compatible")<0&&e.exec(f)||[];g[1]&&(libx.cs.browser[g[1]]=!0,libx.cs.browser.version=g[2]||"0"),libx.cs.browser.webkit&&(libx.cs.browser.safari=!0)}(),libx.log.bd={write:function(a){console.log(a)},backtrace:function(a){throw new Error("libx.log.bd.backtrace() is not supported")}},libx.cache.bd={getXMLHttpReqObj:function(){var a=null;if(libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla)try{a=new XMLHttpRequest}catch(b){libx.log.write("Unable to create XMLHttpRequest object"),a=undefined}else if(libx.cs.browser.msie)try{window.XMLHttpRequest?a=new XMLHttpRequest:window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"))}catch(b){libx.log.write("Unbale to create XMLHttpRequest object for IE, "+b.message),a=undefined}else libx.log.write("Error - Unknown Browser! Check for appropriate feature support for getXMLHttpReqObj"),a=undefined;if(!a&&window.createRequest)try{a=window.createRequest()}catch(c){a=!1}if(a){var d=a.open;a.open=function(b,c,e,f,g){var h=c.match(/:\/\/(.[^/]+)/);h==null||h[1]==document.domain?d.apply(a,[b,c,e,f,g]):d.apply(a,[b,libx.cs.proxy(c),e,f,g])}}else libx.log.write("Error: In libx.cache.bd.getXMLHttpReqObj xmlhttprequest is undefined.");return a}},function(){libx.utils.timer.setInterval=function(a,b){setInterval(a,b)},libx.utils.timer.setTimeout=function(a,b){setTimeout(a,b)}}(),libx.utils.xml.loadXMLDocumentFromString=function(a){var b,c;try{libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla?(c=new DOMParser,b=c.parseFromString(a,"text/xml")):libx.cs.browser.msie?(b=new ActiveXObject("Msxml2.DOMDocument.3.0"),b.setProperty("SelectionLanguage","XPath"),b.async="false",b.loadXML(a)):(libx.log.write("Error - Unknown Browser! Check for appropriate feature support for libx.utils.xml.loadXMLDocumentFromString"),b=undefined)}catch(d){b=undefined}if(!b)libx.log.write("Invalid XML [reason:] xml is "+b+" \n[xmlstring]:\n"+a);else if(!b.documentElement||b.getElementsByTagName("parsererror").length){var e=b.getElementsByTagName("parsererror").context.parseError;libx.log.write("Invalid XML [reason]: \n"+e.reason+"\n[srcText]: \n"+e.srcText+"\n[url]: \n"+e.url+"\n[xmlstring]: \n"+a)}return b},libx.utils.xml.convertXMLDocumentToString=function(a){var b,c;try{libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla?(c=new XMLSerializer,b=c.serializeToString(a)):libx.cs.browser.msie?b=a.xml:(libx.log.write("Error - Unknown Browser! Check for appropriate feature support for libx.utils.xml.convertXMLDocumentToString"),b=undefined)}catch(d){b=undefined}return b||libx.log.write("Error converting xml to string"),b},libx.bootstrap.loadSubScript=function(url,scriptData,globalScope){libx.log.write("loading ("+url+")"),function(){with(globalScope)eval(scriptData)}()},function(){function c(c,d){var e=b[a+c];return typeof e!="undefined"&&e!=null?e:d}function d(c,d){b[a+c]=d}var a="browserprefs.",b=localStorage;libx.core.Class.mixin(libx.utils.browserprefs,{setStore:function(a){b=a},getBoolPref:function(a,b){return c(a,b).toString()=="true"},getStringPref:function(a,b){return c(a,b)},getIntPref:function(a,b){return parseInt(c(a,b))},setBoolPref:function(a,b){d(a,Boolean(b))},setStringPref:function(a,b){d(a,String(b))},setIntPref:function(a,b){d(a,parseInt(b))}})}(),function(){function b(a,b){if(a){var c=b.indexOf("?");b=c==-1?b:b.substr(0,c)}return b}function c(c,d){var e={},f=this;d==a.UPDATE&&c.metadata&&c.metadata.lastModified!=null&&(e["If-Modified-Since"]=c.metadata.lastModified);var g=b(c.ignoreQuery,c.alias||c.url);libx.cache.defaultMemoryCache.get({header:e,url:c.url,dataType:c.dataType,validator:c.validator,serverMIMEType:c.serverMIMEType,bypassCache:d==a.UPDATE,error:function(b,d,e){a.UPDATE&&d==304?(c.metadata.lastAccessed=Date.now(),c.metadata.expired=!1,f.putMetadata({url:g,metadata:c.metadata,success:function(){c.complete&&c.complete()}})):(c.error&&c.error(d),c.complete&&c.complete())},success:function(a,b,d,e){function k(b,c){libx.storage.cacheStore.setItem({key:g,value:e,success:function(){f.putMetadata({url:g,metadata:i,success:function(){b&&b(a,i,d),c&&c()}})}})}var h=d.getResponseHeader("Content-Type"),i={lastAccessed:Date.now(),lastModified:d.getResponseHeader("Last-Modified"),mimeType:h,sha1:libx.utils.hash.hashString(e),expired:!1},j=/\.(jpg|jpeg|tiff|gif|ico|bmp|png|webp)$/i.test(c.url);j&&(a=e="data:"+h+";base64,"+e),c.delayWrite?(c.delayWrite(k),c.success&&c.success(a,i,d),c.complete&&c.complete()):k(c.success,c.complete)}})}var a={GET:1,UPDATE:2};libx.cache.ObjectCache=libx.core.Class.create({initialize:function(){this.cachedRequests=new Array},get:function(d){var e=this,f=d.alias||d.url;if(/^chrome.*:\/\//.test(f)){libx.cache.defaultMemoryCache.get(d);return}this.getMetadata({url:f,success:function(g){function h(){libx.storage.cacheStore.getItem({key:b(d.ignoreQuery,f),success:function(a){var b;switch(d.dataType){case"json":b=libx.utils.json.parse(a);break;case"xml":b=libx.utils.xml.loadXMLDocumentFromString(a);break;default:b=a}d.success&&d.success(b,g),d.complete&&d.complete()},notfound:function(){c.call(e,d,a.GET)}})}if(g.expired&&!d.cacheOnly){var i=!1;e.update({url:d.url,alias:d.alias,metadata:g,ignoreQuery:d.ignoreQuery,validator:d.validator,success:function(a,b,c){i=!0,d.success&&d.success(a,b,c)},error:h,complete:function(){if(i){d.complete&&d.complete();return}h()}})}else h()},notfound:function(){d.cacheOnly?d.complete&&d.complete():c.call(e,d,a.GET)}})},getMetadata:function(a){var c=b(a.ignoreQuery,a.url);libx.storage.metacacheStore.getItem({key:c,success:function(b){a.success&&a.success(libx.utils.json.parse(b))},notfound:a.notfound})},putMetadata:function(a){var c=b(a.ignoreQuery,a.url);libx.storage.metacacheStore.setItem({key:c,value:libx.utils.json.stringify(a.metadata),success:a.success})},purgeAll:function(){libx.storage.cacheStore.clear()},update:function(b){c.call(this,b,a.UPDATE)}}),libx.cache.defaultObjectCache=new libx.cache.ObjectCache}(),libx.locale=function(){return StringBundle=libx.core.Class.create({initialize:function(a){this.l10ns=a},getProperty:function(a){var b=null;for(var c=0;c<this.l10ns.length;c++){b=this.l10ns[c][a];if(b)break}if(b==null)return libx.log.write("Property '"+a+"' not found"),"["+a+"]";var d=b.message;if(arguments.length>1){var e=arguments;d=d.replace(/\$([a-zA-Z0-9_]+)\$/g,function(a,c){var d=b.placeholders[c];if(!d)throw new Error("placeholder '"+c+"' not defined.");return d.content.replace(/(.?)\$([0-9])/g,function(a,b,c){if(b=="$")return"$"+c;var d=e[parseInt(c)];return d?b+d:""})})}return d}}),{StringBundle:StringBundle,bd:{},initialize:function(){libx.locale.bd.initialize()},getBundle:function(a){function c(a){for(var c=0;c<b.length;c++)if(b[c]==a)return;b.push(a)}function g(c){for(var d=0;d<b.length;d++){var g={onready:function(a){a&&f.push(a)}};e.scheduleLast(g),c(b[d],g)}var h={onready:function(){a.success(new StringBundle(f))}};e.scheduleLast(h),h.markReady()}var b=[];c(libx.locale.bd.currentLocale);var d=libx.locale.bd.currentLocale.indexOf("_");a.defaultLocale&&c(a.defaultLocale);var e=new libx.utils.collections.ActivityQueue,f=[];if(a.url)g(function(b,c){libx.cache.defaultObjectCache.get({validator:function(a){function b(){for(var b in a.data)if(!1 in a.data[b])return!1;return!0}/json/.test(a.mimeType)&&b()?a.success():a.error()},dataType:"json",url:a.url.replace(/\$locale\$/,b),error:function(b){c.markReady(),b!=404&&a.error&&a.error(b)},success:function(a){c.markReady(a)}})});else if(a.object)g(function(b,c){b in a.object?c.markReady(a.object[b]):c.markReady()});else{function h(a){a.defaultLocale&&c(a.defaultLocale),g(function(b,c){b in a.locales?c.markReady(libx.utils.json.parse(a.locales[b])):c.markReady()})}(new libx.libapp.PackageWalker(a.feed)).walk({onpackage:h,onmodule:h,onlibapp:h})}}}}(),function(){var a;try{libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla?a=window.navigator.language:libx.cs.browser.msie?a=window.navigator.userLanguage:(libx.log.write("Error - Unknown Browser! Check for appropriate feature support for setting default locale string from windown.navigator object"),xml=undefined),a=a.split("-"),a=a[0].toLowerCase()+"_"+a[1].toUpperCase()}catch(b){a="en_US",libx.log.write("Error processing locale info: "+b)}libx.locale.bd.currentLocale=a}(),libx.locale.bd.initialize=function(){libx.locale.getBundle({url:libx.cs.baseurl+"src/base/locale/en_US/messages.json",defaultLocale:"en_US",success:function(a){libx.locale.defaultStringBundle=a;var b=new libx.events.Event("DefaultLocaleLoaded");b.notify()},error:function(a){libx.log.write("Failed to get locale bundle in client side for "+this.url+" \nError: "+a)}})},function(){function f(){var a;try{a=libx.utils.json.parse(libx.utils.browserprefs.getStringPref("libx.libapp.userpackages","[]"))}catch(b){a=[],libx.utils.browserprefs.setStringPref("libx.libapp.userpackages","[]")}return a}function g(a,c){libx.prefs.getCategoryForUrl(a.id,[{name:"_enabled",type:"boolean",value:"true"}]);if(libx.prefs[a.id]._enabled._value){if(a.override){var d=a.override,e=a.id;b[d]||(b[d]={}),b[d][e]=1}c&&c()}}var a=[],b=null,c=null,d=null,e=[];libx.libapp.clearTempPackages=function(){a=[]},libx.libapp.addTempPackage=function(b,c){for(var d=0;d<a.length;d++)if(a[d].tempUrl==c)return;a.push({permUrl:b,tempUrl:c})},libx.libapp.getTempPackages=function(){return a},libx.libapp.removeTempPackage=function(b){for(var c=0;c<a.length;c++)if(a[c].tempUrl==b)return a.splice(c,1),!0;return!1},libx.libapp.removeUserPackage=function(a){var b=f(),c=b.indexOf(a);return c<0?!1:(b.splice(c,1),libx.utils.browserprefs.setStringPref("libx.libapp.userpackages",libx.utils.json.stringify(b)),!0)},libx.libapp.addUserPackage=function(a){if(this.getPackages().indexOf(a)>=0)return!1;var b=f();return b.push(a),libx.utils.browserprefs.setStringPref("libx.libapp.userpackages",libx.utils.json.stringify(b)),!0},libx.libapp.getPackages=function(b){if(!c){c=[],libx.edition.localizationfeeds["package"].forEach(function(a){c.push(a.url)});var e=f();e.forEach(function(a){c.indexOf(a)<0&&c.push(a)})}if(!b)return c;if(!d){d=c.filter(function(b){for(var c=0;c<a.length;c++)if(a[c].permUrl==b)return!1;return!libx.prefs[b]||libx.prefs[b]._enabled._value});for(var g=0;g<a.length;g++)d.push(a[g].tempUrl)}return d},libx.libapp.reloadPackages=function(){c=null,d=null,libx.libapp.clearOverridden();for(var a;a=e.pop();)a.stopScheduling();this.getPackages(!0).forEach(function(a){var b=new libx.cache.PackageScheduler(a);b.scheduleUpdates(!0),e.push(b)})},libx.libapp.clearOverridden=function(){b=null},libx.libapp.getOverridden=function(a){function d(a){a.forEach(function(a){var b=new libx.utils.collections.EmptyActivity;c.scheduleFirst(b),(new libx.libapp.PackageWalker(a.url)).walk({onpackage:function(a){g(a,function(){d(a.entries)}),b.markReady()},onlibapp:function(a){g(a),b.markReady()},error:function(){b.markReady()}},b)})}var c=new libx.utils.collections.ActivityQueue;if(b)a(b);else{b={};var e=this.getPackages(!0).map(function(a){return{url:a}});d(e),callbackAct={onready:function(){a(b)}},c.scheduleLast(callbackAct),callbackAct.markReady()}};var h=new libx.utils.collections.ActivityQueue,i=new libx.utils.collections.EmptyActivity;h.scheduleLast(i),libx.events.addListener("PreferencesLoaded",{onPreferencesLoaded:function(){i.markReady()}}),libx.events.addListener("GlobalBootstrapDone",{onGlobalBootstrapDone:function(){var a={onready:function(){libx.libapp.reloadPackages()}};h.scheduleLast(a),a.markReady()}})}(),libx.cache.validators={config:function(a){if(!/xml/.test(a.mimeType)){a.error(),libx.log.write("Validation error: invalid MIME type for config XML: "+a.mimeType+" at "+a.url);return}libx.utils.xpath.findSingleXML(a.data,"//edition/name")?a.success():(a.error(),libx.log.write("Validation error: edition name not found in config XML"))},bootstrapped:function(a){var b=libx.utils.getBootstrapURL("");if(a.url.indexOf(b)!=0){a.success();return}this.get({url:libx.utils.getBootstrapURL("updates.json"),dataType:"json",success:function(c){var d=a.url.replace(b,""),e=libx.utils.hash.hashString(a.text);c.files&&c.files[d]&&c.files[d].hash==e?a.success():(a.error(),c.files&&c.files[d]?libx.log.write("Validation error: SHA1 mismatch; updates.json expected: "+c.files[d].hash+", actual: "+e):libx.log.write("Validation error: invalid updates.json"))},error:function(b){a.error(),libx.log.write("Error "+b+" when fetching updates.json")}})},feed:function(a){if(!/xml/.test(a.mimeType)){a.error(),libx.log.write("Validation error: invalid MIME type for atom feed: "+a.mimeType);return}libx.utils.xpath.findSingleXML(a.data,"//libx:package|//libx:libapp|//libx:module",null,{libx:"http://libx.org/xml/libx2"})?a.success():(a.error(),libx.log.write("Validation error: no package, module, or libapp node found in feed"))},preference:function(a){if(!/xml/.test(a.mimeType)){a.error(),libx.log.write("Validation error: invalid MIME type for pref XML: "+a.mimeType);return}libx.utils.xpath.findSingleXML(a.data,"//item|//preference|//category")?a.success():(a.error(),libx.log.write("Validation error: no item, preference, or category node found in XML"))},image:function(a){/image/.test(a.mimeType)?a.success():(a.error(),libx.log.write("Validation error: invalid MIME type for image: "+a.mimeType+" at "+a.url+" data"+a.data))}},libx.utils.getBootstrapURL=function(a){return"$bootstrapURL$"+a},libx.utils.getEditionResource=function(a){var b="chrome://libx/skin";if(a.url.substr(0,b.length)!=b){a.success&&a.success(a.url),a.complete&&a.complete();return}var c=libx.utils.browserprefs.getStringPref("libx.edition.configurl","").replace("/config.xml","")+a.url.replace(b,"");libx.cache.defaultObjectCache.get({url:c,dataType:"text",validator:libx.cache.validators.image,success:a.success,error:a.error,complete:a.complete})},libx.utils.getEditionPath=function(a){return a[0]>="a"&&a[0]<="z"?a:a.substr(0,2)+"/"+a.substr(2,2)+"/"+a},libx.utils.getBootstrapURL=function(a){return libx.cs.baseurl+"src/base/bootstrapped/"+a},libx.utils.getExtensionURL=function(a){return libx.cs.baseurl+"src/base/"+a},libx.utils.browserType=function(){var a=window.navigator.userAgent.toLowerCase();return/firefox/.test(a)?"ff":/msie/.test(a)?"ie":/chrome/.test(a)?"gc":/safari/.test(a)?"sa":/opera/.test(a)?"op":"unknown"},function(){function f(a){try{return a.match(/.*\//)[0]}catch(b){libx.log.write("scheduler: error getting feed path for "+a)}}function g(a){libx.log.write(a,"scheduler")}var a=864e5,b=6e4,c=144e5,d=144e5,e=!1;libx.cache.Scheduler=libx.core.Class.create({initialize:function(e){this.rootUrl=e,this.updateInterval=a,this.initialRetryInterval=b,this.maxRetryInterval=c,this.maxRandDelay=d},objectCache:libx.cache.defaultObjectCache,rootDataType:"text",childDataType:"text",updateChildrenRule:"root",updateChildren:libx.core.AbstractFunction("libx.cache.Scheduler.updateChildren"),updatesFinished:libx.core.EmptyFunction,stopScheduling:function(){this.cancelUpdates=!0},rootValidator:null,childValidator:null,scheduleUpdates:function(a){function c(a){libx.utils.timer.setTimeout(d,a),g("scheduling update in "+Math.round(a/1e3)+" seconds for "+b.rootUrl)}function d(){function h(a,c,h){function j(c){var e=!1,j=null;b.objectCache.update({url:a,metadata:c,dataType:b.childDataType,validator:function(a){var c=this,d={onready:function(){b.childValidator.call(c,a)}};f.scheduleLast(d),j=new libx.utils.collections.EmptyActivity,f.scheduleLast(j),d.markReady()},success:function(){e=!0,g(a+" updated")},error:function(b){d=!0,libx.log.write("scheduler: error status "+b+" updating "+a)},complete:function(){h&&h(e),i.markReady(),j!=null&&libx.utils.timer.setTimeout(function(){j.markReady()},0)}})}var i=new libx.utils.collections.EmptyActivity;g("checking for updates to child "+a),e.scheduleFirst(i),b.objectCache.getMetadata({url:a,success:function(a){c(a)?j(a):i.markReady()},notfound:function(){j()}})}if(b.cancelUpdates)return;g("checking for updates to root: "+b.rootUrl);var a=!1,d=!1,e=new libx.utils.collections.ActivityQueue,f=new libx.utils.collections.ActivityQueue,i=null,j=function(f){b.objectCache.update({url:b.rootUrl,metadata:f,ignoreQuery:!0,dataType:b.rootDataType,validator:b.rootValidator,delayWrite:function(a){i=a},success:function(c,d,e){a=!0,g(b.rootUrl+" updated"),b.updateChildrenRule=="root"&&b.updateChildren(h,c)},error:function(a){libx.log.write("scheduler: error status "+a+" updating "+b.rootUrl),d=!0},complete:function(){b.updateChildrenRule=="always"&&!d&&b.updateChildren(h,null,e,function(){d=!0});var f={onready:function(){function f(){g("all updates completed successfully for "+b.rootUrl),b.updatesFinished(a);var d=Math.floor(b.maxRandDelay*Math.random());c(b.updateInterval+d)}if(d){var e=2*b.currentRetryInterval||b.initialRetryInterval;e>b.maxRetryInterval&&(e=b.maxRetryInterval),b.currentRetryInterval=e,g("updates unsuccessful for "+b.rootUrl),c(e);return}b.currentRetryInterval=0,i?i(f):f()}};e.scheduleLast(f),f.markReady()}})};b.objectCache.getMetadata({url:b.rootUrl,ignoreQuery:!0,success:function(a){j(a)},notfound:function(){j()}})}if(e)return;var b=this;b.objectCache.getMetadata({ignoreQuery:!0,url:b.rootUrl,success:function(e){var f=Date.now(),h=Math.floor(b.maxRandDelay*Math.random()),i=e.lastAccessed+b.updateInterval+h;!a&&f<i?c(i-f):(g(b.rootUrl+" expired; updating now"),d())},notfound:function(){g(b.rootUrl+" not found in cache; updating now"),d()}})}}),libx.cache.HashScheduler=libx.core.Class.create(libx.cache.Scheduler,{rootDataType:"json",rootValidator:function(a){/json/.test(a.mimeType)&&a.data.files?a.success():a.error()},childValidator:libx.cache.validators.bootstrapped,updateChildren:function(a,b){for(var c in b.files)(function(c){var d=libx.utils.getBootstrapURL(c);a(d,function(a){var d=b.files[c].hash;return a.sha1!=d})})(c)}}),libx.cache.ConfigScheduler=libx.core.Class.create(libx.cache.Scheduler,{rootDataType:"xml",rootValidator:libx.cache.validators.config,childValidator:function(a){a.success()},updateChildren:function(a,b){var c=this.rootUrl.replace("/config.xml",""),d=libx.utils.xpath.findNodesXML(b,"/edition/additionalfiles/*");d.forEach(function(b){var d=b.getAttribute("name");if(d=="defaultprefs.xml")return;var e=c+"/"+d;a(e,libx.core.TrueFunction)})},updatesFinished:function(a){a&&libx.loadConfig(this.rootUrl)}}),libx.cache.PackageScheduler=libx.core.Class.create(libx.cache.Scheduler,{initialize:function(a){this.fullRootUrl=a,this.parent(f(a))},rootDataType:"xml",childDataType:"xml",rootValidator:libx.cache.validators.feed,childValidator:libx.cache.validators.feed,updateChildrenRule:"always",updateChildren:function(a,b,c,d){function g(b){b.forEach(function(b){function i(){function a(a){g(a.entries),h.markReady()}(new libx.libapp.PackageWalker(b.url)).walk({onpackage:a,onlibapp:a,onmodule:a,error:function(){d(),h.markReady()}})}var h=new libx.utils.collections.EmptyActivity;c.scheduleFirst(h);var j=f(b.url),k={onready:i};j in e?(e[j].scheduleLast(k),k.markReady()):(e[j]=new libx.utils.collections.ActivityQueue,e[j].scheduleLast(k),a(j,libx.core.TrueFunction,function(a){a&&libx.libapp.clearOverridden(),k.markReady()}))})}var e={};e[this.rootUrl]=new libx.utils.collections.ActivityQueue,g([{url:this.fullRootUrl}])}}),libx.cache.TemplateScheduler=libx.core.Class.create(libx.cache.Scheduler,{scheduleUpdates:function(){var a=this;if(e||this.cancelUpdates)return;g("checking for expired template files");var b=libx.utils.getBootstrapURL("");libx.storage.metacacheStore.find({pattern:new RegExp("^(?!"+b+").+\\.tmpl$"),success:function(b){b.forEach(function(b){a.objectCache.getMetadata({url:b,success:function(c){if(c.expired){g(b+" already marked as expired");return}var d=c.lastAccessed+a.updateInterval;Date.now()>d&&(g(b+" marked as expired"),c.expired=!0,a.objectCache.putMetadata({url:b,metadata:c}))}})})}}),libx.utils.timer.setTimeout(function(){a.scheduleUpdates.call(a)},a.updateInterval),g("scheduling expiration check in "+Math.round(a.updateInterval/1e3)+" seconds for template files")}}),(new libx.cache.TemplateScheduler).scheduleUpdates(),libx.events.addListener("EditionConfigurationLoaded",{onEditionConfigurationLoaded:function(){libx.cache.defaultHashScheduler&&libx.cache.defaultHashScheduler.stopScheduling();var a=libx.utils.getBootstrapURL("updates.json");a+="?edition="+libx.edition.id+"&editionversion="+libx.edition.version+"&libxversion="+libx.version,libx.cache.defaultHashScheduler=new libx.cache.HashScheduler(a),libx.cache.defaultHashScheduler.scheduleUpdates(),libx.cache.defaultConfigScheduler&&libx.cache.defaultConfigScheduler.stopScheduling();var b=libx.utils.browserprefs.getStringPref("libx.edition.configurl");libx.cache.defaultConfigScheduler=new libx.cache.ConfigScheduler(b),libx.cache.defaultConfigScheduler.scheduleUpdates()}})}(),libx.utils.hash=function(){function a(a){function b(a,b){var c=a<<b|a>>>32-b;return c}function c(a){var b="",c,d,e;for(c=0;c<=6;c+=2)d=a>>>c*4+4&15,e=a>>>c*4&15,b+=d.toString(16)+e.toString(16);return b}function d(a){var b="",c,d;for(c=7;c>=0;c--)d=a>>>c*4&15,b+=d.toString(16);return b}function e(a){a=a.replace(/\r\n/g,"\n");var b="";for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):d>127&&d<2048?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(d&63|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(d&63|128))}return b}var f,g,h,i=new Array(80),j=1732584193,k=4023233417,l=2562383102,m=271733878,n=3285377520,o,p,q,r,s,t;a=e(a);var u=a.length,v=new Array;for(g=0;g<u-3;g+=4)h=a.charCodeAt(g)<<24|a.charCodeAt(g+1)<<16|a.charCodeAt(g+2)<<8|a.charCodeAt(g+3),v.push(h);switch(u%4){case 0:g=2147483648;break;case 1:g=a.charCodeAt(u-1)<<24|8388608;break;case 2:g=a.charCodeAt(u-2)<<24|a.charCodeAt(u-1)<<16|32768;break;case 3:g=a.charCodeAt(u-3)<<24|a.charCodeAt(u-2)<<16|a.charCodeAt(u-1)<<8|128}v.push(g);while(v.length%16!=14)v.push(0);v.push(u>>>29),v.push(u<<3&4294967295);for(f=0;f<v.length;f+=16){for(g=0;g<16;g++)i[g]=v[f+g];for(g=16;g<=79;g++)i[g]=b(i[g-3]^i[g-8]^i[g-14]^i[g-16],1);o=j,p=k,q=l,r=m,s=n;for(g=0;g<=19;g++)t=b(o,5)+(p&q|~p&r)+s+i[g]+1518500249&4294967295,s=r,r=q,q=b(p,30),p=o,o=t;for(g=20;g<=39;g++)t=b(o,5)+(p^q^r)+s+i[g]+1859775393&4294967295,s=r,r=q,q=b(p,30),p=o,o=t;for(g=40;g<=59;g++)t=b(o,5)+(p&q|p&r|q&r)+s+i[g]+2400959708&4294967295,s=r,r=q,q=b(p,30),p=o,o=t;for(g=60;g<=79;g++)t=b(o,5)+(p^q^r)+s+i[g]+3395469782&4294967295,s=r,r=q,q=b(p,30),p=o,o=t;j=j+o&4294967295,k=k+p&4294967295,l=l+q&4294967295,m=m+r&4294967295,n=n+s&4294967295}var t=d(j)+d(k)+d(l)+d(m)+d(n);return t.toLowerCase()}return{hashString:function(b){return a(b)}}}(),libx.catalog={factory:{}},libx.catalog.CatalogUtils={adjustISNSearchType:function(a){a.searchType=="i"&&!libx.utils.stdnumsupport.isISBN(a.searchTerms)&&libx.utils.stdnumsupport.isISSN(a.searchTerms)&&(a.searchType="is")}},libx.catalog.Catalog=libx.core.Class.create({include:[libx.catalog.CatalogUtils],downconvertisbn13:!0,xisbn:{},makeSubjectSearch:function(a){return this.makeSearch("d",a)},makeTitleSearch:function(a){return this.makeSearch("t",a)},makeISBNSearch:function(a){return this.makeSearch("i",a)},makeISSNSearch:function(a){return this.makeSearch("is",a)},makeAuthorSearch:function(a){return this.makeSearch("a",a)},makeCallnoSearch:function(a){return this.makeSearch("c",a)},makeKeywordSearch:function(a){return this.makeSearch("Y",a)},makeXISBNRequest:function(a){return this.xisbn.res_id?"http://xisbn.worldcat.org:80/liblook/resolve.htm?res_id="+this.xisbn.res_id+"&rft.isbn="+a+"&url_ver=Z39.88-2004&rft_val_fmt=info:ofi/fmt:kev:mtx:book":this.xisbn.opacid?"http://xisbn.worldcat.org/liblook/resolve.htm?res_id="+this.url.replace(/https/,"http")+"&opactype="+this.xisbn.opacid+(this.xisbn.siteparam!=null?this.xisbn.siteparam:"")+"&rft.isbn="+a:this.makeISBNSearch(a)},linkByISBN:function(a){return this.xisbn.cues?this.makeXISBNRequest(a):this.makeISBNSearch(a)},search:function(a){a.length==0&&(a=[{searchType:"Y",searchTerms:""}]);for(var b=0;b<a.length;b++){if(!this.supportsSearchType(a[b].searchType)){libx.log.write(this.name+" does not support search type "+a[b].searchType);return}this.adjustISNSearchType(a[b])}if(a.length==1)var c=this.makeSearch(a[0].searchType,a[0].searchTerms);else var c=this.makeAdvancedSearch(a);return c==null&&libx.log.write("Could not construct search"),c},combineSameTypedFields:function(fields){var searchField2Term={};for(var i=0;i<fields.length;i++)with(fields[i])searchType in searchField2Term?searchField2Term[searchType]+=" "+searchTerms:searchField2Term[searchType]=searchTerms;return searchField2Term},supportsSearchType:function(a){return(";"+this.options+";").match(";"+a+";")},options:"Y;t;a;d;i;c",makeSearch:function(a,b){},makeAdvancedSearch:function(a){},previewers:{}}),libx.catalog.preview={getPreviewer:function(a,b){if(!a.previewers)return null;for(var c in a.previewers)if(a[c]!=null)return new a.previewers[c](a,b);return null},registerPreviewer:function(a){var b=a.catalog,c=a.previewkey;libx.catalog.factory[b].prototype.previewers[c]=libx.core.Class.create(libx.catalog.preview.Previewer,a);var d=new libx.events.Event("PreviewerRegistered");d.notify()},Previewer:libx.core.Class.create({initialize:function(a){this.catalog=a},doPreview:function(a,b){var c=this.catalog.search(a),d=c.replace(/^.*\?/,""),e=this.catalog[this.previewkey];libx.cache.defaultMemoryCache.get({url:e+"?"+d,dataType:"json",success:b})},formatResult:function(a,b){return a}})},libx.catalog.factory.bookmarklet=libx.core.Class.create(libx.catalog.Catalog,{makeSearch:function(a,b){return this.makeAdvancedSearch([{searchType:a,searchTerms:b}])},makeAdvancedSearch:function(a){var b=this.postdata!=null;if(b)var c=this.postdata;else var c=this.url;var d,e=/%SWITCH\{(%[a-z0-9]+)\}\{(([^}]+(\}\{)?)+)}/i;while((d=c.match(e))!=null){var f=d[1],g="",h=d[2].split("}{"),i=f.match(/^%type(\d+)/),j=null;i?i[1]<=a.length&&(j=a[i[1]-1].searchType):(i=f.match(/^%term(\d+)/),i?i[1]<=a.length&&(j=a[i[1]-1].searchTerms):libx.log.write("invalid switch_arg '"+f+"', must be %termX or %typeX"));for(var k=0;j!=null&&k<h.length;k++){var l=new RegExp("^"+j+":(\\S*)$"),i=l.exec(h[k]);if(i){g=i[1];break}}c=c.replace(e,g)}for(var k=0;k<a.length;k++)c=c.replace("%term"+(k+1),encodeURIComponent(a[k].searchTerms),"g");c=c.replace(/%term\d+/g,"");var m=this.combineSameTypedFields(a),n,o=/%JOIN{(([^}]+(\}\{)?)+)}/i;while((n=c.match(o))!=null){var h=n[1].split("}{"),p=h[0],g="";for(var k=1;k<h.length;k++){var q=h[k].split("|");m[q[0]]&&(g!=""&&(g+=p),g+=q[1])}c=c.replace(o,g)}for(var r in m)c=c.replace("%"+r,encodeURIComponent(m[r]));for(var s in libx.edition.searchoptions)c=c.replace(new RegExp("%"+s+"(?![a-zA-Z0-9])"),"","g");return b?[this.url,c]:c}}),libx.catalog.factory.scholar=libx.core.Class.create(libx.catalog.Catalog,{options:"Y;at;jt;a",makeSearch:function(a,b){return this.makeAdvancedSearch([{searchType:a,searchTerms:b}])},makeAdvancedSearch:function(a){return this.libxScholarSearch(a)},libxScholarSearch:function(a){var b="",c="",d="",e="";for(var f=0;f<a.length;f++)switch(a[f].searchType){case"a":b+=a[f].searchTerms+" ";break;case"at":d+=a[f].searchTerms+" ";break;case"Y":case"i":c+=a[f].searchTerms+" ";break;case"t":case"jt":e+=a[f].searchTerms}var g="";c==""&&d!=""?g="allintitle: "+d:g=c+" "+d,b!=""&&(g+=" author:"+b);var h="http://scholar.google.com/scholar?hl=en&lr=";return e&&(h+="&as_publication="+encodeURIComponent(e)),h+"&q="+encodeURIComponent(libx.utils.string.trim(g))}}),function(){function a(a,b){return a!="Y"?b:b.replace(/:/g,"")}libx.catalog.factory.millenium=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"innovative"},searchform:1,advancedcode:"X",keywordcode:"Y",journaltitlecode:"t",language:"",supportsSearchType:function(a){return a=="at"?(alert(libxGetProperty("articletitle.alert")),!1):!0},normalizeSearchType:function(a){return a=="is"?"i":a=="jt"?this.journaltitlecode:a},makeSearch:function(b,c){b=this.normalizeSearchType(b),c=a(b,c),b=="Y"&&(b=this.keywordcode);var d=this.url+"/search"+this.language+"/";switch(this.searchform){default:case"1":d+=b+"?"+encodeURIComponent(c);break;case"2":d+=b+"?SEARCH="+encodeURIComponent(c);break;case"3":d+="?/searchtype="+b+"&searcharg="+encodeURIComponent(c)}var e=b!="a";return e&&(d+="&startLimit="),d+=this.searchscope!=null?"&searchscope="+this.searchscope:"",d+=this.sort!=null?"&SORT="+this.sort:"",e&&(d+="&endLimit="),d},makeAdvancedSearch:function(b){var c=this.url+"/search"+this.language+"/"+this.advancedcode+"?SEARCH=";c+=this.normalizeSearchType(b[0].searchType)+":("+encodeURIComponent(a(b[0].searchType,b[0].searchTerms))+")";for(var d=1;d<b.length;d++)c+="+and+"+this.normalizeSearchType(b[d].searchType)+":("+encodeURIComponent(a(b[d].searchType,b[d].searchTerms))+")";return c+=this.searchscope!=null?"&searchscope="+this.searchscope:"",c+="&SORT="+this.sort,this.sid&&(c+="&sid="+this.sid),c=c.replace(/Y:\(/g,"("),c}})}(),libx.catalog.factory.horizon=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"ipac"},path:"/ipac20/ipac.jsp",subject:".SW",author:".AW",keyword:".GW",title:".TW",journaltitle:".JK",callno:"CALLLC",convert:function(a){switch(a){case"d":return this.subject;case"a":return this.author;case"t":return this.title;case"jt":return this.journaltitle;case"i":return this.isbn;case"is":return this.issn;case"c":return this.callno;case"Y":return this.keyword;default:return this.keyword}},supportsSearchType:function(a){return a=="at"?(alert(libxGetProperty("articletitle.alert")),!1):!0},makeSearch:function(a,b){return this.url+this.path+"?"+(this.profile?"profile="+this.profile+"&":"")+(this.sid!=null?"sid="+this.sid+"&":"")+"index="+this.convert(a)+"&term="+encodeURIComponent(b)},makeAdvancedSearch:function(a){var b=this.url+this.path+"?";b+=this.profile?"profile="+this.profile+"&":"",b+=this.sid?"sid="+this.sid+"&":"",b+="index="+this.convert(a[0].searchType)+"&term="+encodeURIComponent(a[0].searchTerms);for(var c=1;c<a.length;c++)b+="&oper=and&index="+this.convert(a[c].searchType)+"&term="+encodeURIComponent(a[c].searchTerms);return b}}),function(){function a(a){a=a.replace(/(\(|\))/g," $1 ");var b=/(\"[^"]*\"|\S+)/g;a=a.replace(b,"$1#");var c=a.split("#"),d=c.length-1,e="",f=0;for(var g=0;g<d;g++)c[g].match(/^\s*"/)?g==0||f==1?(e+=c[g],f=0):e=e+" AND "+c[g]:c[g].match(/^\s*and\s*$/i)?f!=1&&(e+="AND",f=1):c[g].match(/^\s*or\s*$/i)?f!=1&&(e+="OR",f=1):c[g].match(/^\s*not\s*$/i)?(e+="NOT",f=1):c[g].match(/&/)?(e=e.replace(/\s*([a-zA-Z0-9_\-\(\)\?]+)\s+$/,' "$1'),e=e+" & "+c[g+1]+'" ',g++):c[g].match(/(^\s*GKEY\s*$|^\s*IALL\s*$|^\s*ISBN\s*$|^\s*ISSN\s*$|^\s*JKEY\s*$|^\s*KPPD\s*$|^\s*LSUB\s*$|^\s*NKEY\s*$|^\s*NOTE\s*$|^\s*SERI\s*$|^\s*SKEY\s*$|^\s*TKEY\s*$|^\s*\d{3}[ABCKLNT]\s*$)/)?(f==1||g==0?e+=c[g]:e=e+" AND "+c[g],f=1):c[g].match(/\(/)?(f==1||g==0?e+=" (":(e=e+" AND"+" (",f=1),g==0&&(f=1)):c[g].match(/\)/)?(e+=")",f=0):c[g].match(/-/)?f==1||g==0?(e=e+'"'+c[g]+'"',f=0):e=e+" AND "+'"'+c[g]+'"':g==0||f==1?(e+=c[g],f=0):e=e+" AND "+c[g],e+=" ";return e}libx.catalog.factory.voyager=libx.core.Class.create(libx.catalog.Catalog,{keyword:"FT*",count:25,relevanceranking:!0,xisbn:{opacid:"voyager"},__init:function(
){this.autoinsertand&&(this.keyword="CMD",this.relevanceranking=!1)},convert:function(a){switch(a){case"d":return"SUBJ_";case"a":return"NAME_";case"t":return"TALL";case"jt":return"JALL";case"is":return"ISSN";case"i":return"ISBN";case"c":return"CALL_";case"Y":return this.keyword;default:return this.keyword}},convert2:function(a){switch(a){case"d":return"Subject (SKEY)";case"a":return"Author (NKEY)";case"jt":case"t":return"Title (TKEY)";case"is":case"i":return"ISSN/ISBN (ISSN)";case"Y":return"Keyword Anywhere (GKEY)";case"c":return"?not supported?";default:return"not supported"}},supportsSearchType:function(a){return a=="at"?(alert(libxGetProperty("articletitle.alert")),!1):!0},makeSearch:function(b,c){return this.autoinsertand&&b=="Y"&&(c=a(c)),this.relevanceranking&&b=="Y"&&(c=c.replace(/^(\S)/,"+$1"),c=c.replace(/\s+(\S)/g," +$1")),this.advancedsearchforissn&&b=="is"?this.makeAdvancedSearch([{searchType:b,searchTerms:c}]):(c=encodeURIComponent(c),this.url+"/cgi-bin/Pwebrecon.cgi?Search_Arg="+c+"&HIST=1&SL=None&Search_Code="+this.convert(b)+"&CNT="+this.count+"&DB=local")},makeAdvancedSearch:function(a){var b=this.url+"/cgi-bin/Pwebrecon.cgi?HIST=1&CNT=25&DB=local&SL=None";for(var c=0;c<a.length;c++)b+="&SAB"+(c+1)+"="+encodeURIComponent(a[c].searchTerms)+"&BOOL1=all+of+these&FLD"+(c+1)+"="+this.convert2(a[c].searchType),c<a.length-1&&(b+="&GRP"+(c+1)+"=AND+with+next+set");return b}})}(),libx.catalog.factory.aleph=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"aleph"},scanindexlist:"t;c",supportsSearchType:function(a){return a=="at"?(alert(libxGetProperty("articletitle.alert")),!1):!0},escape:function(a){return encodeURIComponent(a).replace(/%20/g,"+")},searchCodeLookup:function(a){switch(a){case"d":return this.subject;case"jt":return this.journaltitle;case"t":return this.title;case"c":return this.callno;case"a":return this.author;case"Y":return this.keyword;case"is":return this.issn;case"i":return this.isbn;default:return this.keyword}},storeCcl:function(a){try{libx.ui.getCurrentWindowContent().setCcl&&libx.ui.getCurrentWindowContent().setCcl(a)}catch(b){libx.log.write("exception while setting aleph cookie: "+b,"aleph")}},makeSearch:function(a,b){var c=";"+this.scanindexlist+";";if(c.match(";"+a+";"))var d="&scan_code="+this.searchCodeLookup(a)+"&scan_start="+this.escape(b),e=this.scanfunc;else var d="&find_code="+this.searchCodeLookup(a)+"&request="+this.escape(b),e=this.findfunc;if(this.usecclforsimple=="true"){var f=this.searchCodeLookup(a)+"="+b;this.storeCcl(f),d="&ccl_term="+this.escape(f)}return this.url+"/F?func="+e+(this.sid!=null?"&sourceid="+this.sid:"")+(this.localbase!=null?"&local_base="+this.localbase:"")+d},makeAdvancedSearch:function(a){var b=this.url+"/F?func="+this.advfindfunc+(this.sid!=null?"&sourceid="+this.sid:"")+(this.localbase!=null?"&local_base="+this.localbase:"");if(this.usecclforadv=="true"){var c=this.searchCodeLookup(a[0].searchType)+"="+a[0].searchTerms;for(var d=1;d<a.length;d++)c+=" AND "+this.searchCodeLookup(a[d].searchType)+"="+a[d].searchTerms;this.storeCcl(c),b+="&ccl_term="+this.escape(c)}else{b+="&find_code="+this.searchCodeLookup(a[0].searchType)+"&request="+this.escape(a[0].searchTerms);for(var d=1;d<a.length;d++)b+="&request_op=AND&find_code="+this.searchCodeLookup(a[d].searchType)+"&request="+this.escape(a[d].searchTerms)}return b}}),libx.catalog.factory.sirsi=libx.core.Class.create(libx.catalog.Catalog,{path:"/uhtbin/cgisirsi/x/0/0/5/",searchscope:1,xisbn:{opacid:"sirsi6"},convert:function(a){switch(a){case"d":return"&srchfield1="+this.convert2(a);case"a":return"&srchfield1="+this.convert2(a);case"jt":case"t":return"&srchfield1="+this.convert2(a);case"is":case"i":return"&srchfield1="+this.convert2(a);case"c":return"";case"Y":return"&srchfield1="+this.convert2(a);default:return""}},convert2:function(a){switch(a){case"d":return"SU^SUBJECT^SUBJECTS^^subject";case"a":return"AU^AUTHOR^AUTHORS^Author Processing^author";case"t":return"TI^TITLE^TITLES^Title Processing^title";case"jt":return"PER^PERTITLE^TITLES^Title Processing^periodical title";case"is":case"i":return"GENERAL^SUBJECT^GENERAL^^keywords anywhere";case"Y":return"GENERAL^SUBJECT^GENERAL^^keywords anywhere";case"c":return"GENERAL^SUBJECT^GENERAL^^keywords anywhere";default:return"GENERAL^SUBJECT^GENERAL^^keywords anywhere"}},supportsSearchType:function(a){return a=="at"?(alert(libxGetProperty("articletitle.alert")),!1):!0},scopeField:function(a){return this.searchscope!=1?"&library="+this.searchscope:""},sortField:function(a){return this.sort?"&sort_by="+this.sort:""},userId:function(a){return this.user_id?"&user_id="+this.user_id+"&password="+(this.password!=null?this.password:""):""},makeSearch:function(a,b){return this.url+this.path+"?searchdata1="+encodeURIComponent(b)+this.convert(a)+this.scopeField()+this.sortField()+this.userId()},makeAdvancedSearch:function(a){var b=this.url+this.path+"?";for(var c=0;c<a.length;c++)b+="srchfield"+(c+1)+"="+this.convert2(a[c].searchType)+"&searchdata"+(c+1)+"="+encodeURIComponent(a[c].searchTerms),c<a.length-1&&(b+="&searchoper"+(c+1)+"=AND&");return b+this.scopeField()+this.sortField()+this.userId()}}),libx.catalog.factory.web2=libx.core.Class.create(libx.catalog.Catalog,{path:"/web2/tramp2.exe/do_keyword_search/log_in?guest=guest&",searchscope:1,xisbn:{opacid:"sirsi6"},convert:function(a){switch(a){case"d":return"SU";case"a":return"AU";case"jt":return"PER";case"t":return"TI";case"is":case"i":case"c":case"Y":default:return"default"}},convert2:function(a){switch(a){case"d":return"SU";case"a":return"AU";case"t":return"TI";case"jt":return"PER";case"is":case"i":case"Y":case"c":default:return""}},supportsSearchType:function(a){return a=="at"?(alert(libxGetProperty("articletitle.alert")),!1):!0},scopeField:function(a){return this.searchscope!=1?"&location_group_filter="+this.searchscope:""},sortField:function(a){return this.sort?"&sort_by="+this.sort:""},makeSearch:function(a,b){return this.url+this.path+"setting_key="+this.setting_key+"&index="+this.convert(a)+"&servers="+this.servers+"&query="+encodeURIComponent(b)+this.scopeField()+this.sortField()},makeAdvancedSearch:function(a){var b=this.url+this.path+"setting_key="+this.setting_key+"&servers="+this.servers+"&index=default&query=";for(var c=0;c<a.length;c++)b+="("+this.convert2(a[c].searchType)+" "+encodeURIComponent(a[c].searchTerms)+")",c<a.length-1&&(b+=" AND ");return b+this.scopeField()+this.sortField()}}),libx.catalog.factory.centralsearch=libx.core.Class.create(libx.catalog.Catalog,{convert:function(a){switch(a){case"d":return"Subject";case"a":return"Author";case"t":return"Title";case"is":return"ISSN";case"i":return"ISBN";case"Y":return"Keyword";default:return"Any"}},supportsSearchType:function(a){return!0},prolog:function(a){return this.url+"/results?SS_LibHash="+this.sslibhash+(this.dbidlist?"&dbIDList="+this.dbidlist:"")+"&catGroupList=default"+"&searchBy="+this.searchby+"&searchType="+a},epilog:function(a){var b="";return this.catids&&(b+="&catID="+this.catids.replace(/;/g,"&catID=")),this.catgroupids&&(b+="&catGroupID="+this.catgroupids.replace(/;/g,"&catGroupID=")),b},makeSearch:function(a,b){return this.prolog("basic")+"&field="+this.convert(a)+"&term="+encodeURIComponent(b)+this.epilog()},makeAdvancedSearch:function(a){var b=this.prolog("advanced");for(var c=0;c<a.length;c++)c>0&&(b+="&boolop"+c+"=And"),b+="&field"+c+"="+this.convert(a[c].searchType)+"&term"+c+"="+encodeURIComponent(a[c].searchTerms);return b+=this.epilog(),b}}),libx.catalog.factory.custom=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"Please set thisCatalog.xisbn.opacid as per http://xisbn.worldcat.org/liblook/howtolinkbyopactype.htm"},__init:function(){var thisCatalog=this;libx.log.write("Loading external catalog implementation from: "+thisCatalog.jsimplurl);var xhrParams={dataType:"text",type:"GET",url:thisCatalog.jsimplurl,complete:function(code){try{eval(code)}catch(er){libx.log.write("Error loading external catalog from "+thisCatalog.jsimplurl+". I received: "+code)}},bypassCache:!0};libx.cache.defaultMemoryCache.get(xhrParams)}}),libx.catalog.factory.evergreen=libx.core.Class.create(libx.catalog.Catalog,{locale:"en-US",skin:"default",scope:"",sortby:"",sortdirection:"asc",xisbn:{opacid:"evergreen"},convert:function(a){switch(a){case"Y":return"keyword";case"i":return"isbn";case"is":return"issn";case"a":return"author";case"t":return"title";case"d":return"subject";default:return"keyword"}},baseURL:function(){return this.url+"/opac/"+this.locale+"/skin/"+this.skin+"/xml/"},rresultBaseURL:function(){return this.baseURL()+"rresult.xml"+"?"+"l="+this.scope+"&s="+this.sortby+"&sd="+this.sortdirection},makeSearch:function(a,b){b=encodeURIComponent(b);switch(a){case"c":return this.baseURL()+"cnbrowse.xml"+"?"+"l="+this.scope+"&cn="+b;case"i":case"is":return this.rresultBaseURL()+"&rt="+this.convert(a)+"&adv="+b;default:return this.rresultBaseURL()+"&rt="+this.convert(a)+"&tp="+this.convert(a)+"&t="+b}},makeAdvancedSearch:function(a){var b=this.combineSameTypedFields(a),c=this.rresultBaseURL()+"&rt=multi&tp=multi&adv=&t=",d="";for(var e in b)d+=this.convert(e)+":"+b[e]+" ";return c+=encodeURIComponent(d),c}}),libx.catalog.factory.worldcat=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"worldcat"},convert:function(a){switch(a){case"Y":return"kw";case"a":return"au";case"t":return"ti";default:return""}},baseURL:function(){return this.url+"/search?qt="+this.qt+"&q="},specialBaseURL:function(a,b){return this.url+"/"+a+"/"+b},makeSearch:function(a,b){b=encodeURIComponent(b);switch(a){case"Y":return this.baseURL()+b;case"i":return this.specialBaseURL("isbn",b);case"is":return this.specialBaseURL("issn",b);default:return this.baseURL()+this.convert(a)+":"+b}},makeAdvancedSearch:function(a){var b=this.combineSameTypedFields(a),c=this.baseURL(),d="";for(var e in b)d+=this.convert(e)+":"+b[e]+" ";return c+=encodeURIComponent(d),c}}),libx.catalog.factory.vubis=libx.core.Class.create(libx.catalog.Catalog,{profile:"Default",opaclanguage:"eng",searchmethod:"Find_1",xisbn:{opacid:"vubis"},searchType2Index:function(a){switch(a){case"d":return"1*Subjectbib";case"a":return"1*Authorbib";case"t":return"1*Titlebib";case"is":return"1*Issn";case"i":return"1*Isbn";case"Y":return"1*Keywordsbib";default:return"1*Keywordsbib"}},makeSearch:function(a,b){var c=this.url+this.path+"/LinkToVubis.csp?";return c+="Database=1&Language="+this.opaclanguage+"&SearchTerm="+encodeURIComponent(b)+"&Index="+this.searchType2Index(a)+"&SearchMethod="+this.searchmethod+"&Profile="+this.profile,c},makeAdvancedSearch:function(a){var b=this.url+this.path+"/List.csp?";b+="SearchTerm1="+encodeURIComponent(a[0].searchTerms)+"&Index1="+this.searchType2Index(a[0].searchType),b+="&Database=1";for(var c=1;c<a.length;c++)b+="&BoolOp"+(c+1)+"=AND"+"&SearchTerm"+(c+1)+"="+encodeURIComponent(a[c].searchTerms)+"&Index"+(c+1)+"="+this.searchType2Index(a[c].searchType);return b+"&OpacLanguage="+this.opaclanguage+"&NumberToRetrieve=50"+"&SearchMethod="+this.searchmethod+"&Profile="+this.profile}}),libx.catalog.factory.voyager7=libx.core.Class.create(libx.catalog.Catalog,{count:10,path:"/vwebv/search",limitto:"none",isbn:"ISBN",issn:"ISSN",subject:"SKEY",author:"NKEY",keyword:"GKEY",title:"TKEY",xisbn:{opacid:"webvoyager"},searchType2Index:function(a){switch(a){case"d":return this.subject;case"a":return this.author;case"t":return this.title;case"is":return this.issn;case"i":return this.isbn;case"Y":return this.keyword;default:return this.keyword}},makeSearch:function(a,b){var c=this.url+this.path+"?";return c+="searchArg="+encodeURIComponent(b)+"&searchCode="+this.searchType2Index(a)+"&limitTo="+this.limitto+"&recCount="+this.count+"&searchType=1",c},makeAdvancedSearch:function(a){var b=this.url+this.path+"?";b+="searchArg1="+encodeURIComponent(a[0].searchTerms)+"&argType1=any"+"&searchCode1="+this.searchType2Index(a[0].searchType);for(var c=1;c<a.length;c++)b+="&combine"+(c+1)+"=and"+"&searchArg"+(c+1)+"="+encodeURIComponent(a[c].searchTerms)+"&argType"+(c+1)+"=any"+"&searchCode"+(c+1)+"="+this.searchType2Index(a[c].searchType);return b+"&recCount="+this.count+"&searchType=2"}}),libx.catalog.factory.talisprism=libx.core.Class.create(libx.catalog.Catalog,{collections:"1",location:"talislms",sites:"-1",path:"/TalisPrism",callnumber:"classNumber",controlnr:"controlNumber",author:"author",keyword:"keyword",title:"title",xisbn:{opacid:"talisPrism"},searchType2Index:function(a){switch(a){case"a":return this.author;case"t":return this.title;case"i":case"is":return this.controlnr;case"c":return this.callnumber;case"Y":return this.keyword;default:return this.keyword}},makeSearch:function(a,b){return this.makeAdvancedSearch([{searchType:a,searchTerms:b}])},makeAdvancedSearch:function(a){var b=this.url+this.path+"/doSearch.do?";b+="searchCollections="+this.collections+"&searchSites="+this.sites+"&searchDates="+"&searchType="+"briefSearch";for(var c=0;c<a.length;c++)b+="&st"+(c+1)+"="+this.searchType2Index(a[c].searchType)+"&sb"+(c+1)+"=And"+"&sv"+(c+1)+"="+encodeURIComponent(a[c].searchTerms);return b+="&searchLocation="+this.location,b}}),libx.catalog.factory.polaris=libx.core.Class.create(libx.catalog.Catalog,{ctx:"1.1033.0.0.1",searchtype:"Advanced",kwsearchtype:"Keyword",limit:"TOM=*",xisbn:{opacid:"polaris"},convert:function(a){switch(a){case"Y":return"KW";case"i":return"ISBN";case"is":return"ISSN";case"a":return"AU";case"t":return"TI";case"d":return"SU";case"c":return"LCCN";default:return"KW"}},baseURL:function(){return this.url+"/polaris/Search/searchresults.aspx?ctx="+this.ctx},makeSearch:function(a,b){return this.makeAdvancedSearch([{searchType:a,searchTerms:b}])},makeAdvancedSearch:function(a){var b=this.combineSameTypedFields(a),c=this.baseURL();for(var d in b){switch(d){case"Y":c+="&type="+this.kwsearchtype;break;default:c+="&type="+this.searchtype}c+="&term="+encodeURIComponent(b[d]),c+="&by="+this.convert(d)}return c+"&limit="+this.limit},makeXISBNRequest:function(a){return this.xisbn.res_id==null?"http://xisbn.worldcat.org/liblook/resolve.htm?res_id="+this.url.replace(/https/,"http")+"/polaris"+"&opactype="+this.xisbn.opacid+(this.xisbn.siteparam!=null?this.xisbn.siteparam:"")+"&rft.isbn="+a:this.parent(a)}}),libx.catalog.factory.openurlresolver=libx.core.Class.create(libx.catalog.Catalog,{__init:function(a){this.options=a.openurl[this.resolvernum].options},search:function(a){return libx.edition.openurl[this.resolvernum].search(a)}}),libx.catalog.factory.primo=libx.core.Class.create(libx.catalog.Catalog,{xisbn:{opacid:"primo"},isbnindex:"isbn",issnindex:"issn",titlesearchmode:"contains",convert:function(a){switch(a){case"Y":return"any";case"t":return"title";case"a":return"creator";case"d":return"sub";case"c":return"lsr01";case"ut":return"usertag";case"i":return this.isbnindex;case"is":return this.issnindex;case"p":return"lsr03"}},makeSearch:function(a,b){var c=this.url+this.path+"/action/search.do?fn=go&ct=search";return c+="&vid="+this.vid,c+="&mode=Basic",c+="&indx=0",c+="&dum=true",c+="&vl(freeText0)="+encodeURIComponent(b),c+="&"+this.materialvar+"="+this.defaultmaterial,a=="t"?c+="&"+this.searchmodevar+"="+this.titlesearchmode:c+="&"+this.searchmodevar+"="+this.defaultsearchmode,c+="&"+this.searchvar+"="+this.convert(a),c+="&scps="+this.scps,c},makeAdvancedSearch:function(a){var b=this.url+this.path+"/action/search.do?frbg=&ct=search&indx=1";for(var c=0;c<a.length;c++)b+="&"+this["advsearchvar"+(c+1)]+"="+this.convert(a[c].searchType),this.convert(a[c].searchType)=="t"?b+="&"+this["advsearchmode"+(c+1)]+"="+this.titlesearchmode:b+="&"+this["advsearchmode"+(c+1)]+"="+this.defaultsearchmode,b+="&vl(freeText"+c+")="+encodeURIComponent(a[c].searchTerms);return b+="&"+this.langvar+"="+this.defaultlanguage,b+="&mode=Advanced",b+="&vid="+this.vid,b+="&scp.scps="+this.scps,b+="&srt="+this.defaultsort,b+="&tab=default_tab",b+="&dum=true",b+="&"+this.advmaterialvar+"="+this.defaultmaterial,b+="&fn=search",b+="&"+this.datevar+"="+this.defaultdaterange,b}}),libx.openurl={factory:{}},libx.openurl.factory.webbridge=libx.openurl.factory.generic=libx.core.Class.create({include:[libx.catalog.CatalogUtils],makeOpenURLFromFields:function(a){var b="__char_set=utf8";this.haveTitleOrIssn=!1,this.version=="0.1"?(this.genreprefix="genre=",this.doiprefix="id=doi:",this.pmidprefix="id=pmid:",this.titleprefix="title=",this.jtitleprefix="title=",this.btitleprefix="title=",this.atitleprefix="atitle=",this.isbnprefix="isbn=",this.issnprefix="issn=",this.aulastprefix="aulast=",this.aufirstprefix="aufirst="):(this.genreprefix="rft.genre=",this.doiprefix="rft_id=info:doi/",this.pmidprefix="rft_id=info:pmid/",this.jtitleprefix="rft.jtitle=",this.btitleprefix="rft.btitle=",this.atitleprefix="rft.atitle=",this.isbnprefix="rft.isbn=",this.issnprefix="rft.issn=",this.aulastprefix="rft.aulast=",this.aufirstprefix="rft.aufirst=");for(var c=0;c<a.length;c++){this.adjustISNSearchType(a[c]),b+="&";switch(a[c].searchType){case"doi":b+=this.doiprefix+a[c].searchTerms;break;case"pmid":b+=this.pmidprefix+a[c].searchTerms;break;case"jt":case"t":a[c].searchType=="jt"?b+=this.jtitleprefix:b+=this.btitleprefix,b+=encodeURIComponent(a[c].searchTerms.replace(/\s+/," ")),this.haveTitleOrIssn=!0;break;case"at":b+=this.atitleprefix+encodeURIComponent(a[c].searchTerms.replace(/\s+/," "));break;case"i":var d=libx.utils.stdnumsupport.isISBN(a[c].searchTerms,this.downconvertisbn13);if(d==null)return alert(libx.locale.defaultStringBundle.getProperty("openurlissn.alert",a[c].searchTerms)),null;b+=this.isbnprefix+d,this.haveTitleOrIssn=!0;break;case"is":var d=libx.utils.stdnumsupport.isISSN(a[c].searchTerms);if(d==null)return alert(libx.locale.defaultStringBundle.getProperty("openurlissn.alert",a[c].searchTerms)),null;b+=this.issnprefix+d,this.haveTitleOrIssn=!0;break;case"a":var e=a[c].searchTerms,f=e.match(/,/);e=e.replace(/[^A-Za-z0-9_\-\s]/g," ");var g=e.split(/\s+/);g.length==1?b+=this.aulastprefix+encodeURIComponent(g[0]):f||g[g.length-1].match(/^[A-Z][A-Z]?$/i)?(b+=this.aulastprefix+encodeURIComponent(g[0]),b+=this.aufirstprefix+encodeURIComponent(g[1])):(b+=this.aulastprefix+encodeURIComponent(g[g.length-1]),b+=this.aufirstprefix+encodeURIComponent(g[0]));break;case"Y":return alert(libx.locale.defaultStringBundle.getProperty("openurlarticlekeyword.alert",this.name)),null}}return this.addSid(b)},addSid:function(a,b){b==null&&(b=this.version),b=="0.1"?this.sidprefix="sid=":this.sidprefix="rfr_id=info:sid/",a+="&"+this.sidprefix;var c=this.sid;this.pmidsid!=null&&a.match(/pmid/i)?c=this.pmidsid:this.xrefsid!=null&&a.match(/doi/i)&&(c=this.xrefsid);try{c=c.replace(/%hostname%/,libx.ui.getCurrentWindowContent().location.hostname)}catch(d){libx.log.write(d+": exception occurred attempting to replace %hostname%","openurl")}return a+=encodeURIComponent(c),a},makeOpenURLSearch:function(a){var b=this.makeOpenURLFromFields(a),c="unknown";if(b.indexOf(this.atitleprefix)!=-1||b.indexOf(this.doiprefix)!=-1||b.indexOf(this.pmidprefix)!=-1)c="article";else if(b.indexOf(this.isbnprefix)!=-1)c="book";else if(b.indexOf(this.issnprefix)!=-1||b.indexOf(this.jtitleprefix)!=-1)c="journal";if(this.version=="1.0")switch(c){case"book":b="url_ver=Z39.88-2004&rft_val_fmt=info:ofi/fmt:kev:mtx:book&"+b;break;default:b="url_ver=Z39.88-2004&rft_val_fmt=info:ofi/fmt:kev:mtx:journal&"+b}return this.url+"?"+b+"&"+this.genreprefix+c},makeOpenURLForISSN:function(a){return this.makeOpenURLSearch([{searchType:"is",searchTerms:a}])},makeOpenURLForDOI:function(a){return this.makeOpenURLSearch([{searchType:"doi",searchTerms:a}])},makeOpenURLForPMID:function(a){return this.makeOpenURLSearch([{searchType:"pmid",searchTerms:a}])},completeOpenURL:function(a,b){var c=this.url+"?"+a;return this.addSid(c,b)},options:"jt",search:function(a){return this.makeOpenURLSearch(a)},supportsSearchType:function(a){return(";"+this.options+";").match(";"+a+";")}}),libx.catalog.factory.sersol=libx.openurl.factory.sersol=libx.core.Class.create(libx.openurl.factory.generic,{options:"jt;i",makeOpenURLSearch:function(a){if(a.length==1){this.adjustISNSearchType(a[0]);var b=a[0].searchType;if(b=="jt")return this.url+"?V=1.0&S=T_W_A&C="+encodeURIComponent(a[0].searchTerms);if(b=="is")return this.url+"?V=1.0&S=I_M&C="+encodeURIComponent(a[0].searchTerms)}return this.parent(a)}}),libx.catalog.factory.sfx=libx.openurl.factory.sfx=libx.core.Class.create(libx.openurl.factory.generic,{makeOpenURLSearch:function(a){var b=this.parent(a);if(b==null)return null;for(var c=0;c<a.length;c++)switch(a[c].searchType){case"jt":b+="&sfx.title_search=contains";case"is":b+="&sfx.ignore_date_threshold=1"}return b}}),libx.openurl.factory.oclcgateway=libx.core.Class.create(libx.openurl.factory.generic,{url:"http://worldcatlibraries.org/registry/gateway",name:"OCLC Gateway",sid:"libx:oclcgateway",initialize:function(){var a=this,b={url:"http://www.worldcat.org/registry/lookup?IP=requestor",dataType:"xml",type:"GET",bypassCache:!0,complete:function(b){try{var c=b.getElementsByTagName("linkIcon");c.length>0&&(a.image=c[0].textContent)}catch(d){}}};libx.cache.defaultMemoryCache.get(b)}}),libx.proxy={factory:{}},libx.proxy.factory.ezproxy=libx.core.Class.create({canCheck:function(){return this.urlcheckpassword!=null},checkURL:function(a){var b=this.url.match(/(https?:\/\/[^\/]+)\/(.*)$/);if(!b){libx.log.write("internal failure parsing proxy url: "+this.url+"..."),a.onsuccess();return}var c=b[1]+"/proxy_url",d="xml="+encodeURIComponent('<?xml version="1.0"?><proxy_url_request password="'+this.urlcheckpassword+'"><urls>'+"<url>"+a.url+"</url>"+"</urls></proxy_url_request>"),e={url:c,dataType:"xml",type:"POST",data:d,bypassCache:!0,success:function(b){var c=libx.utils.xpath.findSingleXML(b,"/proxy_url_response/proxy_urls/url[1]");if(c!=null&&libx.utils.types.normalize(c.getAttribute("proxy"))){a.onsuccess();return}a.onfailure()}};libx.cache.defaultMemoryCache.get(e)},disableIfCheckFails:function(){return this.disableifcheckfails==1},rewriteURL:function(a){return this.url.replace(/%S/,a)}}),libx.proxy.factory.wam=libx.core.Class.create({canCheck:function(){return!1},rewriteURL:function(a){var b=this.url,c=a.match(/http:\/\/([^\/:]+)(:(\d+))?\/(.*)$/);if(c){var d=c[1],e=c[3];if(e===undefined||e==""||e==80)e=0;var f=c[4],g="http://"+e+"-"+d+"."+b+"/"+f;return g}return a}}),libx.utils.stdnumsupport.isDOI=function(a){var b=a.replace(/\s*doi:?\s*/i,""),c=b.match(/10\.\S+\/\S+/);return c?c[0]:null},function(){function a(a){var b=a.length,c=0;for(var d=0;d<b;d++)c+=(b+1-d)*a.charAt(d);return c=c%11==0?0:11-c%11,c==10?"X":c+""}function b(b,c,d){b=b.replace(/[#:\-\s\.]/g,"").replace(d,"");var e=b.match(c);if(e==null)return null;b=e[0];var f=b.length,g=a(b.substring(0,f-1)),h=b.charAt(f-1).replace(/x/i,"X");return g==h?b:null}function c(a,b,c){a=a.replace(/[#:\-\s\.]/g,"").replace(c,"");var d=a.match(b);if(d==null)return null;a=d[0];var e=a.length,f=0;for(var g=0;g<e-1;g++)f+=a.charAt(g)*(g%2==0?1:3);f=f%10==0?0:10-f%10;var h=parseInt(a.charAt(e-1));return f==h?a:null}libx.utils.stdnumsupport.isISBN=function(d,e){var f=c(d,/97[89]\d{10}/,/^ISBN/i);if(f){if(e){var g=f.substring(3,12);return g+a(g)}return f}return b(d,/\d{9}[\dX]/i,/^ISBN/i)},libx.utils.stdnumsupport.isISSN=function(a){var c=b(a,/\d{7}[\dX]/i,/^ISSN/i);return c?c.substring(0,4)+"-"+c.substring(4,8):c}}(),libx.utils.xpath={findSingleXML:function(a,b,c,d){var e,f;try{if(libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla)e=a.evaluate(b,c?c:a,function(a){return d[a]},XPathResult.FIRST_ORDERED_NODE_TYPE,null),f=e.singleNodeValue;else if(libx.cs.browser.msie){var g="";for(prefix in d)g+="xmlns:"+prefix+"='"+d[prefix]+"' ";g+="xmlns='http://www.w3.org/2005/Atom'";if(c){try{c.setProperty("SelectionLanguage","XPath"),c.setProperty("SelectionNamespaces",g)}catch(h){}f=c.selectSingleNode(b)}else a.setProperty("SelectionLanguage","XPath"),a.setProperty("SelectionNamespaces",g),f=a.selectSingleNode(b)}else libx.log.write("Error - Unknown Browser! Check for appropriate feature support for libx.utils.xpath.findSingleNode"),f=null}catch(i){libx.log.write("In findSingleXML: XPath expression "+b+" does not return a node: "+i.message+"\n Desc: "+i.description),f=null}return f},findNodesXML:function(a,b,c,d){var e,f,g;try{if(libx.cs.browser.safari||libx.cs.browser.opera||libx.cs.browser.chrome||libx.cs.browser.mozilla){e=a.evaluate(b,c?c:a,function(a){return d[a]},XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),g=new Array;while((f=e.iterateNext())!=null)g.push(f)}else if(libx.cs.browser.msie){var h="";for(prefix in d)h+="xmlns:"+prefix+"='"+d[prefix]+"' ";h+="xmlns='http://www.w3.org/2005/Atom'";if(c){try{c.setProperty("SelectionLanguage","XPath"),c.setProperty("SelectionNamespaces",h)}catch(i){}e=c.selectNodes(b)}else a.setProperty("SelectionLanguage","XPath"),a.setProperty("SelectionNamespaces",h),e=a.selectNodes(b);g=new Array;for(f=0;f<e.length;++f)g.push(e[f])}}catch(j){return libx.log.write("In findNodesXML: XPath expression "+b+" does not return a set of nodes: "+j.message+"\n Desc: "+j.description),null}return g}},libx.ui.jquery.autocomplete=function(a,b){function h(){f.html(""),f.css("display","none")}function j(){var a=g.offset(),b=a.top,c=a.left,d=g.height(),e=g.width();f.css("position","absolute"),f.css("left",c),f.css("top",b+d+6),f.css("width",e+2)}function k(b){return b==40||b==38?(b==38?d==0||d==-1?d=c-1:d--:d==c-1?d=0:d++,f.children().each(function(b){b==d?(g.val(a(this).text()),this.className="selected"):this.className="unselected"}),!0):(d=-1,!1)}function l(c){return c==13?(f.children().each(function(c){c==d&&(g.val(a(this).text()),b.select(f.children()[c].item),h())}),!0):!1}function m(d){if(!g.is(":visible"))return;var e=g.val();if(e==""){h();return}if(d!=e)return;a.getJSON(b.make_url(e),function(d){j();var e=c=d.length;if(e>0){f.empty();for(i=0;i<e;i++){var k=a('<div class="unselected" />');k.append(b.formatter(d[i])),k[0].item=d[i],f.append(k)}f.css("display","block");var l=a("div",f);l.mouseover(function(){this.className="selected"}),l.mouseout(function(){this.className="unselected"}),l.click(function(){g.val(a(this).text()),h(),b.select(a(this)[0].item)})}else h()})}var c=0,d=-1,e=500,f=a('<div class="results" />');a("body").append(f);var g=b.field;g.blur(function(){libx.utils.timer.setTimeout(h,200)}),g.keyup(function(a){var b=a.keyCode||window.event.keyCode,c=g.val();if(l(b))return;if(k(b))return;if(b==27){h();return}libx.utils.timer.setTimeout(function(){m(c)},e)})},libx.ui.jquery.dropdown=function(a,b){function j(){e.fadeOut(100)}function k(){var b=f.offset(),c=f.height(),d=f.width(),g=b.left,h=b.top;e.height("");var i=h+e.height()-a("body").height();i>0&&(h-=i),h<7&&(e.height(e.height()+h),h=7),e.css("position","absolute"),e.css("left",g),e.css("top",h),e.css("width",d),e.css("min-width","150px")}var c=0,d=-1,e=a('<div class="results" />');a("body").append(e);var f=b.field;for(var g=0;g<b.dropdown_items.length;g++){var h=a('<div class="unselected" />'),i=b.dropdown_items[g].text;h.text(i),function(a,c){h.click(function(){f.text(c),j(),b.select&&b.select(a,c)})}(b.dropdown_items[g].value,i),h.mouseover(function(){this.className="selected"}),h.mouseout(function(){this.className="unselected"}),e.append(h)}f.click(function(){k(),e.fadeIn(function(){a("body").one("click",function(){j()})})})},libx.ui.jquery.accordionmenu=function(a,b){var c=b.menu;return{setMenuItems:function(b,d,e,f){b.empty();var g=a('<a href="#">'+d+"</a>"),h=a("<ul/>");b.append(g).append(h),g.click(function(){h.is(":visible")?h.slideUp("normal"):(a("ul:visible",c).slideUp("normal"),h.slideDown("normal"))});for(var i=0;i<e.length;i++){var j=a('<li><a href="#">'+e[i].text+"</a></li>").appendTo(h);(function(a,b){j.click(function(){g.text(a),h.slideUp("normal"),f(b,a)})})(e[i].text,e[i].value)}h.hide()}}},function(){function c(){a==null&&(a=libx.utils.browserprefs.getIntPref("libx.magic.threshold1",50)/100),b==null&&(b=libx.utils.browserprefs.getIntPref("libx.magic.threshold2",60)/100)}var a=null,b=null;libx.ui.magicSearch=function(d){function e(a,b){if(libx.edition.options.scholarmissurl!=null&&typeof libx.edition.options.scholarmissurl=="string"){var c=libx.edition.options.scholarmissurl.replace(/%S/i,encodeURIComponent(b));libx.ui.openSearchWindow(c)}}function f(a,b){function e(a){return a.replace(/[:\.,\)]*$/,"").replace(/^[\(]*/,"")}var c=a.split(/\s+/),d=b.split(/\s+/);for(var f=0;f<c.length;f++)c[f]=e(c[f]);for(var f=0;f<d.length;f++)d[f]=e(d[f]);var g=0,h=0,i=new Object,j=0;for(var f in c)i[c[f]]==undefined&&(i[c[f]]=!0,g++,j++);var k=new Object;for(var f in d)i[d[f]]==undefined&&(i[d[f]]=!0,j++),k[d[f]]==undefined&&(k[d[f]]=!0,h++);var l=g+h-j;return l/Math.sqrt(g*h)}function g(a){return a=a.replace(/^\s+/,""),a=a.replace(/\s+$/,""),a=a.replace(/,+$/,""),a=a.replace(/\./g," "),a.toLowerCase()}c();var h=5;libx.log.write('Searching for: "'+d+'"',"Magic");var i=d;d=g(d);var j="http://scholar.google.com/scholar?hl=en&lr=";j+="&q=";var k=j+encodeURIComponent(d);if(libx.edition.openurl.primary==null)return libx.ui.openSearchWindow(k),null;var l=!1;for(var m=0;m<h;m++){libx.log.write("Attempt #"+m+": "+k,"Magic");var n={url:k,type:"GET",dataType:"text",async:!1,bypassCache:!0},o=libx.cache.defaultMemoryCache.get(n),p=o.responseText,q=p.match(/No pages were found containing <b>\"([^\"]*)\"<\/b>/);if(q){d=d.replace(q[1]," "),k=j+encodeURIComponent(d);continue}var r=p.match(/(<p class=g>[\s\S]*?)<\/div>/i);if(r){var s=r[1].split(/<p class=g>/),t=!1;for(var u=0;u<s.length;u++){if(s[u]=="")continue;var v=/href=\"(\S*?sid=google&amp;([^\"]*))\"/i,w=s[u].match(v);w!=null&&w[0].match(/refworks/)&&(w=s[u].replace(w[0],"").match(v));var x=function(a){var b=a.replace(/<.*?>/g,"").replace(/&nbsp;/g," ").replace(/^\s*/,"").replace(/\s*$/,"");return b=g(b),f(b,d)},y="",z=s[u].replace(/&hellip;/," ").match(/<span class=\"w\">([\s\S]*?)<\/span>/);z==null&&s[u].match(/\[CITATION\]/)&&(z=s[u].replace(/&hellip;/," ").match(/\[CITATION\]([\s\S]*?)<br>/));var A=null,B=0;z!=null&&(A=z[1].match(/<a href=\"([^\"]*)\"/i),A&&(A=A[1]),y+=z[1],B=x(z[1]),libx.log.write("CosineSimilarity w/ titleline="+B+' "'+z[1].replace(/<.*?>/g,"")+'"',"Magic"));var C=s[u].replace(/&hellip;/," ").match(/<span class=\"a\">([\s\S]*?)<\/span>/),D=0;C!=null&&(y+=" "+C[1],D=x(C[1]),libx.log.write("CosineSimilarity w/ authorline="+D+" "+C[1].replace(/<.*?>/g,""),"Magic"));if(y!=""){var E=x(y);libx.log.write("CosineSimilarity w/ title+authorline="+E,"Magic")}if(E>a||B+D>b){if(!w&&!A){libx.log.write("Above threshold, but found neither title nor OpenURL; title[1] was="+z[1],"Magic");continue}var F=A,G=!libx.edition.options.suppressscholardisplay;if(w){var H=decodeURIComponent(w[2]).replace(/^&/,"");H=H.replace(/%E2%80%99/ig,"'"),H=libx.utils.xml.decodeEntities(H),libx.edition.options.sendorigdatawithopenurl&&(H+="&origdata="+encodeURIComponent(d)),F=libx.edition.openurl.primary.completeOpenURL(H,"0.1"),G=!0,libx.log.write("OpenURL: "+F,"Magic")}else F=decodeURIComponent(F),libx.log.write("DirectURL: "+F,"Magic");G&&(libx.ui.openSearchWindow(F),t=!0);break}libx.log.write("rejected because below threshold, thresholds are "+a+" and "+b,"Magic")}u==s.length&&libx.log.write("I received "+s.length+" hits in Scholar, but no matches were found","Magic");if(!t&&!l){l=!0,d='"'+d+'"',k=j+encodeURIComponent(d);continue}return t||e(k,i),libx.edition.options.suppressscholardisplay?null:(t?libx.ui.openSearchWindow(k,"libx.newtab"):libx.ui.openSearchWindow(j+encodeURIComponent(i)),null)}libx.log.write("couldn't find result <div> in this scholar result: "+p,"Magic");var I=p.match(/Did you mean:\s+<\/font><a\s+href=(\/scholar\S*)\s/i);if(I){k="http://scholar.google.com"+I[1];continue}return e(k,i),libx.edition.options.suppressscholardisplay||libx.ui.openSearchWindow(j+encodeURIComponent(i)),null}return null}}(),libx.ui.openSearchWindow=function(a,b){typeof a!="string"&&(a=libx.utils.getExtensionURL("popup/post.html")+"?"+libx.utils.json.stringify({url:a[0],data:a[1]}));var c=libx.prefs.browser&&libx.prefs.browser.displaypref&&libx.prefs.browser.displaypref._value;switch(b?b:c){case"newwindow":libx.ui.windows.create({url:a});break;case"sametab":libx.ui.tabs.getSelected(function(b){libx.ui.tabs.update(b.id,{url:a})});break;case"newtabswitch":libx.ui.tabs.create({url:a,selected:!0});break;case"newtab":default:libx.ui.tabs.create({url:a,selected:!1})}},libx.ui.ContextMenu=function(){var a=libx.core.Class.create({initialize:function(){},visible:!0,title:"Context Menu Item",contexts:["all"],prefkey:"prefkey",onclick:function(a){},onshowing:function(a){},match:function(){return!0}});return a.factory={},a.factory.catalog=libx.core.Class.create(a,{type:"catalog",matchFuncs:{i:function(a){return libx.utils.stdnumsupport.isISBN(a.selectionText
)},is:function(a){return libx.utils.stdnumsupport.isISSN(a.selectionText)},doi:function(a){return libx.utils.stdnumsupport.isDOI(a.selectionText)},pmid:function(a){var b=a.selectionText.match(/(PMID|PubMed\s*ID)[^\d]*(\d+)/i);return b!=null?b[2]:null}},initialize:function(a,b){this.searcher=libx.edition.catalogs.getByName(a),this.searchType=b,this.title=libx.locale.defaultStringBundle.getProperty("label_search_catalog_type_str",a,libx.edition.searchoptions[b],'"%s"'),this.prefkey=a+"."+b,this.visible=libx.prefs.contextmenu[a][b]._value,this.match=function(a){return b in a?a[b]:function(b){var c=!0;for(var d in a)c=c&&!a[d](b);return c}}(this.matchFuncs)},contexts:["selection"],onclick:function(a){libx.ui.openSearchWindow(this.searcher.search([{searchType:this.searchType,searchTerms:a.selectionText}]))}}),a.factory.openurl=libx.core.Class.create(a.factory.catalog,{type:"openurl",initialize:function(a){this.searcher=libx.edition.openurl.getByName(a),this.title=libx.locale.defaultStringBundle.getProperty("label_search_catalog_str",a,'"%s"'),this.prefkey=a+".enabled",this.visible=libx.prefs.contextmenu[a].enabled._value},contexts:["selection"],onclick:function(a){var b=["i","is","doi","pmid"];for(var c=0;c<b.length;c++){var d=this.matchFuncs[b[c]](a);if(d){libx.ui.openSearchWindow(this.searcher.makeOpenURLSearch([{searchType:b[c],searchTerms:d}]));return}}libx.ui.openSearchWindow(this.searcher.makeOpenURLSearch([{searchType:"jt",searchTerms:a.selectionText}]))}}),a.factory.proxy=libx.core.Class.create(a,{type:"proxy",searchType:"enabled",initialize:function(a){this.parent(a),this.proxy=libx.edition.proxy.getByName(a),this.title=libx.locale.defaultStringBundle.getProperty("proxy_reload_label",this.proxy.name),this.prefkey=a+".enabled",this.visible=libx.prefs.contextmenu[a].enabled._value},onclick:function(a){libx.ui.openSearchWindow(this.proxy.rewriteURL(a.pageUrl),"sametab")},contexts:["page"]}),a.factory.proxy_link=libx.core.Class.create(a.factory.proxy,{type:"proxy",initialize:function(a){this.parent(a),this.title=libx.locale.defaultStringBundle.getProperty("proxy_follow_label",this.proxy.name)},contexts:["link"],onclick:function(a){libx.ui.openSearchWindow(this.proxy.rewriteURL(a.linkUrl))}}),a.factory.scholar=libx.core.Class.create(a,{initialize:function(){this.parent(),this.title=libx.locale.defaultStringBundle.getProperty("label_search_scholar",'"%s"'),this.prefkey="Google Scholar.magicsearch"},type:"scholar",contexts:["selection"],onclick:function(a){libx.ui.magicSearch(a.selectionText)}}),libx.core.Class.create({initialize:function(){this.items=[];for(var b=0;b<libx.edition.catalogs.length;b++){var c=libx.edition.catalogs[b],d=c.options.split(";");for(var e=0;e<d.length;e++)this.addItem(new a.factory.catalog(c.name,d[e]));libx.prefs.contextmenu[c.name].xisbn&&this.addItem(new a.factory.catalog(c.name,"xisbn"))}for(var b=0;b<libx.edition.openurl.length;b++){var f=libx.edition.openurl[b];this.addItem(new a.factory.openurl(f.name))}for(var b=0;b<libx.edition.proxy.length;b++){var g=libx.edition.proxy[b];this.addItem(new a.factory.proxy(g.name)),this.addItem(new a.factory.proxy_link(g.name))}this.addItem(new a.factory.scholar)},registerItem:function(a,b){this.items.push({id:a,item:b})},lookupItemId:function(a){for(var b=0;b<this.items.length;b++)if(this.items[b].id==a)return this.items[b].item},addItem:libx.core.AbstractFunction("libx.ui.ContextMenu.addItem"),removeItem:libx.core.AbstractFunction("libx.ui.ContextMenu.removeItem"),update:libx.core.AbstractFunction("libx.ui.ContextMenu.update"),ContextMenuItem:a})}(),libx.events.addListener("EditionConfigurationLoaded",{onEditionConfigurationLoaded:function(){libx.ui.contextMenu=new libx.ui.ContextMenu}}),libx.ui.setIcon=function(a){},libx.ui.tabs={create:function(a){window.open(a.url,"_newtab")},update:function(a,b,c){throw"libx.ui.tabs.update not implemented in client-side"},getSelected:function(a){throw"libx.ui.tabs.getSelected not implemented in client-side"},sendRequest:function(a,b,c){throw"libx.ui.tabs.sendRequest not implemented in client-side"}},libx.ui.windows={create:function(a){window.open(a.url)}},function(){function a(a){return a?["http://*/*","https://*/*"]:["http://do.not.show.this.item/"]}libx.ui.ContextMenu=libx.core.Class.create(libx.ui.ContextMenu,{initialize:function(){this.parent()},addItem:function(a){},update:function(a,b){}})}(),function(){function h(a,b){return b.match(/^[a-z]+:/)?b:b.match(/^\/.*/)?a.match(/^[a-z]+:\/\/[^\/]+\//)+b.replace(/^\//,""):a.match(/^.*\//)+b}function i(f,i,j,k){function m(a,k,m){var n=libx.utils.xpath.findSingleXML(a,"./libx2:*",m,b),o=libx.utils.xpath.findSingleXML(a,"./atom:title/text()",m,b);o=o!=null?o.nodeValue:"atom:title is missing";var p=libx.utils.xpath.findSingleXML(a,"./atom:content/text()",m,b);p=p!=null?p.nodeValue:"atom:content is missing";var q=libx.utils.xpath.findSingleXML(a,"./atom:id/text()",m,b);q=q!=null?q.nodeValue:"atom:id is missing";if(n==null){libx.log.write(k+": entry "+q+" does not contain any libx2:* node"),f.error&&f.error("Entry not found",l,j);return}var r={baseURL:k,id:q,title:o,type:n.localName||n.nodeName.replace("libx:",""),description:p,entries:[]},s;for(infoItem in g)if(g[infoItem].length==0)s=libx.utils.xpath.findSingleXML(a,"./atom:"+infoItem+"/text()",m,b),s=s!=null?s.nodeValue:"atom:"+infoItem+" is missing",r[infoItem]=s;else{var t=g[infoItem];r[infoItem]={};for(var u=0;u<t.length;++u)s=libx.utils.xpath.findSingleXML(a,"./atom:"+infoItem+"/atom:"+t[u]+"/text()",m,b),s=s!=null?s.nodeValue:"atom:"+infoItem+"//"+t[u]+" is missing",r[infoItem][t[u]]=s}var v=c;for(var w=0;w<v.length;w++){var x=v[w],y=libx.utils.xpath.findNodesXML(a,"./libx2:"+x,n,b);x in d&&(r[x]=new Array);if(y==null)continue;if(x in d)for(var z=0;z<y.length;z++)r[x].push(String(y[z].firstChild.nodeValue));else y.length>0&&(r[x]=String(y[0].firstChild.nodeValue)),y.length>1&&libx.log.write("module: '"+p+"' additional <"+x+"> ignored")}var A=libx.utils.xpath.findNodesXML(a,"./libx2:preferences/*",n,b);A!=null&&A.length&&libx.prefs[i]&&A.forEach(function(a){libx.preferences.loadXML(a,{base:"libx.prefs."+i})});for(var w=0;w<e.length;w++){var B=e[w];for(var z=0;z<r[B].length;z++)try{var C=r[B][z].match(/\/(.*)\/(.*)/);r[B][z]={regex:C[1],flag:C[2]}}catch(D){libx.log.write("invalid regular expression: "+r[B][z]),r[B].splice(z--,1)}}var E=libx.utils.xpath.findNodesXML(a,"./libx2:entry",n,b);for(var w=0;E!=null&&w<E.length;w++){var F={url:h(k,String(E[w].getAttribute("src")))},G=libx.utils.xpath.findNodesXML(a,"./libx2:args/libx2:arg",E[w],b);if(G!=null){F.args={};for(var z=0;z<G.length;z++)F.args[G[z].getAttribute("name")]={value:G[z].getAttribute("value"),type:G[z].getAttribute("type")}}r.entries.push(F)}var H=libx.utils.xpath.findNodesXML(a,"./libx2:params/libx2:param",n,b);r.params={};for(var w=0;H!=null&&w<H.length;w++)r.params[H[w].getAttribute("name")]={type:H[w].getAttribute("type"),desc:H[w].textContent};var I=libx.utils.xpath.findNodesXML(a,"./libx2:locale",n,b);r.locales={};if(I!=null)for(var w=0;w<I.length;w++){var J=I[w].getAttribute("language");r.locales[J]=I[w].textContent,I[w].getAttribute("default")=="true"&&(r.defaultLocale=J)}var K="on"+String(n.localName||n.nodeName.replace("libx:",""));f[K]&&f[K](r,l,j);var H=libx.utils.xpath.findNodesXML(a,"./libx2:params/libx2:param",n,b)}if(f.beforeentry)var l=f.beforeentry(i);var n=i.split(/\//),o=String(i.match(/.*\//)),p=i.replace(/.*\//,"");a&&libx.log.write("url= "+i+" path="+o+" base="+p);var q=!1,r={dataType:"xml",url:o,validator:libx.cache.validators.feed,cacheOnly:k&&!0,success:function(a,c){q=!0;var d="//atom:entry[atom:id/text() = '"+i+"']",e=libx.utils.xpath.findSingleXML(a,d,a,b);if(e!=null)m(a,o,e);else{q=!1;var g={dataType:"xml",url:i,validator:libx.cache.validators.feed,cacheOnly:r.cacheOnly,success:function(a,b){q=!0,m(a,o,a.documentElement)},error:function(a){libx.log.write("atomparser.js: Error status "+a+" when walking "+i),f.error&&f.error(a,l,j)},complete:function(){g.cacheOnly&&!q&&(k.markReady(),g.cacheOnly=!1,libx.cache.defaultObjectCache.get(g))}};libx.cache.defaultObjectCache.get(g)}},complete:function(){r.cacheOnly&&!q&&(k.markReady(),r.cacheOnly=!1,libx.cache.defaultObjectCache.get(r))},error:function(a){libx.log.write("atomparser.js: Error status "+a+" when walking "+o),f.error&&f.error(a,l,j)}};libx.cache.defaultObjectCache.get(r)}var a=!1,b={atom:"http://www.w3.org/2005/Atom",libx2:"http://libx.org/xml/libx2"},c=["include","exclude","require","guardedby","body","regexptexttransformer","override"],d={include:1,exclude:1,guardedby:1,require:1,regexptexttransformer:1},e=["include","exclude","regexptexttransformer"],f=["name","uri","email"],g={updated:[],author:f};libx.libapp.nsResolver=b,libx.libapp.PackageVisitor=libx.core.Class.create({onpackage:function(a,b){for(var c=0;c<a.entries.length;c++)i(this,a.entries[c].url,b)},onlibapp:function(a,b){for(var c=0;c<a.entries.length;c++)i(this,a.entries[c].url,b)},onmodule:function(a){},beforeentry:function(a){}}),libx.libapp.PackageWalker=libx.core.Class.create({initialize:function(a){this.rootPackage=a},walk:function(a,b){i(a,this.rootPackage,null,b)}})}();try{libx.initialize(!0)}catch(er){console.log("Error in libx.initialize(): "+er)}libx.config.EditionConfigurationReader.defaultpkgURL="http://libx.org/libx2/libapps/libxcore";